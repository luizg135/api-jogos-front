<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Perfil Gamer</title>

    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined:opsz,wght,FILL,GRAD@20..48,100..700,0..1,-50..200" />
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        :root {
            --rank-bronze: #CD7F32; --rank-prata: #C0C0C0; --rank-ouro: #FFD700;
            --rank-platina: #ADD8E6; --rank-diamante: #00FFFF; --rank-mestre: #9370db;
        }
        body.dark-mode {
            --bg-color: #0d1117; --surface-color: #161b22; --primary-text: #e6edf3;
            --secondary-text: #7d8590; --border-color: #30363d; --accent-purple: #9370db;
            --accent-green: #238636;
        }
        body.light-mode {
            --bg-color: #f6f8fa; --surface-color: #ffffff; --primary-text: #24292f;
            --secondary-text: #57606a; --border-color: #d0d7de; --accent-purple: #8957e5;
            --accent-green: #2da44e;
        }
        *, *::before, *::after { box-sizing: border-box; }
        body {
            font-family: 'Inter', sans-serif; background-color: var(--bg-color);
            color: var(--primary-text); margin: 0; display: flex;
            height: 100vh; overflow: hidden; transition: background-color 0.3s ease, color 0.3s ease;
        }
        .sidebar {
            width: 80px; height: 100%; background-color: #010409;
            border-right: 1px solid var(--border-color); padding: 24px 0;
            display: flex; flex-direction: column; align-items: center;
            flex-shrink: 0; z-index: 10;
        }
        .sidebar-logo { font-size: 36px; color: var(--accent-purple); }
        .sidebar-nav { display: flex; flex-direction: column; align-items: center; gap: 16px; margin-top: 40px; }
        .nav-button {
            background-color: transparent; border: none; color: var(--secondary-text); cursor: pointer;
            padding: 12px; border-radius: 10px; display: flex; align-items: center; justify-content: center;
            width: 52px; height: 52px; transition: all 0.2s ease;
        }
        .nav-button:hover { background-color: var(--surface-color); color: var(--primary-text); }
        .nav-button.active { background-color: var(--accent-purple); color: white; }
        .nav-button .material-symbols-outlined { font-size: 28px; }
        .sidebar-footer { margin-top: auto; display: flex; flex-direction: column; gap: 16px; }
        .main-content { flex-grow: 1; padding: clamp(16px, 4vw, 48px); overflow-y: auto; height: 100%; }
        .page { display: none; }
        .page.active { display: block; animation: fadeIn 0.5s; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        .profile-header {
            background-color: var(--surface-color); border: 1px solid var(--border-color); padding: 32px;
            border-radius: 16px; margin-bottom: 32px; position: relative; overflow: hidden;
            transition: background-color 0.3s ease, border-color 0.3s ease;
        }
        .profile-main { position: relative; z-index: 1; display: flex; align-items: center; gap: 24px; flex-wrap: wrap; }
        .profile-avatar { width: 64px; height: 64px; border-radius: 50%; border: 2px solid var(--border-color); object-fit: cover; }
        .profile-info h1 { font-size: 28px; font-weight: 700; margin: 0; }
        .profile-info h1.rank-Mestre { color: var(--rank-mestre); text-shadow: 0 0 12px var(--rank-mestre); }
        .profile-info h1.rank-Diamante { color: var(--rank-diamante); text-shadow: 0 0 12px var(--rank-diamante); }
        .profile-info h1.rank-Platina { color: var(--rank-platina); text-shadow: 0 0 12px var(--rank-platina); }
        .profile-info h1.rank-Ouro { color: var(--rank-ouro); text-shadow: 0 0 12px var(--rank-ouro); }
        .profile-info h1.rank-Prata { color: var(--rank-prata); }
        .profile-info h1.rank-Bronze { color: var(--rank-bronze); }
        .profile-info p { font-size: 16px; color: var(--secondary-text); margin: 4px 0 0 0; }
        .profile-level { margin-left: auto; text-align: right; min-width: 250px; }
        .level-text { font-size: 24px; font-weight: 700; }
        .exp-bar-container { width: 100%; height: 8px; background-color: var(--border-color); border-radius: 4px; overflow: hidden; margin-top: 8px; }
        .exp-bar-progress { height: 100%; border-radius: 4px; width: 0%; transition: width 0.5s ease; }
        .exp-bar-progress.rank-Mestre { background-color: var(--rank-mestre); box-shadow: 0 0 10px var(--rank-mestre); }
        .exp-bar-progress.rank-Diamante { background-color: var(--rank-diamante); box-shadow: 0 0 10px var(--rank-diamante); }
        .exp-bar-progress.rank-Platina { background-color: var(--rank-platina); box-shadow: 0 0 10px var(--rank-platina); }
        .exp-bar-progress.rank-Ouro { background-color: var(--rank-ouro); box-shadow: 0 0 10px var(--rank-ouro); }
        .exp-bar-progress.rank-Prata { background-color: var(--rank-prata); }
        .exp-bar-progress.rank-Bronze { background-color: var(--rank-bronze); }
        .exp-text { font-size: 12px; color: var(--secondary-text); margin-top: 4px; }
        .summary-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 16px; }
        .card {
            background-color: var(--surface-color); padding: 20px; border-radius: 12px;
            border: 1px solid var(--border-color); border-bottom: 3px solid transparent;
            transition: all 0.2s ease;
        }
        .card:hover { transform: translateY(-4px); box-shadow: 0 8px 24px rgba(0, 0, 0, 0.2); }
        .table-container { background-color: var(--surface-color); border: 1px solid var(--border-color); border-radius: 12px; overflow: hidden; }
        .games-table { width: 100%; border-collapse: collapse; }
        .games-table th, .games-table td { padding: 16px; text-align: left; border-bottom: 1px solid var(--border-color); }
        .modal-overlay {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background-color: rgba(0, 0, 0, 0.7); display: flex; align-items: center; justify-content: center;
            z-index: 1000; visibility: hidden; opacity: 0; transition: visibility 0.3s, opacity 0.3s;
        }
        .modal-overlay.active { visibility: visible; opacity: 1; }
        .modal-content {
            background-color: var(--surface-color); padding: 32px; border-radius: 16px;
            max-width: 450px; width: 90%; position: relative; box-shadow: 0 10px 30px rgba(0, 0, 0, 0.5);
            transform: scale(0.95); transition: transform 0.3s ease-out;
        }
        .modal-overlay.active .modal-content { transform: scale(1); }
        .close-button { position: absolute; top: 16px; right: 24px; font-size: 28px; color: var(--secondary-text); cursor: pointer; }
        .form-group { margin-bottom: 16px; }
        .modal-content form input, .modal-content form select, .modal-content form button { width: 100%; padding: 10px 12px; border-radius: 8px; font-size: 14px; }
        .modal-content form button { background-color: var(--accent-purple); color: white; border: none; cursor: pointer; }
        .action-buttons { display: flex; gap: 8px; }
        .action-button { background: transparent; border: none; padding: 4px; color: var(--secondary-text); cursor: pointer; }
    </style>
</head>
<body class="dark-mode">

    <nav class="sidebar">
        </nav>

    <main class="main-content">
        </main>
    
    <div id="addGameModal" class="modal-overlay">
        <div class="modal-content">
            <span class="close-button" onclick="closeGameModal()">&times;</span>
            <h2 id="gameModalTitle">Adicionar Novo Jogo</h2>
            <form id="addGameForm">
                <input type="hidden" id="editMode" value="">
                
                <div class="form-group">
                    <label for="gameName">Nome do Jogo</label>
                    <input type="text" id="gameName" required>
                </div>
                <div class="form-group">
                    <label for="gamePlatform">Plataforma</label>
                    <input type="text" id="gamePlatform" placeholder="Ex: PC, PS5">
                </div>
                <div class="form-group">
                    <label for="gameStatus">Status</label>
                    <select id="gameStatus">
                        <option value="Na Fila">Na Fila</option>
                        <option value="Jogando">Jogando</option>
                        <option value="Finalizado">Finalizado</option>
                        <option value="Platinado">Platinado</option>
                        <option value="Abandonado">Abandonado</option>
                    </select>
                </div>
                <div class="form-group">
                    <label for="gameRating">Nota</label>
                    <input type="number" id="gameRating" step="0.1" min="0" max="10">
                </div>
                <div class="form-group">
                    <label for="gameHours">Horas de Jogo</label>
                    <input type="number" id="gameHours" min="0">
                </div>
                <div class="form-group">
                    <label for="gameTermino">Data de Conclusão</label>
                    <input type="date" id="gameTermino">
                </div>
                <div class="form-group">
                    <label for="gameLink">Link da Capa (URL)</label>
                    <input type="url" id="gameLink" placeholder="URL da imagem">
                </div>
                <div class="form-group">
                    <label for="gameStyle">Estilo (separado por vírgula)</label>
                    <input type="text" id="gameStyle" placeholder="Ex: RPG, Aventura">
                </div>
                <div class="form-group">
                    <label for="gamePrice">Preço (R$)</label>
                    <input type="text" inputmode="decimal" id="gamePrice" placeholder="Ex: 149,90">
                </div>
                <div class="form-group">
                    <label for="gameConquistas">Conquistas Obtidas</label>
                    <input type="number" id="gameConquistas" min="0">
                </div>
                <button type="submit" id="gameModalSubmitBtn">Salvar Jogo</button>
            </form>
        </div>
    </div>
    
    <script>
        const API_URL = 'https://api-jogos-nrma.onrender.com/api';
        
        const chartColors = {
            purple: 'rgba(147, 112, 219, 0.8)', grey: 'rgba(125, 133, 144, 0.5)',
            lightBlue: 'rgba(56, 139, 253, 0.8)', cyan: 'rgba(0, 255, 255, 0.8)',
        };

        let fullData = { estatisticas: {}, biblioteca: [], desejos: [] };
        let createdCharts = {};
        
        const token = localStorage.getItem('jwt_token');
        if (!token) { window.location.href = 'login.html'; }

        async function fetchGameData() { /* ... permanece a mesma ... */ }
        function renderAllPages() { /* ... permanece a mesma ... */ }
        function openPage(evt, pageName) { /* ... permanece a mesma ... */ }

        function renderGamerCard(stats) {
            const rankClass = `rank-${stats.rank_gamer}`;
            const gamerName = document.getElementById('gamerName');
            const expBar = document.getElementById('expBar');
            
            document.getElementById('levelDisplay').textContent = `${stats.rank_gamer} (Nível ${stats.nivel_gamer})`;
            // NOVO: Exibição correta da barra de progresso de EXP
            document.getElementById('expText').textContent = `${stats.exp_nivel_atual.toLocaleString('pt-BR')} / ${stats.exp_para_proximo_nivel.toLocaleString('pt-BR')} EXP`;
            
            // Timeout para garantir que a transição da barra de progresso seja visível
            setTimeout(() => {
                expBar.style.width = `${(stats.exp_nivel_atual / stats.exp_para_proximo_nivel) * 100}%`;
            }, 100);
            
            gamerName.className = '';
            expBar.className = 'exp-bar-progress';
            
            gamerName.classList.add(rankClass);
            expBar.classList.add(rankClass);
        }

        function renderSummaryCards(stats, containerId) { /* ... permanece a mesma ... */ }
        function renderRecentPlatinums(library) { /* ... permanece a mesma ... */ }
        function renderGameTable(games) { /* ... permanece a mesma ... */ }
        function renderWishlist(wishlist) { /* ... permanece a mesma ... */ }
        function destroyCharts() { /* ... permanece a mesma ... */ }
        function renderAllCharts(games) { /* ... permanece a mesma ... */ }
        function populateFilters(suffix) { /* ... permanece a mesma ... */ }
        function applyFilters(suffix) { /* ... permanece a mesma ... */ }

        // NOVO: Lógica de abrir/fechar modal simplificada
        function openGameModalForAdd() {
            document.getElementById('addGameForm').reset();
            document.getElementById('editMode').value = ''; // Garante que o modo de adição está ativo
            document.getElementById('gameModalTitle').textContent = 'Adicionar Novo Jogo';
            document.getElementById('gameModalSubmitBtn').textContent = 'Salvar Jogo';
            document.getElementById('addGameModal').classList.add('active');
        }
        
        function openGameModalForEdit(gameName) {
            const gameToEdit = fullData.biblioteca.find(g => g.Nome === gameName);
            if (!gameToEdit) { alert("Jogo não encontrado."); return; }
            
            document.getElementById('addGameForm').reset();
            document.getElementById('editMode').value = gameName; // Ativa o modo de edição com o nome original
            
            document.getElementById('gameModalTitle').textContent = `Editar ${gameToEdit.Nome}`;
            document.getElementById('gameModalSubmitBtn').textContent = 'Atualizar Jogo';
            
            document.getElementById('gameName').value = gameToEdit.Nome;
            document.getElementById('gamePlatform').value = gameToEdit.Plataforma || '';
            document.getElementById('gameStatus').value = gameToEdit.Status || 'Na Fila';
            document.getElementById('gameRating').value = gameToEdit.Nota || '';
            document.getElementById('gameHours').value = gameToEdit['Tempo de Jogo'] || '';
            document.getElementById('gameLink').value = gameToEdit.Link || '';
            document.getElementById('gameStyle').value = gameToEdit.Estilo || '';
            document.getElementById('gamePrice').value = String(gameToEdit.Preço || '').replace('.', ',');
            document.getElementById('gameConquistas').value = gameToEdit['Conquistas Obtidas'] || '';
            document.getElementById('gameTermino').value = gameToEdit['Terminado em'] || '';

            document.getElementById('addGameModal').classList.add('active');
        }

        function closeGameModal() {
            document.getElementById('addGameModal').classList.remove('active');
        }
        
        // NOVO: Um único handler para o formulário que decide entre Adicionar e Editar
        async function handleGameFormSubmit(event) {
            event.preventDefault();
            
            const editModeValue = document.getElementById('editMode').value;
            const isEditing = editModeValue !== '';

            const priceValue = document.getElementById('gamePrice').value.replace(',', '.');
            const gameData = {
                Nome: document.getElementById('gameName').value,
                Plataforma: document.getElementById('gamePlatform').value,
                Status: document.getElementById('gameStatus').value,
                Nota: parseFloat(document.getElementById('gameRating').value) || null,
                "Tempo de Jogo": parseInt(document.getElementById('gameHours').value) || 0,
                Link: document.getElementById('gameLink').value,
                Estilo: document.getElementById('gameStyle').value,
                "Platinado?": document.getElementById('gameStatus').value === 'Platinado' ? 'Sim' : 'Não',
                Preço: parseFloat(priceValue) || 0,
                "Conquistas Obtidas": parseInt(document.getElementById('gameConquistas').value) || 0,
                "Terminado em": document.getElementById('gameTermino').value || ''
            };
            
            let url = `${API_URL}/games/add`;
            let method = 'POST';
            let body = { list_type: 'games', item_data: gameData };
            
            if (isEditing) {
                url = `${API_URL}/games/edit`;
                method = 'PUT';
                body = { list_type: 'games', item_name: editModeValue, updated_data: gameData };
            }

            try {
                const response = await fetch(url, {
                    method: method,
                    headers: { 'Content-Type': 'application/json', 'Authorization': `Bearer ${token}` },
                    body: JSON.stringify(body)
                });

                if (response.ok) {
                    alert(`Jogo ${isEditing ? 'atualizado' : 'adicionado'} com sucesso!`);
                    closeGameModal();
                    fetchGameData();
                } else {
                    const error = await response.json();
                    alert(`Erro ao ${isEditing ? 'atualizar' : 'adicionar'} jogo: ${error.message}`);
                }
            } catch (err) {
                 alert(`Erro de conexão ao tentar ${isEditing ? 'atualizar' : 'adicionar'} o jogo.`);
            }
        }

        // As funções de Wishlist permanecem as mesmas
        function openWishModal() { /* ... */ }
        function closeWishModal() { /* ... */ }
        async function handleNewWishlistItemSubmission(event) { /* ... */ }
        async function editWish(wishName) { /* ... */ }
        async function deleteWish(wishName) { /* ... */ }

        async function deleteGame(gameName) { /* ... permanece a mesma ... */ }

        document.addEventListener('DOMContentLoaded', () => {
            fetchGameData();

            // Função auxiliar para configurar listeners de forma segura
            const setupListener = (id, event, handler) => {
                const element = document.getElementById(id);
                if (element) {
                    element.addEventListener(event, handler);
                } else {
                    // Se o elemento não for encontrado, um erro será exibido no console
                    // em vez de quebrar a aplicação.
                    console.error(`Erro crítico: Elemento com o ID '${id}' não foi encontrado no HTML.`);
                }
            };

            // Configuração de todos os listeners usando a nova função
            setupListener('addGameForm', 'submit', handleGameFormSubmit);
            setupListener('addGameBtn', 'click', openGameModalForAdd);
            setupListener('addWishBtn', 'click', openWishModal);
            setupListener('addWishForm', 'submit', handleNewWishlistItemSubmission);
            
            setupListener('theme-toggle', 'click', () => {
                const body = document.body;
                const icon = document.querySelector('#theme-toggle .material-symbols-outlined');
                body.classList.toggle('light-mode');
                body.classList.toggle('dark-mode');
                icon.textContent = body.classList.contains('light-mode') ? 'dark_mode' : 'light_mode';
            });
            
            setupListener('logoutBtn', 'click', () => {
                localStorage.removeItem('jwt_token');
                window.location.href = 'login.html';
            });

            // Configuração dos listeners de filtro (eles já eram seguros, mas padronizamos)
            const setupFilterListeners = (suffix) => {
                ['nameFilter', 'statusFilter', 'styleFilter', 'yearFilter'].forEach(id => {
                    setupListener(id + suffix, 'input', () => applyFilters(suffix));
                });
                const clearBtn = document.getElementById('clearFiltersBtn' + suffix);
                if (clearBtn) {
                    clearBtn.addEventListener('click', () => {
                        ['nameFilter', 'statusFilter', 'styleFilter', 'yearFilter'].forEach(id => {
                            const el = document.getElementById(id + suffix);
                            if (el) el.value = el.tagName === 'SELECT' ? 'all' : '';
                        });
                        applyFilters(suffix);
                    });
                }
            };
            
            setupFilterListeners('-graficos');
            setupFilterListeners('-biblioteca');
        });

        // O restante das suas funções JS (editGame, deleteGame, etc.) permanecem as mesmas
        function editGame(gameName) {
            openGameModalForEdit(gameName);
        }
</body>
</html>

