<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Savepoint</title>
    <link rel="icon" type="image/gif" href="https://github.com/luizg135/api-jogos-front/blob/main/Sif.gif?raw=true">

    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined:opsz,wght,FILL,GRAD@20..48,100..700,0..1,-50..200" />
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

    <link rel="stylesheet" type="text/css" href="https://cdn.jsdelivr.net/npm/toastify-js/src/toastify.min.css">
    <script type="text/javascript" src="https://cdn.jsdelivr.net/npm/toastify-js"></script>

    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>

    <style>
        :root {
            --rank-bronze: #CD7F32; --rank-prata: #C0C0C0; --rank-ouro: #FFD700;
            --rank-platina: #ADD8E6; --rank-diamante: #00FFFF; --rank-mestre: #9370db;
        }
        body.dark-mode {
            --bg-color: #0d1117; --surface-color: #161b22; --primary-text: #e6edf3;
            --secondary-text: #7d8590; --border-color: #30363d; --accent-purple: #9370db;
            --accent-green: #238636;
        }
        /* Removido body.light-mode */
        *, *::before, *::after { box-sizing: border-box; }
        body {
            font-family: 'Inter', sans-serif; background-color: var(--bg-color);
            color: var(--primary-text); margin: 0; display: flex;
            height: 100vh; overflow: hidden; transition: background-color 0.3s ease, color 0.3s ease;
        }
        .sidebar {
            width: 80px; height: 100%; background-color: #010409;
            border-right: 1px solid var(--border-color); padding: 24px 0;
            display: flex; flex-direction: column; align-items: center;
            flex-shrink: 0; z-index: 10;
        }
        .sidebar-logo { font-size: 36px; color: var(--accent-purple); }
        .sidebar-nav { display: flex; flex-direction: column; align-items: center; gap: 16px; margin-top: 40px; }
        .nav-button {
            background-color: transparent; border: none; color: var(--secondary-text); cursor: pointer;
            padding: 12px; border-radius: 10px; display: flex; align-items: center; justify-content: center;
            width: 52px; height: 52px; transition: all 0.2s ease;
        }
        .nav-button:hover { background-color: var(--surface-color); color: var(--primary-text); }
        .nav-button.active { background-color: var(--accent-purple); color: white; }
        .nav-button .material-symbols-outlined { font-size: 28px; }
        .sidebar-footer { margin-top: auto; display: flex; flex-direction: column; gap: 16px; }
        .main-content { flex-grow: 1; padding: clamp(16px, 4vw, 48px); overflow-y: auto; height: 100%; }
        .page { display: none; }
        .page.active { display: block; animation: fadeIn 0.5s; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        .profile-header {
            background-color: var(--surface-color); border: 1px solid var(--border-color); padding: 32px;
            border-radius: 16px; margin-bottom: 32px; position: relative; overflow: hidden;
            transition: background-color 0.3s ease, border-color 0.3s ease;
        }
        .profile-main { position: relative; z-index: 1; display: flex; align-items: center; gap: 24px; flex-wrap: wrap; }
        .profile-avatar { width: 64px; height: 64px; border-radius: 50%; border: 2px solid var(--border-color); object-fit: cover; cursor: pointer; }
        .profile-info { flex-grow: 1; }
        .profile-info h1 { font-size: 28px; font-weight: 700; margin: 0; }
        .profile-info h1.rank-Mestre { color: var(--rank-mestre); text-shadow: 0 0 12px var(--rank-mestre); }
        .profile-info h1.rank-Diamante { color: var(--rank-diamante); text-shadow: 0 0 12px var(--rank-diamante); }
        .profile-info h1.rank-Platina { color: var(--rank-platina); text-shadow: 0 0 12px var(--rank-platina); }
        .profile-info h1.rank-Ouro { color: var(--rank-ouro); text-shadow: 0 0 12px var(--rank-ouro); }
        .profile-info h1.rank-Prata { color: var(--rank-prata); }
        .profile-info h1.rank-Bronze { color: var(--rank-bronze); }
        .profile-info p { font-size: 16px; color: var(--secondary-text); margin: 4px 0 0 0; }
        .profile-level { margin-left: auto; min-width: 280px; display: flex; align-items: center; text-align: right; gap: 16px; }
        .achievements-shortcut { cursor: pointer; color: var(--secondary-text); transition: color 0.2s ease; }
        .achievements-shortcut:hover { color: var(--rank-mestre); }
        .achievements-shortcut .material-symbols-outlined { font-size: 32px; }
        .level-progress { flex-grow: 1; }
        .level-text { font-size: 24px; font-weight: 700; }
        .exp-bar-container { width: 100%; height: 8px; background-color: var(--border-color); border-radius: 4px; overflow: hidden; margin-top: 8px; }
        .exp-bar-progress { height: 100%; border-radius: 44px; width: 0%; transition: width 0.5s ease; }
        .exp-bar-progress.rank-Mestre { background-color: var(--rank-mestre); box-shadow: 0 0 10px var(--rank-mestre); }
        .exp-bar-progress.rank-Diamante { background-color: var(--rank-diamante); box-shadow: 0 0 10px var(--rank-diamante); }
        .exp-bar-progress.rank-Platina { background-color: var(--rank-platina); box-shadow: 0 0 10px var(--rank-platina); }
        .exp-bar-progress.rank-Ouro { background-color: var(--rank-ouro); box-shadow: 0 0 10px var(--rank-ouro); }
        .exp-bar-progress.rank-Prata { background-color: var(--rank-prata); }
        .exp-bar-progress.rank-Bronze { background-color: var(--rank-bronze); }
        .exp-text { font-size: 12px; color: var(--secondary-text); margin-top: 4px; }
        .summary-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 16px; }
        .card {
            background-color: var(--surface-color); padding: 20px; border-radius: 12px;
            border: 1px solid var(--border-color); border-bottom: 3px solid transparent;
            transition: all 0.2s ease;
        }
        .card:hover { transform: translateY(-4px); box-shadow: 0 8px 24px rgba(0, 0, 0, 0.2); }
        .rank-colors-Bronze .card:hover, 
        .rank-colors-Bronze .platinum-card:hover, 
        .rank-colors-Bronze .wish-card:hover,
        .rank-colors-Bronze .game-card-grid:hover { 
            border-bottom-color: var(--rank-bronze); 
        }

        .rank-colors-Prata .card:hover, 
        .rank-colors-Prata .platinum-card:hover, 
        .rank-colors-Prata .wish-card:hover,
        .rank-colors-Prata .game-card-grid:hover {
            border-bottom-color: var(--rank-prata); 
        }

        .rank-colors-Ouro .card:hover, 
        .rank-colors-Ouro .platinum-card:hover, 
        .rank-colors-Ouro .wish-card:hover,
        .rank-colors-Ouro .game-card-grid:hover {
            border-bottom-color: var(--rank-ouro); 
        }

        .rank-colors-Platina .card:hover, 
        .rank-colors-Platina .platinum-card:hover, 
        .rank-colors-Platina .wish-card:hover,
        .rank-colors-Platina .game-card-grid:hover {
            border-bottom-color: var(--rank-platina); 
        }

        .rank-colors-Diamante .card:hover, 
        .rank-colors-Diamante .platinum-card:hover, 
        .rank-colors-Diamante .wish-card:hover,
        .rank-colors-Diamante .game-card-grid:hover {
            border-bottom-color: var(--rank-diamante); 
        }

        .rank-colors-Mestre .card:hover, 
        .rank-colors-Mestre .platinum-card:hover, 
        .rank-colors-Mestre .wish-card:hover,
        .rank-colors-Mestre .game-card-grid:hover {
            border-bottom-color: var(--rank-mestre); 
        }
        .card-header { display: flex; align-items: center; gap: 12px; color: var(--secondary-text); font-weight: 500; font-size: 14px; }
        .card-header .material-symbols-outlined { font-size: 20px; }
        .card-content { font-size: 24px; font-weight: 700; margin-top: 8px; }
        .recent-platinums-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(140px, 1fr)); gap: 16px; margin-top: 32px; }
        .platinum-card {
            position: relative;
            aspect-ratio: 3 / 4;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.2);
            background-color: var(--surface-color); border-radius: 12px;
            border: 1px solid var(--border-color); overflow: hidden; border-bottom: 3px solid transparent;
            transition: all 0.2s ease;
        }

        .platinum-card:hover {
            box-shadow: 0 8px 30px rgba(147, 112, 219, 0.4);
            transform: translateY(-5px);
        }

        .platinum-card img {
            width: 100%;
            height: 100%;
            object-fit: cover;
            border-radius: 12px;
        }

        .platinum-overlay {
            position: absolute;
            bottom: 0;
            left: 0;
            right: 0;
            height: 50%;
            border-radius: 0 0 12px 12px;
            background: linear-gradient(to top, rgba(16, 17, 22, 0.9) 20%, transparent);
            transition: all 0.3s ease;
        }

        .platinum-card:hover .platinum-overlay {
            background: linear-gradient(to top, rgba(16, 17, 22, 1) 40%, transparent);
        }

        .platinum-info {
            position: absolute;
            bottom: 12px;
            left: 12px;
            right: 12px;
            display: flex;
            align-items: center;
            gap: 12px;
            color: #fff;
        }

        .platinum-trophy {
            font-size: 36px !important;
            color: var(--rank-platina);
            filter: drop_shadow(0 0 8px var(--rank-platina));
        }

        .platinum-details {
            display: flex;
            flex-direction: column;
            overflow: hidden;
        }

        .platinum-title {
            font-weight: 600;
            font-size: 14px;
            white-space: nowrap;
            text-overflow: ellipsis;
            overflow: hidden;
        }

        .platinum-date {
            font-size: 12px;
            color: var(--secondary-text);
            font-weight: 500;
        }
        .filter-bar { display: grid; grid-template-columns: repeat(auto-fit, minmax(180px, 1fr)); gap: 16px; margin-bottom: 32px; }
        .filter-group { display: flex; flex-direction: column; }
        .filter-group label { font-size: 12px; font-weight: 500; color: var(--secondary-text); margin-bottom: 8px; }
        .filter-group input, .filter-group select, .filter-group button {
            width: 100%; background-color: var(--bg-color); color: var(--primary-text);
            border: 1px solid var(--border-color); padding: 10px 12px; border-radius: 8px; font-size: 14px;
        }
        .clear-filters-btn {
            background: transparent; border: 1px solid var(--border-color);
            padding: 10px 12px; border-radius: 8px; cursor: pointer;
            display: flex; align-items: center; justify-content: center;
            transition: all 0.2s ease; margin-top: auto;
            width: 52px; height: 52px;
        }
        .clear-filters-btn:hover { color: var(--primary-text); border-color: var(--primary-text); }
        .charts-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(400px, 1fr)); gap: 24px; margin-top: 32px; }
        .chart-card {
            background-color: var(--surface-color); padding: 24px; border-radius: 12px;
            border: 1px solid var(--border-color); height: 380px;
            display: flex; flex-direction: column;
        }
        .chart-card h3 { margin-top: 0; margin-bottom: 24px; text-align: center; font-weight: 500; color: var(--secondary-text); flex-shrink: 0; }
        .chart-wrapper { position: relative; flex-grow: 1; }
        .table-container { background-color: var(--surface-color); border: 1px solid var(--border-color); border-radius: 12px; overflow: hidden; }
        .games-table { width: 100%; border-collapse: collapse; }
        .games-table th, .games-table td { padding: 16px; text-align: left; border-bottom: 1px solid var(--border-color); white-space: nowrap; vertical-align: middle; }
        .games-table th { font-weight: 600; font-size: 12px; color: var(--secondary-text); text-transform: uppercase; }
        .games-table tbody tr:last-child td { border-bottom: none; }
        .games-table tbody tr.platinado-row { background: linear-gradient(90deg, rgba(147, 112, 219, 0.15) 0%, rgba(147, 112, 219, 0) 60%); }
        .games-table tbody tr:not(.platinado-row):hover { background-color: rgba(255, 255, 255, 0.03); }
        .game-name-cell { display: flex; align-items: center; gap: 16px; font-weight: 500; }
        .trophy-icon { color: var(--accent-purple); font-size: 22px !important; filter: drop_shadow(0 0 8px var(--accent-purple)); }
        .nota-cell { font-weight: 600; color: var(--accent-purple); }
        .no-results { text-align: center; color: var(--secondary-text); padding: 48px; }
        .wishlist-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(180px, 1fr)); gap: 16px; } /* Aumentado minmax */
        .wish-card {
            background-color: var(--surface-color); border-radius: 12px;
            border: 1px solid var(--border-color); overflow: hidden; border-bottom: 3px solid transparent;
            transition: all 0.2s ease;
            position: relative;
            height: 320px; /* Aumentado a altura do card */
            cursor: pointer; /* Adicionado cursor pointer para indicar clicável */
        }
        .wish-card:hover { transform: translateY(-5px); box-shadow: 0 10px 20px rgba(0,0,0,0.3); }
        .wish-card-img { width: 100%; height: 180px; object-fit: cover; display: block; background-color: #010409; }
        .wish-card-info { padding: 12px; display: flex; flex-direction: column; flex-grow: 1; }
        .wish-card-title { font-weight: 500; font-size: 14px; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; margin: 0 0 8px 0; }
        .wish-card-details { 
            display: flex; 
            flex-direction: column; /* Alterado para coluna para exibir mais informações */
            gap: 4px;
            font-size: 12px; 
            margin-top: auto; /* Empurra para o final do card-info */
        }
        .wish-card-price-row {
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        .wish-card-price { font-weight: 600; color: var(--accent-purple); }

        .price-status {
            padding: 2px 6px;
            border-radius: 4px;
            font-size: 10px;
            font-weight: 600;
            color: white;
            text-transform: uppercase;
        }
        .price-status.bom { background-color: var(--accent-green); }
        .price-status.normal { background-color: #f39c12; } /* Laranja */
        .price-status.ruim { background-color: #cb2d3e; } /* Vermelho */


        .modal-overlay {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background-color: rgba(0, 0, 0, 0.7); display: flex; align-items: center; justify-content: center;
            z-index: 1000; visibility: hidden; opacity: 0; transition: visibility 0.3s, opacity 0.3s;
        }
        .modal-overlay.active { visibility: visible; opacity: 1; }
        .modal-content {
            background-color: var(--surface-color); padding: 32px; border-radius: 16px;
            max-width: 500px; width: 90%; position: relative; box-shadow: 0 10px 30px rgba(0, 0, 0, 0.5);
            transform: scale(0.95); transition: transform 0.3s ease-out;
        }
        .modal-overlay.active .modal-content { transform: scale(1); }
        .close-button { position: absolute; top: 16px; right: 24px; font-size: 28px; color: var(--secondary-text); cursor: pointer; }
        .form-group { margin-bottom: 16px; }
        .modal-content form input:not([type="hidden"]), .modal-content form select, .modal-content form textarea {
            width: 100%; padding: 10px 12px; border: 1px solid var(--border-color);
            background-color: var(--bg-color); color: var(--primary-text);
            border-radius: 8px; font-size: 14px;
            box-sizing: border-box;
            -webkit-appearance: none;
            -moz-appearance: none;
            appearance: none;
        }
        .modal-content form button { 
            width: 100%; padding: 12px; background-color: var(--accent-purple); color: white; border: none; 
            border-radius: 8px; font-size: 16px; font-weight: 600; cursor: pointer; margin-top: 16px;
        }
        .action-buttons { display: flex; gap: 8px; }
        .action-button { background: transparent; border: none; padding: 4px; color: var(--secondary-text); cursor: pointer; }
        .modal-content .tabs { display: flex; border-bottom: 1px solid var(--border-color); margin-bottom: 24px; }
        .modal-content .tab-button {
            padding: 12px 20px; border: none; background: none; color: var(--secondary-text);
            cursor: pointer; font-size: 16px; font-weight: 500; position: relative;
        }
        .modal-content .tab-button.active { color: var(--primary-text); }
        .modal-content .tab-button.active::after {
            content: ''; position: absolute; bottom: -1px; left: 0; right: 0;
            height: 2px; background-color: var(--accent-purple);
        }
        .tab-content { display: none; }
        .tab-content.active { display: block; }
        .achievements-list { display: flex; flex-direction: column; gap: 16px; max-height: 50vh; overflow-y: auto; padding-right: 10px; }
        .achievement-card {
            background-color: var(--bg-color); border: 1px solid var(--border-color);
            border-left: 5px solid var(--accent-purple); border-radius: 8px;
            padding: 16px; display: flex; align-items: center; gap: 16px;
        }
        .achievement-card.completed { border-left-color: var(--accent-green); }
        .achievement-icon .material-symbols-outlined { font-size: 40px; color: var(--accent-purple); }
        .achievement-details { flex-grow: 1; }
        .achievement-details h3 { margin: 0 0 4px 0; font-size: 16px; color: var(--primary-text); }
        .achievement-details p { margin: 0; font-size: 12px; color: var(--secondary-text); }
        .achievement-progress-bar-container {
            width: 100%; height: 6px; background-color: var(--border-color);
            border-radius: 3px; overflow: hidden; margin-top: 8px;
        }
        .achievement-progress-bar {
            height: 100%; width: 0%; background-color: var(--accent-purple);
            border-radius: 3px; transition: width 0.5s ease;
        }
        .achievement-progress-text { font-size: 12px; font-weight: 500; color: var(--secondary-text); margin-top: 4px; text-align: right; }
        .achievement-details .exp-reward { font-weight: bold; color: var(--rank-ouro); }
        .achievement-icon.tier-Bronze .material-symbols-outlined { color: var(--rank-bronze); }
        .achievement-icon.tier-Prata .material-symbols-outlined { color: var(--rank-prata); }
        .achievement-icon.tier-Ouro .material-symbols-outlined { color: var(--rank-ouro); }
        .achievement-icon.tier-Platina .material-symbols-outlined { color: var(--rank-platina); }
        .achievement-icon.tier-Diamante .material-symbols-outlined { color: var(--rank-diamante); }
        .achievement-icon.tier-Mestre .material-symbols-outlined { color: var(--rank-mestre); }
    
        .achievements-list::-webkit-scrollbar {
            width: 8px; 
        }

        .achievements-list::-webkit-scrollbar-track {
            background: transparent; 
        }

        .achievements-list::-webkit-scrollbar-thumb {
            background-color: var(--border-color); 
            border-radius: 10px; 
            border: 2px solid var(--surface-color); 
        }

        .achievements-list {
            scrollbar-width: thin;
            scrollbar-color: var(--border-color) var(--surface-color);
        }

        #searchResultsContainer {
            position: relative;
        }
        .search-results-list {
            position: absolute; width: 100%; background-color: var(--surface-color);
            border: 1px solid var(--border-color); border-radius: 8px;
            margin-top: 5px; max-height: 300px; overflow-y: auto; z-index: 1001;
        }
        .search-result-item {
            display: flex; align-items: center; padding: 10px; cursor: pointer;
            border-bottom: 1px solid var(--border-color);
        }
        .search-result-item:last-child { border-bottom: none; }
        .search-result-item:hover { background-color: var(--bg-color); }
        .search-result-item img {
            width: 90px; height: 60px; object-fit: cover;
            border-radius: 4px; margin-right: 12px;
        }
        .search-result-info span { display: block; font-size: 14px; font-weight: 500; }
        .search-result-info small { font-size: 12px; color: var(--secondary-text); margin-top: 4px; }

        .section-header {
            display: flex;
            align-items: center;
            gap: 16px;
            margin-top: 48px;
            margin-bottom: 24px;
            padding-bottom: 16px;
            border-bottom: 1px solid var(--border-color);
            color: var(--secondary-text);
        }

        .section-header h2 {
            margin: 0;
            font-size: 18px;
            font-weight: 500;
            color: var(--primary-text);
        }

        .section-header .material-symbols-outlined {
            font-size: 24px;
            color: var(--accent-purple);
        }
        /* Estilos para a Visualização em Grade e Botões de Ação */
        .header-actions {
            display: flex;
            gap: 8px;
            margin-left: auto; /* Adicionado para empurrar os botões para a direita */
        }

        .games-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(160px, 1fr));
            gap: 20px;
        }

        .game-card-grid {
            background-color: var(--surface-color);
            border-radius: 12px;
            border: 1px solid var(--border-color);
            overflow: hidden;
            transition: all 0.2s ease;
            cursor: pointer;
            display: flex;
            flex-direction: column;
            position: relative;
            border-bottom: 3px solid transparent;
        }

            .game-card-grid:hover {
                transform: translateY(-5px);
                box-shadow: 0 10px 20px rgba(0,0,0,0.3);
        }

        .game-card-grid img {
            width: 100%;
            height: 215px;
            object-fit: cover;
            display: block;
        }

        .game-card-content {
            padding: 12px;
            flex-grow: 1;
            display: flex;
            flex-direction: column;
        }

        .game-card-top-details {
            display: flex;
            justify-content: space-between;
            font-size: 11px;
            color: var(--secondary-text);
            margin-bottom: 8px;
            padding-bottom: 8px;
            border-bottom: 1px solid var(--border-color);
        }

        .game-card-top-details .material-symbols-outlined {
            font-size: 14px;
        }

        .game-card-grid .game-title {
            padding: 0;
            text-align: left;
            font-weight: 600;
            font-size: 14px;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
            margin-top: auto;
        }

        .game-card-trophy {
            position: absolute;
            top: 8px;
            right: 8px;
            font-size: 28px !important;
            color: var(--accent-purple);
            background-color: rgba(0,0,0,0.5);
            border-radius: 50%;
            padding: 4px;
            filter: drop_shadow(0 0 5px var(--accent-purple));
        }

        .sortable-header {
            cursor: pointer;
            position: relative;
            user-select: none;
        }

        .sortable-header:hover {
            color: var(--primary-text);
        }

        .sort-icon {
            position: absolute;
            right: 16px;
            top: 50%;
            transform: translateY(-50%);
            opacity: 0.6;
        }

        .sortable-header.sort-asc .sort-icon::after {
            content: '▲';
            font-size: 10px;
        }

        .sortable-header.sort-desc .sort-icon::after {
            content: '▼';
            font-size: 10px;
        }
        
        .game-details-modal-content {
            background-color: var(--surface-color);
            padding: 0;
            border-radius: 16px;
            max-width: 800px;
            width: 90%;
            position: relative;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.5);
            transform: scale(0.95);
            transition: transform 0.3s ease-out;
        }
        .modal-overlay.active .game-details-modal-content {
            transform: scale(1);
        }
        .game-details-header {
            position: relative;
            height: 250px;
            overflow: hidden;
            border-radius: 16px 16px 0 0;
        }
        .game-details-header img {
            width: 100%;
            height: 100%;
            object-fit: cover;
            filter: brightness(0.6);
        }
        .game-details-info {
            position: absolute;
            bottom: 0;
            left: 0;
            right: 0;
            background: linear-gradient(to top, rgba(16, 17, 22, 0.9) 20%, transparent);
            padding: 24px;
            display: flex;
            align-items: flex-end;
            gap: 24px;
        }
        .game-details-info .game-cover-art {
            width: 120px;
            height: 160px;
            object-fit: cover;
            border-radius: 8px;
            border: 2px solid var(--border-color);
            box-shadow: 0 4px 15px rgba(0,0,0,0.5);
            transform: translateY(32px);
        }
        .game-details-info-text {
            flex-grow: 1;
        }
        .game-details-info-text h2 {
            margin: 0;
            font-size: 28px;
            font-weight: 700;
            color: var(--primary-text);
        }
        .game-details-info-text p {
            margin: 4px 0 0 0;
            font-size: 16px;
            color: var(--secondary-text);
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }
        .game-details-body {
            padding: 56px 24px 24px 24px;
            display: grid;
            grid-template-columns: 1fr 2fr;
            gap: 24px;
            color: var(--primary-text);
        }
        .game-details-stats, .game-details-description {
            background-color: var(--bg-color);
            padding: 16px;
            border-radius: 8px;
            border: 1px solid var(--border-color);
        }
        .game-details-stats-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 8px 0;
            border-bottom: 1px solid var(--border-color);
            font-size: 14px;
        }
        .game-details-stats-item:last-child {
            border-bottom: none;
        }
        .game-details-stats-item span:first-child {
            color: var(--secondary-text);
            font-weight: 500;
        }
        .game-details-stats-item span:last-child {
            font-weight: 600;
        }
        .metacritic-score, .rating-score {
            font-size: 14px;
            font-weight: 600;
            padding: 4px 8px;
            border-radius: 4px;
            color: white;
            min-width: 45px;
            text-align: center;
        }
        .metacritic-score.good, .rating-score.good { background-color: #6c3; }
        .metacritic-score.mixed, .rating-score.mixed { background-color: #fc3; }
        .metacritic-score.bad, .rating-score.bad { background-color: #f33; }
        
        .game-details-description h3 {
            margin: 0 0 12px 0;
            font-size: 16px;
            color: var(--secondary-text);
            border-bottom: 1px solid var(--border-color);
            padding-bottom: 8px;
        }
        .game-details-description p {
            margin: 0;
            font-size: 14px;
            color: var(--primary-text);
            line-height: 1.6;
            white-space: pre-wrap;
            max-height: 200px;
            overflow-y: auto;
        }
        /* Estilos para a barra de rolagem da descrição do jogo */
        .game-details-description p::-webkit-scrollbar {
            width: 8px; 
        }

        .game-details-description p::-webkit-scrollbar-track {
            background: transparent; 
        }

        .game-details-description p::-webkit-scrollbar-thumb {
            background-color: var(--border-color); 
            border-radius: 10px; 
            border: 2px solid var(--bg-color); 
        }

        .game-details-description p {
            scrollbar-width: thin;
            scrollbar-color: var(--border-color) var(--bg-color);
        }

        .game-details-actions {
            grid-column: 1 / -1;
            display: flex;
            justify-content: flex-end;
            gap: 8px;
            padding-top: 16px;
        }
        .game-details-actions .action-button {
            padding: 8px;
            border-radius: 8px;
            font-size: 14px;
            font-weight: 600;
            cursor: pointer;
            transition: background-color 0.2s ease;
            display: flex;
            align-items: center;
            gap: 4px;
            color: var(--secondary-text);
            border: 1px solid var(--border-color);
        }
        .game-details-actions .action-button:hover {
            color: var(--primary-text);
            background-color: var(--bg-color);
        }
        .game-details-actions .delete-btn {
            color: #cb2d3e;
            border-color: #cb2d3e;
        }
        .game-details-actions .delete-btn:hover {
            background-color: #cb2d3e;
            color: white;
        }

        /* Novas regras para o modal de filtros avançados */
        .advanced-filters-modal-content {
            background-color: var(--surface-color);
            padding: 32px;
            border-radius: 16px;
            max-width: 600px; /* Aumentado para acomodar mais filtros */
            width: 90%;
            position: relative;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.5);
            transform: scale(0.95);
            transition: transform 0.3s ease-out;
        }
        .modal-overlay.active .advanced-filters-modal-content {
            transform: scale(1);
        }
        .advanced-filters-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(180px, 1fr));
            gap: 16px;
            margin-top: 24px;
        }
        .filter-modal-actions {
            display: flex;
            justify-content: flex-end;
            gap: 12px;
            margin-top: 24px;
        }
        .filter-modal-actions button {
            width: auto;
            padding: 10px 20px;
            font-size: 14px;
            font-weight: 600;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.2s ease;
        }
        .filter-modal-actions .apply-filters-btn {
            background-color: var(--accent-purple);
            color: white;
            border: none;
        }
        .filter-modal-actions .apply-filters-btn:hover {
            background-color: #a884e9;
        }
        .filter-modal-actions .clear-all-filters-btn {
            background-color: transparent;
            color: var(--secondary-text);
            border: 1px solid var(--border-color);
        }
        .filter-modal-actions .clear-all-filters-btn:hover {
            color: var(--primary-text);
            border-color: var(--primary-text);
        }

        /* Loading Screen Styles */
        #loading-screen {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: linear-gradient(135deg, #301934 0%, #0d1117 100%); /* Degradê roxo para preto */
            background-image: url('https://www.transparenttextures.com/patterns/dark-fish-skin.png'), linear-gradient(135deg, #301934 0%, #0d1117 100%); /* Textura + Degradê */
            display: flex;
            flex-direction: column; /* Para alinhar texto e GIF */
            align-items: center;
            justify-content: center;
            z-index: 9999;
            opacity: 1;
            visibility: visible;
            transition: opacity 0.5s ease, visibility 0.5s ease;
            color: var(--primary-text); /* Cor do texto */
            font-size: 2em; /* Tamanho do texto de carregamento */
            font-weight: 600;
        }

        #loading-screen.hidden {
            opacity: 0;
            visibility: hidden;
        }

        #loading-screen .loading-content {
            position: relative;
            width: 100%;
            height: 100%;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
        }

        #loading-screen .loading-text {
            margin-bottom: 20px; /* Espaço entre o texto e o GIF */
            text-shadow: 0 0 10px rgba(147, 112, 219, 0.7); /* Sombra no texto */
            display: flex; /* Para animar os pontos individualmente */
            align-items: flex-end; /* Alinha os pontos na base */
        }

        #loading-screen .loading-text span {
            animation: bounce 1.4s infinite;
            display: inline-block; /* Permite a animação individual */
        }

        #loading-screen .loading-text span:nth-child(2) {
            animation-delay: 0.2s;
        }

        #loading-screen .loading-text span:nth-child(3) {
            animation-delay: 0.4s;
        }

        @keyframes bounce {
            0%, 80%, 100% {
                transform: translateY(0);
            }
            40% {
                transform: translateY(-10px);
            }
        }

        #loading-screen img {
            position: absolute;
            bottom: 20px; /* Canto inferior direito */
            right: 20px;
            max-width: 200px; /* Tamanho ajustado para o GIF */
            max-height: 200px;
            object-fit: contain;
        }

        /* Estilos para os cabeçalhos das abas com textura */
        .profile-header {
            background-image: url('https://www.transparenttextures.com/patterns/dark-fish-skin.png'); /* Textura + Degradê: Roxo para Preto */
            background-color: var(--surface-color); /* Fallback */
            border: 1px solid var(--border-color);
            padding: 32px;
            border-radius: 16px;
            margin-bottom: 32px;
            position: relative;
            overflow: hidden;
            transition: background-color 0.3s ease, border-color 0.3s ease;
        }

        /* Estilos para o botão de notificações */
        .notifications-button {
            position: relative;
        }

        .notification-count {
            position: absolute;
            top: -5px;
            right: -5px;
            background-color: var(--accent-purple); /* Roxo para o contador */
            color: white;
            font-size: 12px;
            font-weight: 700;
            border-radius: 50%;
            padding: 2px 6px;
            min-width: 20px; /* Garante que o círculo seja visível mesmo com 1 dígito */
            text-align: center;
            line-height: 1.2;
            display: none; /* Escondido por padrão */
        }
        .notification-count.visible {
            display: block;
        }

        /* Estilos para o modal de notificações */
        #notificationsModal .modal-content {
            max-width: 600px;
        }

        .notifications-list-container { /* Novo contêiner para as listas de notificações */
            max-height: 400px;
            overflow-y: auto;
            padding-right: 10px; /* Espaçamento para a barra de rolagem */
        }

        .notifications-list-container::-webkit-scrollbar {
            width: 8px; 
        }

        .notifications-list-container::-webkit-scrollbar-track {
            background: transparent; 
        }

        .notifications-list-container::-webkit-scrollbar-thumb {
            background-color: var(--border-color); 
            border-radius: 10px; 
            border: 2px solid var(--surface-color); 
        }

        .notifications-list-container {
            scrollbar-width: thin;
            scrollbar-color: var(--border-color) var(--surface-color);
        }

        .notification-item {
            background-color: var(--bg-color);
            border: 1px solid var(--border-color);
            border-radius: 8px;
            padding: 12px 16px;
            margin-bottom: 10px;
            display: flex;
            flex-direction: column;
            align-items: flex-start;
            cursor: pointer;
            transition: background-color 0.2s ease;
        }

        .notification-item:hover {
            background-color: rgba(147, 112, 219, 0.1); /* Leve destaque no hover */
        }

        .notification-item.read {
            opacity: 0.7;
            background-color: rgba(125, 133, 144, 0.1); /* Mais opaco se lida */
        }

        .notification-item strong {
            color: var(--accent-purple);
            font-size: 15px;
            margin-bottom: 4px;
        }

        .notification-item span {
            font-size: 13px;
            color: var(--primary-text);
        }

        .notification-item small {
            font-size: 10px;
            color: var(--secondary-text);
            margin-top: 8px;
            align-self: flex-end; /* Alinha a data à direita */
        }

        /* Botão "Marcar todas como lidas" */
        .mark-all-read-btn {
            background-color: var(--accent-purple);
            color: white;
            border: none;
            border-radius: 8px;
            padding: 10px 15px;
            font-size: 14px;
            font-weight: 600;
            cursor: pointer;
            margin-top: 20px;
            width: 100%;
            transition: background-color 0.2s ease;
        }
        .mark-all-read-btn:hover {
            background-color: #a884e9;
        }

        /* NOVO: Estilos para a data de atualização no cabeçalho da wishlist */
        .wishlist-header-info {
            display: flex;
            align-items: center;
            gap: 10px;
            font-size: 12px;
            color: var(--secondary-text);
            margin-left: auto; /* Alinha à direita */
        }
        .wishlist-header-info .material-symbols-outlined {
            font-size: 16px;
            color: var(--accent-purple);
        }

        /* Ajustes para o modal de detalhes da wishlist */
        #wishDetailsModal .game-details-body {
            grid-template-columns: 1fr; /* Altera para uma única coluna */
            padding: 24px; /* Ajusta o padding */
        }

        #wishDetailsModal .game-details-stats {
            background-color: var(--bg-color);
            padding: 16px;
            border-radius: 8px;
            border: 1px solid var(--border-color);
            margin-bottom: 24px; /* Adiciona espaço abaixo das estatísticas */
        }

        #wishDetailsModal .game-details-stats-item {
            padding: 10px 0; /* Aumenta o padding vertical */
            font-size: 16px; /* Aumenta o tamanho da fonte */
        }

        #wishDetailsModal .game-details-stats-item span:first-child {
            font-size: 14px; /* Ajusta o tamanho da label */
        }

        #wishDetailsModal .game-details-stats-item span:last-child {
            font-size: 16px; /* Ajusta o tamanho do valor */
        }

        #wishDetailsModal .game-details-actions {
            justify-content: center; /* Centraliza os botões */
            padding-top: 0; /* Remove padding superior extra */
        }
        /* Estilos para o gráfico de histórico de preços */
        .price-history-chart-container {
            margin-top: 24px;
            height: 250px;
            position: relative;
        }
        .price-history-chart-container h3 {
            text-align: center;
            font-size: 16px;
            color: var(--secondary-text);
            margin-bottom: 12px;
        }
        .price-history-chart-container canvas {
            width: 100% !important;
            height: 100% !important;
        }
        #noPriceHistory {
            text-align: center;
            color: var(--secondary-text);
            padding: 20px;
            font-style: italic;
        }
        /* Estilos para a seção de jogos similares */
        .similar-games-section {
            grid-column: 1 / -1; /* Ocupa toda a largura */
            margin-top: 24px;
            padding-top: 16px;
            border-top: 1px solid var(--border-color);
        }
        .similar-games-section h3 {
            margin: 0 0 16px 0;
            font-size: 18px;
            color: var(--primary-text);
            text-align: center;
        }
        .similar-games-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(120px, 1fr));
            gap: 16px;
        }
        .similar-game-card {
            background-color: var(--bg-color);
            border-radius: 8px;
            overflow: hidden;
            border: 1px solid var(--border-color);
            cursor: pointer;
            transition: transform 0.2s ease, box-shadow 0.2s ease;
        }
        .similar-game-card:hover {
            transform: translateY(-3px);
            box-shadow: 0 6px 15px rgba(0,0,0,0.3);
        }
        .similar-game-card img {
            width: 100%;
            height: 100px; /* Altura fixa para as capas */
            object-fit: cover;
            display: block;
        }
        .similar-game-info {
            padding: 8px;
            font-size: 12px;
            text-align: center;
        }
        .similar-game-info strong {
            display: block;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
            color: var(--primary-text);
        }
        .similar-game-info small {
            color: var(--secondary-text);
        }
        .similar-game-owned-tag {
            background-color: var(--accent-green);
            color: white;
            font-size: 10px;
            padding: 2px 6px;
            border-radius: 4px;
            margin-top: 4px;
            display: inline-block;
        }
        /* Estilos para o modal de sincronização da Steam */
        #syncModal .modal-content {
            max-width: 700px;
        }
        .steam-preview-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(180px, 1fr));
            gap: 16px;
            max-height: 400px;
            overflow-y: auto;
            padding-right: 10px;
            margin-top: 20px;
            border-top: 1px solid var(--border-color);
            padding-top: 20px;
        }
        .steam-preview-grid::-webkit-scrollbar { width: 8px; }
        .steam-preview-grid::-webkit-scrollbar-track { background: transparent; }
        .steam-preview-grid::-webkit-scrollbar-thumb { background-color: var(--border-color); border-radius: 10px; border: 2px solid var(--surface-color); }
        .steam-preview-grid { scrollbar-width: thin; scrollbar-color: var(--border-color) var(--surface-color); }

        .steam-game-item {
            background-color: var(--bg-color);
            border: 1px solid var(--border-color);
            border-radius: 8px;
            padding: 12px;
            display: flex;
            flex-direction: column;
            align-items: center;
            text-align: center;
            position: relative;
        }
        .steam-game-item img {
            width: 100%;
            height: 100px;
            object-fit: cover;
            border-radius: 4px;
            margin-bottom: 8px;
        }
        .steam-game-item h4 {
            margin: 0 0 4px 0;
            font-size: 14px;
            font-weight: 600;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
            width: 100%;
        }
        .steam-game-item p {
            margin: 0;
            font-size: 12px;
            color: var(--secondary-text);
        }
        .steam-game-item input[type="checkbox"] {
            position: absolute;
            top: 8px;
            left: 8px;
            width: 20px;
            height: 20px;
            accent-color: var(--accent-purple);
        }
        .steam-game-category {
            font-size: 10px;
            font-weight: 700;
            color: var(--accent-purple);
            margin-bottom: 8px;
            text-transform: uppercase;
        }
        .steam-sync-status {
            text-align: center;
            margin-top: 20px;
            font-size: 14px;
            color: var(--secondary-text);
        }
        .steam-sync-status.loading {
            color: var(--accent-purple);
        }
        .steam-sync-status.error {
            color: #cb2d3e;
        }
        .steam-sync-status.success {
            color: var(--accent-green);
        }
        /* Estilos para o modal de sorteio de jogo */
        #randomGameModal .modal-content {
            max-width: 500px;
        }
        .random-game-filters {
            display: grid;
            grid-template-columns: 1fr;
            gap: 16px;
            margin-top: 24px;
        }
        @media (min-width: 480px) {
            .random-game-filters {
                grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            }
        }
        .random-game-filters .filter-group label {
            margin-bottom: 4px;
        }
        .random-game-filters button {
            margin-top: 24px;
        }
        #randomGameResult {
            text-align: center;
            margin-top: 20px;
            font-size: 16px;
            color: var(--primary-text);
        }
    </style>
</head>

<body class="dark-mode">
    <div id="loading-screen">
        <div class="loading-content">
            <span class="loading-text">Carregando<span>.</span><span>.</span><span>.</span></span>
            <img src="https://github.com/luizg135/api-jogos-front/blob/main/Sif.gif?raw=true" alt="Loading GIF">
        </div>
    </div>

    <nav class="sidebar">
        <span class="material-symbols-outlined sidebar-logo">stadia_controller</span>
        <div class="sidebar-nav">
            <button class="nav-button active" onclick="openPage(event, 'perfil')" title="Perfil"><span class="material-symbols-outlined">person</span></button>
            <button class="nav-button" onclick="openPage(event, 'graficos')" title="Gráficos"><span class="material-symbols-outlined">bar_chart</span></button>
            <button class="nav-button" onclick="openPage(event, 'biblioteca')" title="Lista de Jogos"><span class="material-symbols-outlined">list_alt</span></button>
            <button class="nav-button" onclick="openPage(event, 'desejos')" title="Lista de Desejos"><span class="material-symbols-outlined">card_giftcard</span></button>
            
            <button class="nav-button notifications-button" id="notificationsBtn" title="Notificações">
                <span class="material-symbols-outlined">notifications</span>
                <span class="notification-count" id="notificationCount">0</span>
            </button>
        </div>
        <div class="sidebar-footer">
            <button class="nav-button" id="shareBtn" title="Compartilhar Perfil"><span class="material-symbols-outlined">share</span></button>
            <button class="nav-button" id="logoutBtn" title="Sair"><span class="material-symbols-outlined">logout</span></button>
        </div>
    </nav>

    <main class="main-content" id="main-content">
        <div id="content">
            <section id="perfil" class="page active">
                <header class="profile-header">
                    <div class="profile-main">
                        <img id="profileAvatar" src="https://i.imgur.com/Z0ebi8o.png" alt="Avatar" class="profile-avatar" onclick="openSettingsModal()">
                        <div class="profile-info">
                            <h1 id="gamerName">Carregando...</h1>
                            <p id="profileSubtitle">Resumo da jornada!</p>
                        </div>
                        <div class="profile-level">
                            <div class="achievements-shortcut" id="achievementsShortcut" title="Ver Conquistas">
                                <span class="material-symbols-outlined">military_tech</span>
                            </div>
                            <div class="level-progress" style="flex-grow: 1;">
                                <div id="levelDisplay" class="level-text">Nível 0</div>
                                <div class="exp-bar-container"><div id="expBar" class="exp-bar-progress"></div></div>
                                <div id="expText" class="exp-text">0 / 1000 EXP</div>
                            </div>
                        </div>
                    </div>
                </header>
                <div id="summary" class="summary-grid"></div>
                <div class="section-header">
                    <span class="material-symbols-outlined">emoji_events</span>
                    <h2>Últimos Jogos Platinados</h2>
                </div>
                <div id="recent-platinums" class="recent-platinums-grid"></div>
            </section>

            <section id="conquistas" class="page">
                <header class="profile-header">
                    <div class="profile-main">
                        <div class="profile-info">
                            <h1 style="color: var(--accent-purple);">Minhas Conquistas</h1>
                            <p>Seus marcos e feitos notáveis na jornada gamer.</p>
                        </div>
                    </div>
                </header>
                <div id="achievements-container" class="achievements-grid"></div>
            </section>

            <section id="graficos" class="page">
                <header class="profile-header">
                    <div class="profile-main">
                        <div class="profile-info">
                            <h1 style="color: var(--accent-purple);">Análise Gráfica</h1>
                            <p>Visão detalhada sobre seus hábitos e conquistas.</p>
                        </div>
                        <div class="header-actions">
                            <button class="nav-button" id="openAdvancedFiltersBtn-graficos" title="Filtros Avançados">
                                <span class="material-symbols-outlined">filter_alt</span>
                            </button>
                        </div>
                    </div>
                </header>
                <div id="summary-graficos" class="summary-grid"></div>
                <div id="charts-container" class="charts-grid">
                    <div class="chart-card"><h3>Jogos Platinados</h3><div class="chart-wrapper"><canvas id="platinadosChart"></canvas></div></div>
                    <div class="chart-card"><h3>Jogos por Plataforma</h3><div class="chart-wrapper"><canvas id="platformChart"></canvas></div></div>
                    <div class="chart-card"><h3>Jogos por Status</h3><div class="chart-wrapper"><canvas id="statusChart"></canvas></div></div>
                    <div class="chart-card"><h3>Top 5 Estilos</h3><div class="chart-wrapper"><canvas id="styleChart"></canvas></div></div>
                </div>
            </section>

            <section id="biblioteca" class="page">
            <header class="profile-header">
                <div class="profile-main" style="justify-content: space-between;">
                    <div class="profile-info">
                        <h1 style="color: var(--accent-purple);">Biblioteca de Jogos</h1>
                        <p>Explore toda a sua coleção.</p>
                    </div>
                    <div class="header-actions">
                        <button class="nav-button" id="toggleViewBtn" title="Mudar Visualização"><span class="material-symbols-outlined">view_list</span></button>
                        <button class="nav-button" id="openAdvancedFiltersBtn-biblioteca" title="Filtros Avançados">
                            <span class="material-symbols-outlined">filter_alt</span>
                        </button>
                        <!-- NOVO BOTÃO: Sortear Jogo -->
                        <button class="nav-button" id="randomGameBtn" title="Sortear Jogo">
                            <span class="material-symbols-outlined">casino</span>
                        </button>
                        <!-- NOVO BOTÃO: Sincronizar com Steam -->
                        <button class="nav-button" id="syncLibraryBtn" title="Sincronizar com Steam">
                            <span class="material-symbols-outlined">sync</span>
                        </button>
                        <button class="nav-button" id="addGameBtn" title="Adicionar Novo Jogo"><span class="material-symbols-outlined">add</span></button>
                    </div>
                </div>
            </header>
                <div class="table-container" style="display: none;">
                    <table class="games-table">
            <thead>
                <tr>
                    <th class="sortable-header" data-sort-key="Nome">Nome <span class="sort-icon"></span></th>
                    <th class="sortable-header" data-sort-key="Plataforma">Plataforma <span class="sort-icon"></span></th>
                    <th class="sortable-header" data-sort-key="Status">Status <span class="sort-icon"></span></th>
                    <th class="sortable-header" data-sort-key="Nota">Nota <span class="sort-icon"></span></th>
                    <th class="sortable-header" data-sort-key="Tempo de Jogo">Horas <span class="sort-icon"></span></th>
                    <th>Ações</th>
                </tr>
            </thead>
                        <tbody id="game-list-tbody"></tbody>
                    </table>
                </div>
                <div id="no-results-message" class="no-results" style="display: none;"><p>Nenhum jogo encontrado.</p></div>
                <div id="game-grid-container" class="games-grid"></div>
            </section>
            
            <section id="desejos" class="page">
                <header class="profile-header">
                    <div class="profile-main" style="justify-content: space-between;">
                        <div class="profile-info">
                            <h1 style="color: var(--accent-purple);">Lista de Desejos</h1>
                            <p>Seus próximos jogos e futuras aventuras.</p>
                        </div>
                        <div class="wishlist-header-info">
                            <span class="material-symbols-outlined">update</span>
                            <span id="lastWishlistUpdate">Última atualização: N/A</span>
                        </div>
                        <div class="header-actions">
                            <button class="nav-button" id="triggerScraperBtn" title="Atualizar Preços">
                                <span class="material-symbols-outlined">refresh</span>
                            </button>
                            <button class="nav-button" id="openAdvancedFiltersBtn-desejos" title="Filtros Avançados">
                                <span class="material-symbols-outlined">filter_alt</span>
                            </button>
                            <button class="nav-button" id="addWishBtn" title="Adicionar Jogo à Lista"><span class="material-symbols-outlined">add</span></button>
                        </div>
                    </div>
                </header>
                <div id="wishlist-container" class="wishlist-grid"></div>
                <div id="no-wishlist-results-message" class="no-results" style="display: none;"><p>Nenhum jogo na lista de desejos encontrado.</p></div>

            </section>
        </div>
    </main>
    
    <div id="addGameModal" class="modal-overlay">
        <div class="modal-content">
            <span class="close-button" onclick="closeGameModal()">&times;</span>
            <h2 id="gameModalTitle">Adicionar Novo Jogo</h2>
            <form id="addGameForm">
<input type="hidden" id="editMode" value="">
<input type="hidden" id="rawgIdInput" value="">
<input type="hidden" id="gameMetacritic" value="">
<input type="hidden" id="gameDescription" value="">


<div class="form-group">
    <label for="gameName">Nome do Jogo</label>
    <input type="text" id="gameName" required autocomplete="off">
    <div id="searchResultsContainer"></div>
</div>

<div class="form-group">
    <label for="gamePlatform">Plataforma</label>
    <input type="text" id="gamePlatform" placeholder="Ex: PC, PS5">
</div>

<div class="form-group">
    <label for="gameStatus">Status</label>
    <select id="gameStatus">
        <option value="Na Fila">Na Fila</option>
        <option value="Jogando">Jogando</option>
        <option value="Finalizado">Finalizado</option>
        <option value="Platinado">Platinado</option>
        <option value="Abandonado">Abandonado</option>
    </select>
</div>

<div class="form-group">
    <label for="gameRating">Nota</label>
    <input type="number" id="gameRating" step="1" min="0" max="100">
</div>

<div class="form-group">
    <label for="gameHours">Horas de Jogo</label>
    <input type="number" id="gameHours" min="0">
</div>

<div class="form-group">
    <label for="gameTermino">Data de Conclusão</label>
    <input type="date" id="gameTermino">
</div>

<div class="form-group" style="display: none;">
    <label for="gameLink">Link da Capa (URL)</label>
    <input type="url" id="gameLink" placeholder="URL da imagem">
</div>

<div class="form-group" style="display: none;">
    <label for="gameStyle">Estilo (separado por vírgula)</label>
    <input type="text" id="gameStyle" placeholder="Ex: RPG, Aventura">
</div>

<div class="form-group">
    <label for="gamePrice">Preço (R$)</label>
    <input type="text" inputmode="decimal" id="gamePrice" placeholder="Ex: 149,90">
</div>

<div class="form-group">
    <label for="gameConquistas">Conquistas Obtidas</label>
    <input type="number" id="gameConquistas" min="0">
</div>


<button type="submit" id="gameModalSubmitBtn">Salvar Jogo</button>
            </form>
        </div>
    </div>
    
    <div id="gameDetailsModal" class="modal-overlay" onclick="if (event.target === this) closeGameDetailsModal()">
        <div class="game-details-modal-content">
            <span class="close-button" onclick="closeGameDetailsModal()">&times;</span>
            <div class="game-details-header">
                <img id="gameCoverBackground" src="https://i.imgur.com/Z0ebi8o.png" alt="Capa do Jogo">
                <div class="game-details-info">
                    <img id="gameCoverArt" src="https://i.imgur.com/Z0ebi8o.png" alt="Capa do Jogo" class="game-cover-art">
                    <div class="game-details-info-text">
                        <h2 id="gameNameDetails">Nome do Jogo</h2>
                        <p id="gamePlatformDetails">Plataforma</p>
                    </div>
                </div>
            </div>
            <div class="game-details-body">
                <div class="game-details-stats">
                    <div class="game-details-stats-item">
                        <span>Status:</span>
                        <span id="gameStatusDetails"></span>
                    </div>
                    <div class="game-details-stats-item">
                        <span>Nota:</span>
                        <span id="gameRatingDetails"></span>
                    </div>
                    <div class="game-details-stats-item">
                        <span>Horas de Jogo:</span>
                        <span id="gameHoursDetails"></span>
                    </div>
                    <div class="game-details-stats-item">
                        <span>Estilo:</span>
                        <span id="gameStylesDetails"></span>
                    </div>
                    <div class="game-details-stats-item">
                        <span>Metacritic:</span>
                        <span id="gameMetacriticDetails"></span>
                    </div>
                    <div class="game-details-stats-item">
                        <span>Conquistas:</span>
                        <span id="gameAchievementsDetails"></span>
                    </div>
                </div>
                <div class="game-details-description">
                    <h3>Descrição</h3>
                    <p id="gameDescriptionDetails"></p>
                </div>
                <!-- NOVA SEÇÃO: Jogos Similares -->
                <div class="similar-games-section">
                    <h3>Jogos Similares</h3>
                    <div id="similarGamesGrid" class="similar-games-grid">
                        <p class="no-results" id="noSimilarGames">Nenhum jogo similar encontrado.</p>
                    </div>
                </div>
                <div class="game-details-actions">
                    <button class="action-button" id="editGameDetailsBtn"><span class="material-symbols-outlined">edit</span></button>
                    <button class="action-button delete-btn" id="deleteGameDetailsBtn"><span class="material-symbols-outlined">delete</span></button>
                </div>
            </div>
        </div>
    </div>

    <div id="addWishModal" class="modal-overlay">
        <div class="modal-content">
            <span class="close-button" onclick="closeWishModal()">&times;</span>
            <h2 id="wishModalTitle">Adicionar à Lista de Desejos</h2>
            <form id="addWishForm">
            <input type="hidden" id="editWishMode" value="">

            <div class="form-group">
                <label for="wishGameName">Nome do Jogo</label>
                <input type="text" id="wishGameName" required autocomplete="off">
                <div id="wishSearchResultsContainer"></div>
            </div>

            <div class="form-group" style="display: none;">
                <label for="wishGameLink">Link da Capa (URL)</label>
                <input type="url" id="wishGameLink" placeholder="URL da imagem">
            </div>

            <div class="form-group">
                <label for="wishGameRelease">Data Lançamento / Status</label>
                <input type="text" id="wishGameRelease" placeholder="Ex: 2025, Em Breve">
            </div>

            <button type="submit" id="wishModalSubmitBtn">Adicionar à Lista</button>
                        </form>
                    </div>
                </div>

    <div id="wishDetailsModal" class="modal-overlay" onclick="if (event.target === this) closeWishDetailsModal()">
        <div class="game-details-modal-content">
            <span class="close-button" onclick="closeWishDetailsModal()">&times;</span>
            <div class="game-details-header">
                <img id="wishCoverBackground" src="https://i.imgur.com/Z0ebi8o.png" alt="Capa do Jogo">
                <div class="game-details-info">
                    <img id="wishCoverArt" src="https://i.imgur.com/Z0ebi8o.png" alt="Capa do Jogo" class="game-cover-art">
                    <div class="wish-details-info-text">
                        <h2 id="wishNameDetails">Nome do Jogo</h2>
                        <p id="wishReleaseDetails">Data Lançamento</p>
                    </div>
                </div>
            </div>
            <div class="game-details-body">
                <div class="game-details-stats">
                    <div class="game-details-stats-item">
                        <span>Steam Preço Atual:</span>
                        <span id="wishSteamCurrentPrice">N/A</span>
                    </div>
                    <div class="game-details-stats-item">
                        <span>Steam Menor Preço:</span>
                        <span id="wishSteamLowestPrice">N/A</span>
                    </div>
                    <div class="game-details-stats-item">
                        <span>PSN Preço Atual:</span>
                        <span id="wishPsnCurrentPrice">N/A</span>
                    </div>
                    <div class="game-details-stats-item">
                        <span>PSN Menor Preço:</span>
                        <span id="wishPsnLowestPrice">N/A</span>
                    </div>
                    <div class="game-details-stats-item">
                        <span>Última Atualização:</span>
                        <span id="wishLastPriceUpdate">N/A</span>
                    </div>
                    <div class="game-details-stats-item">
                        <span>Status Preço:</span>
                        <span id="wishPriceStatus" class="price-status">N/A</span>
                    </div>
                </div>
                <!-- NOVA SEÇÃO: Histórico de Preços -->
                <div class="price-history-chart-container" id="priceHistoryChartContainer">
                    <h3>Histórico de Preços</h3>
                    <canvas id="priceHistoryChart"></canvas>
                    <p id="noPriceHistory" style="display: none;">Sem dados de histórico de preços para exibir.</p>
                </div>
                <div class="game-details-actions">
                    <button class="action-button" id="purchaseWishDetailsBtn"><span class="material-symbols-outlined">shopping_cart_checkout</span> Marcar como Comprado</button>
                    <button class="action-button" id="editWishDetailsBtn"><span class="material-symbols-outlined">edit</span> Editar</button>
                    <button class="action-button delete-btn" id="deleteWishDetailsBtn"><span class="material-symbols-outlined">delete</span> Excluir</button>
                </div>
            </div>
        </div>
    </div>


    <div id="settingsModal" class="modal-overlay">
        <div class="modal-content">
            <span class="close-button" onclick="closeSettingsModal()">&times;</span>
            <h2>Configurações do Perfil</h2>
            <form id="settingsForm">
                <div class="form-group"><label for="profileNameInput">Nome do Perfil</label><input type="text" id="profileNameInput" required></div>
                <div class="form-group"><label for="profileSubtitleInput">Subtítulo do Perfil</label><input type="text" id="profileSubtitleInput"></div>
                <div class="form-group"><label for="profileAvatarInput">URL da Foto de Perfil</label><input type="url" id="profileAvatarInput"></div>
                <!-- NOVO CAMPO: Fundo do Cabeçalho -->
                <div class="form-group"><label for="profileHeaderBgInput">URL do Fundo do Cabeçalho</label><input type="url" id="profileHeaderBgInput"></div>
                <button type="submit">Salvar Alterações</button>
            </form>
        </div>
    </div>

    <div id="achievementsModal" class="modal-overlay">
        <div class="modal-content">
            <span class="close-button" onclick="closeAchievementsModal()">&times;</span>
            <h2>Conquistas</h2>
            <div class="tabs">
                <button class="tab-button active" onclick="switchAchievementTab(event, 'completed')">Concluídas</button>
                <button class="tab-button" onclick="switchAchievementTab(event, 'pending')">Pendentes</button>
            </div>
            <div id="completed" class="tab-content active">
                <div id="completed-achievements-list" class="achievements-list"></div>
            </div>
            <div id="pending" class="tab-content">
                <div id="pending-achievements-list" class="achievements-list"></div>
            </div>
        </div>
    </div>

    <div id="advancedFiltersModal-graficos" class="modal-overlay">
        <div class="advanced-filters-modal-content">
            <span class="close-button" onclick="toggleAdvancedFiltersModal('-graficos')">&times;</span>
            <h2>Filtros de Gráficos</h2>
            <div class="advanced-filters-grid">
                <div class="filter-group"><label for="nameFilter-graficos">Buscar por Nome</label><input type="search" id="nameFilter-graficos" placeholder="Ex: Elden Ring"></div>
                <div class="filter-group"><label for="statusFilter-graficos">Status</label><select id="statusFilter-graficos"></select></div>
                <div class="filter-group"><label for="styleFilter-graficos">Categoria</label><select id="styleFilter-graficos"></select></div>
                <div class="filter-group"><label for="yearFilter-graficos">Ano de Conclusão</label><select id="yearFilter-graficos"></select></div>
                
                <div class="filter-group"><label for="minRating-graficos">Nota Mínima</label><input type="number" id="minRating-graficos" min="0" max="100" placeholder="0"></div>
                <div class="filter-group"><label for="maxRating-graficos">Nota Máxima</label><input type="number" id="maxRating-graficos" min="0" max="100" placeholder="100"></div>

                <div class="filter-group"><label for="minMetacritic-graficos">Metacritic Mínimo</label><input type="number" id="minMetacritic-graficos" min="0" max="100" placeholder="0"></div>
                <div class="filter-group"><label for="maxMetacritic-graficos">Metacritic Máximo</label><input type="number" id="maxMetacritic-graficos" min="0" max="100" placeholder="100"></div>

                <div class="filter-group"><label for="minPrice-graficos">Preço Mínimo (R$)</label><input type="number" id="minPrice-graficos" step="0.01" min="0" placeholder="0,00"></div>
                <div class="filter-group"><label for="maxPrice-graficos">Preço Máximo (R$)</label><input type="number" id="maxPrice-graficos" step="0.01" min="0" placeholder="999,99"></div>

                <div class="filter-group"><label for="minHours-graficos">Horas de Jogo Mínimas</label><input type="number" id="minHours-graficos" min="0" placeholder="0"></div>
                <div class="filter-group"><label for="maxHours-graficos">Horas de Jogo Máximas</label><input type="number" id="maxHours-graficos" min="0" placeholder="9999"></div>
            </div>
            <div class="filter-modal-actions">
                <button type="button" class="clear-all-filters-btn" onclick="clearAllFilters('-graficos')">Limpar Todos</button>
                <button type="button" class="apply-filters-btn" onclick="applyFilters('-graficos'); toggleAdvancedFiltersModal('-graficos');">Aplicar Filtros</button>
            </div>
        </div>
    </div>

    <div id="advancedFiltersModal-biblioteca" class="modal-overlay">
        <div class="advanced-filters-modal-content">
            <span class="close-button" onclick="toggleAdvancedFiltersModal('-biblioteca')">&times;</span>
            <h2>Filtros da Biblioteca</h2>
            <div class="advanced-filters-grid">
                <div class="filter-group"><label for="nameFilter-biblioteca">Buscar por Nome</label><input type="search" id="nameFilter-biblioteca" placeholder="Ex: The Witcher 3"></div>
                <div class="filter-group"><label for="statusFilter-biblioteca">Status</label><select id="statusFilter-biblioteca"></select></div>
                <div class="filter-group"><label for="styleFilter-biblioteca">Categoria</label><select id="styleFilter-biblioteca"></select></div>
                <div class="filter-group"><label for="yearFilter-biblioteca">Ano de Conclusão</label><select id="yearFilter-biblioteca"></select></div>
                
                <div class="filter-group"><label for="minRating-biblioteca">Nota Mínima</label><input type="number" id="minRating-biblioteca" min="0" max="100" placeholder="0"></div>
                <div class="filter-group"><label for="maxRating-biblioteca">Nota Máxima</label><input type="number" id="maxRating-biblioteca" min="0" max="100" placeholder="100"></div>

                <div class="filter-group"><label for="minMetacritic-biblioteca">Metacritic Mínimo</label><input type="number" id="minMetacritic-biblioteca" min="0" max="100" placeholder="0"></div>
                <div class="filter-group"><label for="maxMetacritic-biblioteca">Metacritic Máximo</label><input type="number" id="maxMetacritic-biblioteca" min="0" max="100" placeholder="100"></div>

                <div class="filter-group"><label for="minPrice-biblioteca">Preço Mínimo (R$)</label><input type="number" id="minPrice-biblioteca" step="0.01" min="0" placeholder="0,00"></div>
                <div class="filter-group"><label for="maxPrice-biblioteca">Preço Máximo (R$)</label><input type="number" id="maxPrice-biblioteca" step="0.01" min="0" placeholder="999,99"></div>

                <div class="filter-group"><label for="minHours-biblioteca">Horas de Jogo Mínimas</label><input type="number" id="minHours-biblioteca" min="0" placeholder="0"></div>
                <div class="filter-group"><label for="maxHours-biblioteca">Horas de Jogo Máximas</label><input type="number" id="maxHours-biblioteca" min="0" placeholder="9999"></div>
            </div>
            <div class="filter-modal-actions">
                <button type="button" class="clear-all-filters-btn" onclick="clearAllFilters('-biblioteca')">Limpar Todos</button>
                <button type="button" class="apply-filters-btn" onclick="applyFilters('-biblioteca'); toggleAdvancedFiltersModal('-biblioteca');">Aplicar Filtros</button>
            </div>
        </div>
    </div>

    <div id="advancedFiltersModal-desejos" class="modal-overlay">
        <div class="advanced-filters-modal-content">
            <span class="close-button" onclick="toggleAdvancedFiltersModal('-desejos')">&times;</span>
            <h2>Filtros da Lista de Desejos</h2>
            <div class="advanced-filters-grid">
                <div class="filter-group"><label for="nameFilter-desejos">Buscar por Nome</label><input type="search" id="nameFilter-desejos" placeholder="Ex: Hollow Knight Silksong"></div>
                
                <div class="filter-group"><label for="minSteamPrice-desejos">Steam Preço Atual Mínimo (R$)</label><input type="number" id="minSteamPrice-desejos" step="0.01" min="0" placeholder="0,00"></div>
                <div class="filter-group"><label for="maxSteamPrice-desejos">Steam Preço Atual Máximo (R$)</label><input type="number" id="maxSteamPrice-desejos" step="0.01" min="0" placeholder="999,99"></div>

                <div class="filter-group"><label for="minPsnPrice-desejos">PSN Preço Atual Mínimo (R$)</label><input type="number" id="minPsnPrice-desejos" step="0.01" min="0" placeholder="0,00"></div>
                <div class="filter-group"><label for="maxPsnPrice-desejos">PSN Preço Atual Máximo (R$)</label><input type="number" id="maxPsnPrice-desejos" step="0.01" min="0" placeholder="999,99"></div>

                <div class="filter-group"><label for="releaseYearFilter-desejos">Ano de Lançamento</label><select id="releaseYearFilter-desejos"></select></div>

            </div>
            <div class="filter-modal-actions">
                <button type="button" class="clear-all-filters-btn" onclick="clearAllFilters('-desejos')">Limpar Todos</button>
                <button type="button" class="apply-filters-btn" onclick="applyFilters('-desejos'); toggleAdvancedFiltersModal('-desejos');">Aplicar Filtros</button>
            </div>
        </div>
    </div>

    <div id="notificationsModal" class="modal-overlay">
        <div class="modal-content">
            <span class="close-button" onclick="closeNotificationsModal()">&times;</span>
            <h2>Suas Notificações</h2>
            <div class="tabs">
                <button class="tab-button active" data-tab="unread" onclick="switchNotificationTab(event, 'unread')">Não Lidas</button>
                <button class="tab-button" data-tab="read" onclick="switchNotificationTab(event, 'read')">Lidas</button>
            </div>
            <div id="unread" class="tab-content active notifications-list-container">
                <div id="unread-notifications-list">
                    <p class="no-results">Nenhuma notificação não lida por enquanto!</p>
                </div>
            </div>
            <div id="read" class="tab-content notifications-list-container">
                <div id="read-notifications-list">
                    <p class="no-results">Nenhuma notificação lida por enquanto!</p>
                </div>
            </div>
            <button class="mark-all-read-btn" onclick="markAllNotificationsAsRead()">Marcar todas como lidas</button>
        </div>
    </div>

    <!-- NOVO MODAL: Sincronizar Biblioteca Steam -->
    <div id="syncModal" class="modal-overlay">
        <div class="modal-content">
            <span class="close-button" onclick="closeSyncModal()">&times;</span>
            <h2>Sincronizar Biblioteca Steam</h2>
            <form id="syncForm">
                <div class="form-group">
                    <label for="steamIdInput">Steam ID (Ex: 76561198123456789)</label>
                    <input type="text" id="steamIdInput" placeholder="Insira seu Steam ID" required>
                </div>
                <button type="button" id="previewSteamBtn">Pré-visualizar Jogos</button>
            </form>
            <div id="steamPreviewContainer">
                <div class="steam-sync-status" id="steamSyncStatus"></div>
                <div id="newGamesPreview" class="steam-preview-grid" style="display: none;">
                    <h3 class="steam-game-category">Novos Jogos</h3>
                </div>
                <div id="existingGamesPreview" class="steam-preview-grid" style="display: none;">
                    <h3 class="steam-game-category">Jogos Existentes (Atualizar)</h3>
                </div>
                <button type="button" id="syncSelectedGamesBtn" style="display: none;">Sincronizar Selecionados</button>
            </div>
        </div>
    </div>

    <!-- NOVO MODAL: Sortear Jogo -->
    <div id="randomGameModal" class="modal-overlay">
        <div class="modal-content">
            <span class="close-button" onclick="closeRandomGameModal()">&times;</span>
            <h2>Sortear Jogo</h2>
            <form id="randomGameForm">
                <div class="random-game-filters">
                    <div class="filter-group">
                        <label for="randomPlatform">Plataforma</label>
                        <select id="randomPlatform">
                            <option value="all">Todas</option>
                            <!-- Opções preenchidas dinamicamente -->
                        </select>
                    </div>
                    <div class="filter-group">
                        <label for="randomStyle">Estilo</label>
                        <select id="randomStyle">
                            <option value="all">Todos</option>
                            <!-- Opções preenchidas dinamicamente -->
                        </select>
                    </div>
                    <div class="filter-group">
                        <label for="randomMinMetacritic">Metacritic Mínimo</label>
                        <input type="number" id="randomMinMetacritic" min="0" max="100" placeholder="0">
                    </div>
                    <div class="filter-group">
                        <label for="randomMaxMetacritic">Metacritic Máximo</label>
                        <input type="number" id="randomMaxMetacritic" min="0" max="100" placeholder="100">
                    </div>
                </div>
                <button type="submit">Sortear Jogo!</button>
            </form>
            <p id="randomGameResult" style="display: none;"></p>
        </div>
    </div>


<script>
    console.log("Script loaded and starting execution."); // Very early log

        // --- VARIÁVEIS GLOBAIS ---
        const API_URL = 'https://api-jogos-nrma.onrender.com/api';
        // Cores ajustadas para tons de roxo e cinza
        const chartColors = {
            purple: '#9370db',        // Roxo normal
            darkPurple: '#6a4a9c',    // Roxo escuro
            lightPurple: '#b89ceb',   // Roxo claro
            grey: '#7d8590',          // Cinza normal
            darkGrey: '#4a5057',      // Cinza escuro
            lightGrey: '#a5acb4'      // Cinza claro
        };
        let fullData = { estatisticas: {}, biblioteca: [], desejos: [], perfil: {}, conquistas_concluidas: [], conquistas_pendentes: [] };
        let createdCharts = {};
        let currentSortKey = 'Nome';
        let currentSortDirection = 'asc';
        const token = localStorage.getItem('jwt_token');
        if (!token) { window.location.href = 'login.html'; }

        let searchTimeout;
        let wishSearchTimeout;
        let notificationInterval; // Variável para armazenar o ID do intervalo das notificações
        let isInitialLoad = true; // Flag para controlar a tela de carregamento inicial
        let allNotifications = []; // Armazena todas as notificações buscadas
        let priceHistoryChart = null; // Variável para o gráfico de histórico de preços

        // --- DEFINIÇÃO DE TODAS AS FUNÇÕES ---

        function showToast(message, isError = false) {
            Toastify({
                text: message, duration: 3000, gravity: "top", position: "right", stopOnFocus: true,
                style: {
                    background: isError 
                        ? "linear-gradient(to right, #cb2d3e, #ef473a)" 
                        : "linear-gradient(to right, var(--accent-purple), #2a5298)"
                },
            }).showToast();
        }

        async function fetchGameData() {
            console.log('fetchGameData: Starting...'); // Log 1
            try {
                const loadingScreen = document.getElementById('loading-screen');
                if (isInitialLoad && loadingScreen) { // Só mostra a tela de carregamento na carga inicial
                    loadingScreen.classList.remove('hidden');
                    console.log('fetchGameData: Loading screen shown.'); // Log after showing
                }

                const response = await fetch(`${API_URL}/games/data`, { headers: { 'Authorization': `Bearer ${token}` } });
                if (response.status === 401) {
                    localStorage.removeItem('jwt_token');
                    window.location.href = 'login.html';
                    return;
                }
                if (!response.ok) throw new Error(`HTTP error! status: ${response.status}`);
                fullData = await response.json();
                console.log('fetchGameData: Data fetched successfully.'); // Log 2
                console.log('fullData after fetch:', fullData); // <--- ADDED LOG
                
                try {
                    await renderAllPages(); // Await renderAllPages as it calls fetchNotifications (async)
                    console.log('fetchGameData: renderAllPages completed.'); // Log after rendering
                } catch (renderErr) {
                    console.error('Erro durante a renderização da página:', renderErr);
                    document.body.innerHTML = `<p style="color: white; text-align: center; padding-top: 50px;">Erro ao renderizar os dados.</p>`;
                }

            } catch (err) {
                console.error('Erro ao buscar dados da API:', err);
                document.body.innerHTML = `<p style="color: white; text-align: center; padding-top: 50px;">Erro ao carregar os dados.</p>`;
            } finally {
                console.log('fetchGameData: Entering finally block. isInitialLoad:', isInitialLoad); // New log
                const loadingScreen = document.getElementById('loading-screen');
                if (isInitialLoad && loadingScreen) { // Só esconde a tela de carregamento na carga inicial
                    loadingScreen.classList.add('hidden');
                    console.log('fetchGameData: Loading screen hidden.'); // Log 5
                    isInitialLoad = false; // Desativa a flag após o primeiro carregamento
                }
            }
        }
        
        async function renderAllPages() { // Make it async
            console.log('renderAllPages: Starting...'); // Log 3
            try { // Add try-catch here for rendering errors
                loadProfileSettings(fullData.perfil);
                renderGamerCard(fullData.estatisticas);
                renderSummaryCards(fullData.estatisticas, 'summary');
                renderRecentPlatinums(fullData.biblioteca);
                renderWishlist(fullData.desejos);
                renderAchievements(fullData.conquistas_concluidas, fullData.conquistas_pendentes);
                populateFilters();
                applyFilters('-graficos');
                applyFilters('-biblioteca');
                applyFilters('-desejos'); // Aplicar filtros da lista de desejos
                updateLastWishlistUpdate(fullData.desejos); // Atualizar data de última atualização
                await fetchNotifications(); // Await fetchNotifications
                console.log('renderAllPages: Finished.'); // Log 4
            } catch (renderError) {
                console.error('Erro dentro de renderAllPages:', renderError);
                throw renderError; // Re-throw to be caught by fetchGameData's outer catch
            }
        }

        function openPage(evt, pageName) {
            document.querySelectorAll('.page').forEach(p => p.classList.remove('active'));
            document.querySelectorAll('.nav-button').forEach(b => b.classList.remove('active'));
            document.getElementById(pageName).classList.add('active');
            evt.currentTarget.classList.add('active');
        }

        function renderGamerCard(stats = {}) {
            const rank = stats.rank_gamer || 'Bronze'; const rankClass = `rank-${rank}`;
            const mainContent = document.getElementById('main-content'); mainContent.className = 'main-content'; mainContent.classList.add(`rank-colors-${rank}`);
            document.getElementById('levelDisplay').textContent = `${rank} (Nível ${stats.nivel_gamer || 0})`;
            document.getElementById('expText').textContent = `${(stats.exp_nivel_atual || 0).toLocaleString('pt-BR')} / ${(stats.exp_para_proximo_nivel || 1000).toLocaleString('pt-BR')} EXP`;
            const expBar = document.getElementById('expBar'); expBar.className = 'exp-bar-progress';
            setTimeout(() => {
                expBar.style.width = `${((stats.exp_nivel_atual || 0) / (stats.exp_para_proximo_nivel || 1000)) * 100}%`;
                expBar.classList.add(rankClass);
            }, 100);
            const gamerName = document.getElementById('gamerName'); gamerName.className = ''; gamerName.classList.add(rankClass);
        }

        function renderSummaryCards(stats = {}, containerId) {
            const container = document.getElementById(containerId); if (!container) return;
            const formatCurrency = (val) => (val || 0).toLocaleString('pt-BR', { style: 'currency', currency: 'BRL' });
            const cards = [
                { t: 'Total de Jogos', v: stats.total_jogos || 0, i: 'sports_esports' }, { t: 'Horas Jogadas', v: `${(stats.total_horas_jogadas || 0).toLocaleString('pt-BR')}h`, i: 'timer' },
                { t: 'Custo Total', v: formatCurrency(stats.custo_total_biblioteca), i: 'shopping_cart' }, 
                // Correção: Garante que media_notas seja um número antes de chamar toFixed
                { t: 'Média das Notas', v: typeof stats.media_notas === 'number' ? stats.media_notas.toFixed(2) : 'N/A', i: 'star' },
                { t: 'Platinados', v: stats.total_platinados || 0, i: 'emoji_events' }, { t: 'Conquistas', v: stats.total_conquistas || 0, i: 'military_tech' }
            ];
            container.innerHTML = cards.map(c => `<div class="card"><div class="card-header"><span class="material-symbols-outlined">${c.i}</span><span>${c.t}</span></div><p class="card-content">${c.v}</p></div>`).join('');
        }

        function renderRecentPlatinums(library = []) {
            const container = document.getElementById('recent-platinums');
            if (!container) return;
            const platinados = library.filter(g => g['Platinado?'] === 'Sim' && g.Link)
                                      .sort((a, b) => new Date(b['Terminado em']) - new Date(a['Terminado em']))
                                      .slice(0, 5);
            if (platinados.length === 0) {
                container.innerHTML = `<p style="color: var(--secondary-text); grid-column: 1 / -1;">Nenhum jogo platinado com imagem encontrada.</p>`;
                return;
            }
            container.innerHTML = platinados.map(game => {
                let dataPlatina = 'Data não informada';
                if (game['Terminado em']) {
                    dataPlatina = new Date(game['Terminado em']).toLocaleDateString('pt-BR', {
                        day: '2-digit', month: '2-digit', year: 'numeric'
                    });
                }
                return `
                    <div class="platinum-card" title="${game.Nome}">
                        <img src="${game.Link}" alt="${game.Nome}">
                        <div class="platinum-overlay"></div>
                        <div class="platinum-info">
                            <span class="material-symbols-outlined platinum-trophy">emoji_events</span>
                            <div class="platinum-details">
                                <span class="platinum-title">${game.Nome}</span>
                                <span class="platinum-date">${dataPlatina}</span>
                            </div>
                        </div>
                    </div>
                `;
            }).join('');
        }
        
        function renderGameTable(games = []) {
            const tbody = document.getElementById('game-list-tbody');
            const noResults = document.getElementById('no-results-message');
            const tableContainer = document.querySelector('#biblioteca .table-container');

            if (!tbody || !noResults || !tableContainer) return;

            tbody.innerHTML = '';
            
            if (games.length === 0) {
                tableContainer.style.display = 'none';
                noResults.style.display = 'block';
                return;
            }

            noResults.style.display = 'none';
            
            games.forEach(game => {
                const isPlatinado = game['Platinado?'] === 'Sim';
                const safeName = game.Nome.replace(/'/g, "\\'");
                tbody.innerHTML += `
                    <tr class="${isPlatinado ? 'platinado-row' : ''}" onclick="openGameDetailsModal('${safeName}')" style="cursor: pointer;">
                        <td><div class="game-name-cell">${isPlatinado ? '<span class="material-symbols-outlined trophy-icon">emoji_events</span>' : '<span style="width: 22px;"></span>'}<span>${game.Nome}</span></div></td>
                        <td>${game.Plataforma || '-'}</td>
                        <td>${game.Status || '-'}</td>
                        <td class="nota-cell">${game.Nota || '-'}</td>
                        <td>${game['Tempo de Jogo'] || 0}h</td>
                        <td><div class="action-buttons">
                            <button class="action-button" onclick="event.stopPropagation(); editGame('${safeName}')"><span class="material-symbols-outlined">edit</span></button>
                            <button class="action-button" onclick="event.stopPropagation(); deleteGame('${safeName}')"><span class="material-symbols-outlined">delete</span></button>
                        </div></td>
                    </tr>`;
            });
        }
        
        function renderGameGrid(games = []) {
            const gridContainer = document.getElementById('game-grid-container');
            if (!gridContainer) return;

            if (games.length === 0) {
                gridContainer.innerHTML = '';
                return;
            }

            gridContainer.innerHTML = games.map(game => {
                const safeName = game.Nome.replace(/'/g, "\\'");
                const plataforma = game.Plataforma || '-';
                const tempoDeJogo = game['Tempo de Jogo'] || 0;
                
                const trophyIconHTML = game['Platinado?'] === 'Sim' 
                    ? `<span class="material-symbols-outlined game-card-trophy">emoji_events</span>`
                    : '';

                return `
                    <div class="game-card-grid" onclick="openGameDetailsModal('${safeName}')" title="${safeName}">
                        <img src="${game.Link}" alt="${safeName}">
                        ${trophyIconHTML}
                        <div class="game-card-content">
                            <div class="game-card-top-details">
                                <span class="detail-item">
                                    <span class="material-symbols-outlined">stadia_controller</span>
                                    ${plataforma}
                                </span>
                                <span class="detail-item">
                                    <span class="material-symbols-outlined">timer</span>
                                    ${tempoDeJogo}h
                                </span>
                            </div>
                            <div class="game-title">${game.Nome}</div>
                        </div>
                    </div>
                `;
            }).join('');
        }

        function formatCurrency(val) {
            const num = parseFloat(String(val).replace(',', '.')) || 0;
            return num.toLocaleString('pt-BR', { style: 'currency', currency: 'BRL' });
        }

        // NOVO: Função para determinar o status do preço
        function getPriceStatus(steamCurrent, steamLowest, psnCurrent, psnLowest) {
            const currentSteam = parseFloat(String(steamCurrent).replace(',', '.')) || Infinity;
            const lowestSteam = parseFloat(String(steamLowest).replace(',', '.')) || Infinity;
            const currentPsn = parseFloat(String(psnCurrent).replace(',', '.')) || Infinity;
            const lowestPsn = parseFloat(String(psnLowest).replace(',', '.')) || Infinity;

            const threshold = 0.15; // 15% acima do menor preço histórico

            if (currentSteam <= lowestSteam || currentPsn <= lowestPsn) {
                return { status: 'Bom', class: 'bom' };
            } else if (currentSteam <= lowestSteam * (1 + threshold) || currentPsn <= lowestPsn * (1 + threshold)) {
                return { status: 'Normal', class: 'normal' };
            }
            return { status: 'Ruim', class: 'ruim' };
        }

        function renderWishlist(wishlist = []) {
            const container = document.getElementById('wishlist-container'); 
            const noResults = document.getElementById('no-wishlist-results-message');
            if (!container || !noResults) return;

            if (wishlist.length === 0) { 
                container.innerHTML = ''; 
                noResults.style.display = 'block';
                return; 
            }
            noResults.style.display = 'none';

            container.innerHTML = wishlist.map(game => {
                const safeName = game.Nome.replace(/'/g, "\\'");
                // Acessa as propriedades diretamente, sem .get()
                const steamCurrent = game['Steam Preco Atual'] || 'N/A';
                const psnCurrent = game['PSN Preco Atual'] || 'N/A'; 
                const steamLowest = game['Steam Menor Preco Historico'] || 'N/A';
                const psnLowest = game['PSN Menor Preco Historico'] || 'N/A'; 

                const priceStatus = getPriceStatus(steamCurrent, steamLowest, psnCurrent, psnLowest);

                return `
                <div class="wish-card" onclick="openWishDetailsModal('${safeName}')">
                    <img src="${game.Link || 'https://placehold.co/180x180/21262d/e6edf3?text=Sem+Capa'}" class="wish-card-img" alt="${safeName}">
                    <div class="wish-card-info">
                        <h3 class="wish-card-title">${game.Nome}</h3>
                        <div class="wish-card-details">
                            <div class="wish-card-price-row">
                                <span>Steam:</span>
                                <span class="wish-card-price">${formatCurrency(steamCurrent)}</span>
                            </div>
                            <div class="wish-card-price-row">
                                <span>PSN:</span>
                                <span class="wish-card-price">${formatCurrency(psnCurrent)}</span>
                            </div>
                            <div class="wish-card-price-row" style="margin-top: 8px;">
                                <span>Status:</span>
                                <span class="price-status ${priceStatus.class}">${priceStatus.status}</span>
                            </div>
                        </div>
                    </div>
                </div>`;
            }).join('');
        }

        // NOVO: Função para atualizar a data da última atualização da wishlist
        function updateLastWishlistUpdate(wishlist = []) {
            const lastUpdateElement = document.getElementById('lastWishlistUpdate');
            if (!lastUpdateElement) return;

            let latestDate = null;

            wishlist.forEach(item => {
                const updateDateStr = item['Ultima Atualizacao']; // Acessa diretamente
                if (updateDateStr) {
                    try {
                        // Verifica se a string de data contém 'T' (formato ISO) ou ' ' (formato customizado)
                        let itemDate;
                        if (updateDateStr.includes('T')) { // Ex: "2025-08-23T20:58:44"
                            itemDate = new Date(updateDateStr);
                        } else if (updateDateStr.includes(' ')) { // Ex: "2025-08-23 20:58:44"
                            const [datePart, timePart] = updateDateStr.split(' ');
                            const [year, month, day] = datePart.split('-');
                            const [hour, minute, second] = timePart.split(':');
                            itemDate = new Date(year, month - 1, day, hour, minute, second);
                        } else {
                            // Se não for nenhum dos formatos esperados, tenta como data simples
                            itemDate = new Date(updateDateStr);
                        }
                        
                        if (!latestDate || itemDate > latestDate) {
                            latestDate = itemDate;
                        }
                    } catch (e) {
                        console.warn("Erro ao parsear data de atualização da wishlist:", updateDateStr, e);
                    }
                }
            });

            if (latestDate && !isNaN(latestDate)) { // Verifica se a data é válida
                lastUpdateElement.textContent = `Última atualização: ${latestDate.toLocaleDateString('pt-BR')} ${latestDate.toLocaleTimeString('pt-BR')}`;
            } else {
                lastUpdateElement.textContent = 'Última atualização: N/A';
            }
        }


        function renderAchievements(completed = [], pending = []) {
            const completedContainer = document.getElementById('completed-achievements-list');
            const pendingContainer = document.getElementById('pending-achievements-list');
            const mainContainer = document.getElementById('achievements-container');
            if (!completedContainer || !pendingContainer || !mainContainer) return;
            const createAchievementHTML = (ach, isCompleted) => {
                const progressPercent = ach.meta > 0 ? (ach.progresso_atual / ach.meta) * 100 : 100;
                return `<div class="achievement-card ${isCompleted ? 'completed' : ''}"><div class="achievement-icon tier-${ach.Tier || 'default'}"><span class="material-symbols-outlined">${ach.Icone || 'star'}</span></div><div class="achievement-details"><h3>${ach.Nome}</h3><p>${ach.Descricao}</p>${isCompleted ? `<p class="exp-reward">+${ach.EXP} EXP</p>` : `<div class="achievement-progress-bar-container"><div class="achievement-progress-bar" style="width: ${progressPercent}%;"></div></div><p class="achievement-progress-text">${Math.floor(ach.progresso_atual)} / ${ach.meta}</p>`}</div></div>`;
            };
            completedContainer.innerHTML = completed.length > 0 ? completed.map(ach => createAchievementHTML(ach, true)).join('') : `<p>Nenhuma conquista concluída.</p>`;
            pendingContainer.innerHTML = pending.length > 0 ? pending.map(ach => createAchievementHTML(ach, false)).join('') : `<p>Todas as conquistas foram concluídas!</p>`;
            mainContainer.innerHTML = completed.map(ach => createAchievementHTML(ach, true)).join('');
        }

        function destroyCharts() { Object.values(createdCharts).forEach(chart => chart.destroy()); createdCharts = {}; }
        
        function renderAllCharts(games = []) {
            destroyCharts();
            const processData = (key) => games.reduce((acc, game) => { const v = game[key] || 'N/A'; acc[v] = (acc[v] || 0) + 1; return acc; }, {});
            const processMultiData = (key) => games.reduce((acc, game) => { if(game[key]) game[key].split(',').forEach(item => { const t = item.trim(); acc[t] = (acc[t] || 0) + 1; }); return acc; }, {});
            const platinadosData = { 'Platinados': games.filter(g => g['Platinado?'] === 'Sim').length, 'Outros': games.filter(g => g['Platinado?'] !== 'Sim').length };
            const platformData = processData('Plataforma'); const statusData = processData('Status');
            const styleData = Object.entries(processMultiData('Estilo')).sort(([,a],[,b]) => b-a).slice(0,5).reduce((r, [k,v]) => ({...r, [k]: v}), {});
            if(document.getElementById('platinadosChart')) createdCharts.platinados = new Chart('platinadosChart', { type: 'pie', data: { labels: Object.keys(platinadosData), datasets: [{ data: Object.values(platinadosData), backgroundColor: [chartColors.purple, chartColors.lightPurple], borderColor: '#161b22', borderWidth: 4 }] }, options: { responsive: true, maintainAspectRatio: false, plugins: { legend: { position: 'top' }}} });
            if(document.getElementById('platformChart')) createdCharts.platform = new Chart('platformChart', { type: 'bar', data: { labels: Object.keys(platformData), datasets: [{ data: Object.values(platformData), backgroundColor: chartColors.purple, borderRadius: 4 }] }, options: { responsive: true, maintainAspectRatio: false, scales: { y: { beginAtZero: true, ticks: { stepSize: 1 }}}, plugins: { legend: { display: false }}} });
            // Usando as novas cores de roxo e cinza para o gráfico de status
            if(document.getElementById('statusChart')) createdCharts.status = new Chart('statusChart', { type: 'doughnut', data: { labels: Object.keys(statusData), datasets: [{ data: Object.values(statusData), backgroundColor: [chartColors.lightPurple, chartColors.purple, chartColors.darkPurple, chartColors.lightGrey, chartColors.grey, chartColors.darkGrey], borderColor: '#161b22', borderWidth: 4 }] }, options: { responsive: true, maintainAspectRatio: false, plugins: { legend: { position: 'top' }}} });
            if(document.getElementById('styleChart')) createdCharts.style = new Chart('styleChart', { type: 'bar', data: { labels: Object.keys(styleData), datasets: [{ data: Object.values(styleData), backgroundColor: chartColors.purple, borderRadius: 4 }] }, options: { indexAxis: 'y', responsive: true, maintainAspectRatio: false, plugins: { legend: { display: false }}} });
        }
        
        function populateFilters() {
            const library = fullData.biblioteca || [];
            const statuses = [...new Set(library.map(g => g.Status).filter(Boolean))].sort();
            const styles = [...new Set(library.flatMap(g => g.Estilo ? g.Estilo.split(',').map(s => s.trim()) : []).filter(Boolean))].sort();
            const years = [...new Set(library.map(g => g['Terminado em'] ? new Date(g['Terminado em']).getFullYear() : null).filter(Boolean))].sort((a,b) => b-a);
            
            const wishlist = fullData.desejos || [];
            const wishYears = [...new Set(wishlist.map(w => {
                const dateStr = w['Data Lançamento'];
                if (!dateStr || dateStr.toLowerCase().includes('em breve')) return null;
                // Tenta parsear DD/MM/YYYY
                if (dateStr.includes('/')) {
                    const parts = dateStr.split('/');
                    if (parts.length === 3) return parseInt(parts[2]);
                }
                // Tenta parsear YYYY-MM-DD
                if (dateStr.includes('-')) {
                    const parts = dateStr.split('-');
                    if (parts.length === 3) return parseInt(parts[0]);
                }
                return null;
            }).filter(Boolean))].sort((a,b) => b-a);


            const populate = (elId, items) => { 
                const select = document.getElementById(elId); 
                if (!select) return; 
                select.innerHTML = '<option value="all">Todos</option>'; 
                items.forEach(item => select.innerHTML += `<option value="${item}">${item}</option>`); 
            }
            
            // Popula filtros para todas as seções
            const suffixes = ['-graficos', '-biblioteca', '-desejos'];
            suffixes.forEach(suffix => {
                // Filtros da biblioteca e gráficos
                if (suffix !== '-desejos') {
                    populate('statusFilter' + suffix, statuses); 
                    populate('styleFilter' + suffix, styles); 
                    populate('yearFilter' + suffix, years);
                } else { // Filtros da lista de desejos
                    populate('releaseYearFilter' + suffix, wishYears);
                }
            });

            // Popula filtros para o modal de sorteio de jogo
            populate('randomPlatform', [...new Set(library.map(g => g.Plataforma).filter(Boolean))].sort());
            populate('randomStyle', [...new Set(library.flatMap(g => g.Estilo ? g.Estilo.split(',').map(s => s.trim()) : []).filter(Boolean))].sort());
        }
        
        function applyFilters(suffix) {
            const name = document.getElementById('nameFilter' + suffix)?.value.toLowerCase() || '';
            
            let filteredItems = [];

            if (suffix === '-desejos') {
                // REMOVIDO: minWishPrice e maxWishPrice
                const minSteamPrice = parseFloat(document.getElementById('minSteamPrice' + suffix)?.value) || 0;
                const maxSteamPrice = parseFloat(document.getElementById('maxSteamPrice' + suffix)?.value) || Infinity;
                const minPsnPrice = parseFloat(document.getElementById('minPsnPrice' + suffix)?.value) || 0;
                const maxPsnPrice = parseFloat(document.getElementById('maxPsnPrice' + suffix)?.value) || Infinity;
                const releaseYear = document.getElementById('releaseYearFilter' + suffix)?.value || 'all';

                filteredItems = (fullData.desejos || []).filter(w => {
                    const wishName = w.Nome.toLowerCase();
                    // REMOVIDO: wishPrice
                    const steamCurrentPrice = parseFloat(String(w['Steam Preco Atual'] || '0').replace(',', '.')) || 0;
                    const psnCurrentPrice = parseFloat(String(w['PSN Preco Atual'] || '0').replace(',', '.')) || 0;
                    const wishReleaseDateStr = w['Data Lançamento'];
                    let wishReleaseYear = null;
                    if (wishReleaseDateStr && !wishReleaseDateStr.toLowerCase().includes('em breve')) {
                        if (wishReleaseDateStr.includes('/')) { // DD/MM/YYYY
                            wishReleaseYear = parseInt(wishReleaseDateStr.split('/')[2]);
                        } else if (wishReleaseDateStr.includes('-')) { // YYYY-MM-DD
                            wishReleaseYear = parseInt(wishReleaseDateStr.split('-')[0]);
                        }
                    }

                    const nameMatch = name ? wishName.includes(name) : true;
                    // REMOVIDO: priceMatch
                    const steamPriceMatch = (steamCurrentPrice >= minSteamPrice && steamCurrentPrice <= maxSteamPrice);
                    const psnPriceMatch = (psnCurrentPrice >= minPsnPrice && psnCurrentPrice <= maxPsnPrice);
                    const releaseYearMatch = releaseYear !== 'all' ? wishReleaseYear == releaseYear : true;

                    // DEBUGGING LOGS for wishlist filters
                    console.log('Filtering Wishlist Item:', w.Nome);
                    console.log('  Filter Values:', { name, minSteamPrice, maxSteamPrice, minPsnPrice, maxPsnPrice, releaseYear });
                    console.log('  Item Values:', { wishName, steamCurrentPrice, psnCurrentPrice, wishReleaseYear });
                    console.log('  Matches:', { nameMatch, steamPriceMatch, psnPriceMatch, releaseYearMatch });
                    console.log('  Overall Match:', nameMatch && steamPriceMatch && psnPriceMatch && releaseYearMatch);


                    return nameMatch && steamPriceMatch && psnPriceMatch && releaseYearMatch; // Ajustado para remover priceMatch
                });
                renderWishlist(filteredItems);
            } else { // Filtros para gráficos e biblioteca
                const status = document.getElementById('statusFilter' + suffix)?.value || 'all';
                const style = document.getElementById('styleFilter' + suffix)?.value || 'all';
                const year = document.getElementById('yearFilter' + suffix)?.value || 'all';
                
                const minRating = parseFloat(document.getElementById('minRating' + suffix)?.value) || 0;
                const maxRating = parseFloat(document.getElementById('maxRating' + suffix)?.value) || 100;
                const minMetacritic = parseFloat(document.getElementById('minMetacritic' + suffix)?.value) || 0;
                const maxMetacritic = parseFloat(document.getElementById('maxMetacritic' + suffix)?.value) || 100;
                const minPrice = parseFloat(document.getElementById('minPrice' + suffix)?.value) || 0;
                const maxPrice = parseFloat(document.getElementById('maxPrice' + suffix)?.value) || Infinity;
                const minHours = parseFloat(document.getElementById('minHours' + suffix)?.value) || 0;
                const maxHours = parseFloat(document.getElementById('maxHours' + suffix)?.value) || Infinity;


                filteredItems = (fullData.biblioteca || []).filter(g => {
                    const gameName = g.Nome.toLowerCase();
                    const gameStatus = g.Status;
                    const gameStyles = g.Estilo ? g.Estilo.split(',').map(s => s.trim()) : [];
                    const gameYear = g['Terminado em'] ? new Date(g['Terminado em']).getFullYear() : null;
                    const gameRating = parseFloat(g.Nota) || 0;
                    const gameMetacritic = parseFloat(g.Metacritic) || 0;
                    const gamePrice = parseFloat(String(g.Preço).replace(',', '.')) || 0;
                    const gameHours = parseInt(g['Tempo de Jogo']) || 0;


                    const nameMatch = name ? gameName.includes(name) : true;
                    const statusMatch = status !== 'all' ? gameStatus === status : true;
                    const styleMatch = style !== 'all' ? gameStyles.includes(style) : true;
                    const yearMatch = year !== 'all' ? gameYear == year : true;
                    
                    const ratingMatch = (gameRating >= minRating && gameRating <= maxRating);
                    const metacriticMatch = (gameMetacritic >= minMetacritic && gameMetacritic <= maxMetacritic);
                    const priceMatch = (gamePrice >= minPrice && gamePrice <= maxPrice);
                    const hoursMatch = (gameHours >= minHours && gameHours <= maxHours);

                    return nameMatch && statusMatch && styleMatch && yearMatch &&
                           ratingMatch && metacriticMatch && priceMatch && hoursMatch;
                });
            }


            if (suffix === '-graficos') {
                const notas = filteredItems.map(g => g.Nota).filter(n => n && !isNaN(n));
                const stats = {
                    total_jogos: filteredItems.length,
                    total_horas_jogadas: filteredItems.reduce((sum, g) => sum + (parseInt(g['Tempo de Jogo']) || 0), 0),
                    custo_total_biblioteca: filteredItems.reduce((sum, g) => sum + (parseFloat(String(g.Preço).replace(',','.')) || 0), 0),
                    // Correção: Garante que media_notas seja um número
                    media_notas: notas.length > 0 ? (notas.reduce((a,b) => parseFloat(a)+parseFloat(b), 0) / notas.length) : 0,
                    total_platinados: filteredItems.filter(g => g['Platinado?'] === 'Sim').length,
                    total_conquistas: filteredItems.reduce((sum, g) => sum + (parseInt(g['Conquistas Obtidas']) || 0), 0)
                };
                renderSummaryCards(stats, 'summary-graficos');
                renderAllCharts(filteredItems);
            } else if (suffix === '-biblioteca') {
                renderGameTable(filteredItems);
                renderGameGrid(filteredItems);
            }
            // A renderização da wishlist já está dentro do if (suffix === '-desejos')
        }

        // Função para alternar a visibilidade do modal de filtros avançados
        function toggleAdvancedFiltersModal(suffix) {
            const modal = document.getElementById('advancedFiltersModal' + suffix);
            if (modal) {
                modal.classList.toggle('active');
            }
        }

        // Função para limpar todos os filtros no modal
        function clearAllFilters(suffix) {
            document.getElementById('nameFilter' + suffix).value = '';
            
            if (suffix === '-desejos') {
                // REMOVIDO: minWishPrice e maxWishPrice
                // document.getElementById('minWishPrice' + suffix).value = '';
                // document.getElementById('maxWishPrice' + suffix).value = '';
                document.getElementById('minSteamPrice' + suffix).value = '';
                document.getElementById('maxSteamPrice' + suffix).value = '';
                document.getElementById('minPsnPrice' + suffix).value = '';
                document.getElementById('maxPsnPrice' + suffix).value = '';
                document.getElementById('releaseYearFilter' + suffix).value = 'all';
            } else { // Para gráficos e biblioteca
                document.getElementById('statusFilter' + suffix).value = 'all';
                document.getElementById('styleFilter' + suffix).value = 'all';
                document.getElementById('yearFilter' + suffix).value = 'all';
                document.getElementById('minRating' + suffix).value = '';
                document.getElementById('maxRating' + suffix).value = '';
                document.getElementById('minMetacritic' + suffix).value = '';
                document.getElementById('maxMetacritic' + suffix).value = '';
                document.getElementById('minPrice' + suffix).value = '';
                document.getElementById('maxPrice' + suffix).value = '';
                document.getElementById('minHours' + suffix).value = '';
                document.getElementById('maxHours' + suffix).value = '';
            }
            applyFilters(suffix); // Aplica os filtros limpos imediatamente
        }


        function openGameModalForAdd() { 
            document.getElementById('addGameForm').reset(); 
            document.getElementById('editMode').value = ''; 
            document.getElementById('gameModalTitle').textContent = 'Adicionar Novo Jogo'; 
            document.getElementById('gameModalSubmitBtn').textContent = 'Salvar Jogo'; 
            document.getElementById('rawgIdInput').value = '';
            document.getElementById('gameMetacritic').value = '';
            document.getElementById('gameDescription').value = '';
            document.getElementById('addGameModal').classList.add('active'); 
        }
        
        function openGameModalForEdit(gameName) {
            const gameToEdit = fullData.biblioteca.find(g => g.Nome === gameName); if (!gameToEdit) { showToast("Jogo não encontrado.", true); return; }
            document.getElementById('addGameForm').reset(); document.getElementById('editMode').value = gameName;
            document.getElementById('gameModalTitle').textContent = `Editar ${gameToEdit.Nome}`; document.getElementById('gameModalSubmitBtn').textContent = 'Atualizar Jogo';
            document.getElementById('gameName').value = gameToEdit.Nome; document.getElementById('gamePlatform').value = gameToEdit.Plataforma || '';
            document.getElementById('gameStatus').value = gameToEdit.Status || 'Na Fila'; document.getElementById('gameRating').value = gameToEdit.Nota || '';
            document.getElementById('gameHours').value = gameToEdit['Tempo de Jogo'] || ''; document.getElementById('gameLink').value = gameToEdit.Link || '';
            document.getElementById('gameStyle').value = gameToEdit.Estilo || ''; document.getElementById('gamePrice').value = String(gameToEdit.Preço || '').replace('.', ',');
            document.getElementById('gameConquistas').value = gameToEdit['Conquistas Obtidas'] || ''; document.getElementById('gameTermino').value = gameToEdit['Terminado em'] || '';
            document.getElementById('addGameModal').classList.add('active');
            closeGameDetailsModal();
        }

        function closeGameModal() { document.getElementById('addGameModal').classList.remove('active'); }
        function closeWishModal() { document.getElementById('addWishModal').classList.remove('active'); }
        
        async function handleGameFormSubmit(event) {
            event.preventDefault();
            const editModeValue = document.getElementById('editMode').value; const isEditing = editModeValue !== '';
            const priceValue = document.getElementById('gamePrice').value.replace(',', '.');
            const gameData = {
                Nome: document.getElementById('gameName').value,
                Plataforma: document.getElementById('gamePlatform').value,
                Status: document.getElementById('gameStatus').value,
                Nota: parseFloat(document.getElementById('gameRating').value.replace(',', '.')) || null,
                "Tempo de Jogo": parseInt(document.getElementById('gameHours').value) || 0,
                Link: document.getElementById('gameLink').value,
                Estilo: document.getElementById('gameStyle').value,
                "Platinado?": document.getElementById('gameStatus').value === 'Platinado' ? 'Sim' : 'Não',
                Preço: parseFloat(priceValue) || 0,
                "Conquistas Obtidas": parseInt(document.getElementById('gameConquistas').value) || 0,
                "Terminado em": document.getElementById('gameTermino').value || '',
                RAWG_ID: document.getElementById('rawgIdInput').value || '',
                Metacritic: document.getElementById('gameMetacritic').value || '',
                Descricao: document.getElementById('gameDescription').value || ''
            };
            let url = isEditing ? `${API_URL}/games/edit` : `${API_URL}/games/add`; let method = isEditing ? 'PUT' : 'POST';
            let body = isEditing ? { list_type: 'games', item_name: editModeValue, updated_data: gameData } : { list_type: 'games', item_data: gameData };
            try {
                const response = await fetch(url, { method, headers: { 'Content-Type': 'application/json', 'Authorization': `Bearer ${token}` }, body: JSON.stringify(body) });
                if (response.ok) { showToast(`Jogo ${isEditing ? 'atualizado' : 'adicionado'} com sucesso!`); closeGameModal(); fetchGameData(); }
                else { const error = await response.json(); showToast(`Erro: ${error.message || 'Falha na operação.'}`, true); }
            } catch (err) { showToast(`Erro de conexão.`, true); }
        }
        
        async function deleteGame(gameName) {
            Swal.fire({
                title: 'Deseja Excluir?',
                text: `O jogo "${gameName}" será removido permanentemente da sua biblioteca.`,
                icon: 'warning',
                showCancelButton: true,
                confirmButtonText: 'Sim, excluir!',
                cancelButtonText: 'Cancelar',
                background: 'var(--surface-color)',
                color: 'var(--primary-text)',
                confirmButtonColor: '#cb2d3e'
            }).then(async (result) => {
                if (result.isConfirmed) {
                    try {
                        const response = await fetch(`${API_URL}/games/delete/games/${encodeURIComponent(gameName)}`, { method: 'DELETE', headers: { 'Authorization': `Bearer ${token}` } });
                        if (response.ok) {
                            showToast("Jogo deletado com sucesso!");
                            fetchGameData();
                        } else {
                            showToast("Erro ao deletar jogo.", true);
                        }
                    } catch(err) {
                        showToast("Erro de conexão.", true);
                    }
                }
            });
            closeGameDetailsModal();
        }
        
        function editGame(gameName) { openGameModalForEdit(gameName); }
        
        function openWishModal() {
            document.getElementById('addWishForm').reset(); document.getElementById('editWishMode').value = '';
            document.getElementById('wishModalTitle').textContent = 'Adicionar à Lista de Desejos'; document.getElementById('wishModalSubmitBtn').textContent = 'Adicionar à Lista';
            document.getElementById('addWishModal').classList.add('active');
        }

        function editWish(wishName) {
            const wishToEdit = fullData.desejos.find(w => w.Nome === wishName); if (!wishToEdit) { showToast("Item não encontrado.", true); return; }
            document.getElementById('addWishForm').reset(); document.getElementById('editWishMode').value = wishName; // Corrigido para editWishMode
            document.getElementById('wishModalTitle').textContent = `Editar ${wishToEdit.Nome}`; document.getElementById('wishModalSubmitBtn').textContent = 'Atualizar Item';
            document.getElementById('wishGameName').value = wishToEdit.Nome;
            document.getElementById('wishGameLink').value = wishToEdit.Link || '';
            document.getElementById('wishGameRelease').value = wishToEdit["Data Lançamento"] || '';
            // Preço removido do formulário de adição/edição de desejos, então não preenchemos aqui
            // document.getElementById('wishGamePrice').value = String(wishToEdit.Preço || '').replace('.', ',');
            document.getElementById('addWishModal').classList.add('active');
            closeWishDetailsModal(); // Fecha o modal de detalhes se estiver aberto
        }

        async function handleWishFormSubmit(event) {
            event.preventDefault();
            const editModeValue = document.getElementById('editWishMode').value; // Corrigido para editWishMode
            const isEditing = editModeValue !== '';
            // Preço foi removido do formulário de adição/edição de desejos
            // const priceValue = document.getElementById('wishGamePrice').value.replace(',', '.');
            const wishData = { 
                Nome: document.getElementById('wishGameName').value, 
                Link: document.getElementById('wishGameLink').value, 
                "Data Lançamento": document.getElementById('wishGameRelease').value, 
                // Preço será atualizado separadamente pela API externa ou manualmente
                Preço: 0, // Valor padrão, pode ser atualizado depois
                "Steam Preco Atual": 0,
                "Steam Menor Preco Historico": 0,
                "PSN Preco Atual": 0,
                "PSN Menor Preco Historico": 0,
                "Ultima Atualizacao": ""
            };
            let url = isEditing ? `${API_URL}/games/edit` : `${API_URL}/games/add`; 
            let method = isEditing ? 'PUT' : 'POST';
            let body = isEditing ? { list_type: 'wishlist', item_name: editModeValue, updated_data: wishData } : { list_type: 'wishlist', item_data: wishData };
            try {
                const response = await fetch(url, { method, headers: { 'Content-Type': 'application/json', 'Authorization': `Bearer ${token}` }, body: JSON.stringify(body) });
                if (response.ok) { showToast(`Item ${isEditing ? 'atualizado' : 'adicionado'} com sucesso!`); closeWishModal(); fetchGameData(); }
                else { const error = await response.json(); showToast(`Erro: ${error.message || 'Falha na operação.'}`, true); }
            } catch (err) { showToast(`Erro de conexão.`, true); }
        }

        async function deleteWish(wishName) {
            Swal.fire({
                title: 'Deseja Remover?',
                text: `O item "${wishName}" será removido permanentemente.`,
                icon: 'warning',
                showCancelButton: true,
                confirmButtonText: 'Sim, remover!',
                cancelButtonText: 'Cancelar',
                background: 'var(--surface-color)',
                color: 'var(--primary-text)',
                confirmButtonColor: '#cb2d3e'
            }).then(async (result) => {
                if (result.isConfirmed) {
                    try {
                        const response = await fetch(`${API_URL}/games/delete/wishlist/${encodeURIComponent(wishName)}`, {
                            method: 'DELETE',
                            headers: { 'Authorization': `Bearer ${token}` }
                        });
                        if (response.ok) {
                            showToast("Item deletado com sucesso!");
                            fetchGameData();
                        } else {
                            const error = await response.json();
                            showToast(error.message || "Erro ao deletar o item.", true);
                        }
                    } catch (err) {
                        showToast("Erro de conexão.", true);
                    }
                }
            });
            closeWishDetailsModal();
        }
        
        async function purchaseWish(wishName) {
            Swal.fire({
                title: 'Marcar como Comprado?',
                text: `O jogo "${wishName}" será removido da sua lista de desejos.`,
                icon: 'question',
                showCancelButton: true,
                confirmButtonText: 'Sim, comprei!',
                cancelButtonText: 'Cancelar',
                background: 'var(--surface-color)',
                color: 'var(--primary-text)',
                confirmButtonColor: 'var(--accent-purple)'
            }).then(async (result) => {
                if (result.isConfirmed) {
                    try {
                        const response = await fetch(`${API_URL}/games/wishlist/purchase/${encodeURIComponent(wishName)}`, {
                            method: 'POST',
                            headers: { 'Authorization': `Bearer ${token}` }
                        });
                        if (response.ok) {
                            showToast("Jogo marcado como comprado!");
                            fetchGameData();
                        } else {
                            showToast("Erro ao marcar como comprado.", true);
                        }
                    } catch(err) {
                        showToast("Erro de conexão.", true);
                    }
                }
            });
        }
        
        function openSettingsModal() {
            const profile = fullData.perfil || {};
            document.getElementById('profileNameInput').value = profile.profileName || '';
            document.getElementById('profileSubtitleInput').value = profile.profileSubtitle || '';
            document.getElementById('profileAvatarInput').value = profile.profileAvatar || '';
            document.getElementById('profileHeaderBgInput').value = profile.headerBackgroundUrl || ''; // NOVO CAMPO
            document.getElementById('settingsModal').classList.add('active');
        }
        function closeSettingsModal() { document.getElementById('settingsModal').classList.remove('active'); }
        async function handleSettingsFormSubmit(event) {
            event.preventDefault();
            const newProfileData = { 
                profileName: document.getElementById('profileNameInput').value, 
                profileSubtitle: document.getElementById('profileSubtitleInput').value, 
                profileAvatar: document.getElementById('profileAvatarInput').value,
                headerBackgroundUrl: document.getElementById('profileHeaderBgInput').value // NOVO CAMPO
            };
            try {
                const response = await fetch(`${API_URL}/games/profile/edit`, { method: 'PUT', headers: { 'Content-Type': 'application/json', 'Authorization': `Bearer ${token}` }, body: JSON.stringify(newProfileData) });
                if (response.ok) { showToast('Perfil atualizado com sucesso!'); closeSettingsModal(); fullData.perfil = newProfileData; loadProfileSettings(fullData.perfil); }
                else { showToast('Erro ao atualizar o perfil.', true); }
            } catch(err) { showToast('Erro de conexão ao salvar as configurações.', true); }
        }
        function loadProfileSettings(profile = {}) {
            document.getElementById('gamerName').textContent = profile.profileName || 'Seu Nome';
            document.getElementById('profileSubtitle').textContent = profile.profileSubtitle || 'Resumo da jornada!';
            document.getElementById('profileAvatar').src = profile.profileAvatar || 'https://i.imgur.com/Z0ebi8o.png';
            // NOVO: Define o background do cabeçalho do perfil
            const profileHeader = document.querySelector('.profile-header');
            if (profile.headerBackgroundUrl) {
                profileHeader.style.backgroundImage = `url('${profile.headerBackgroundUrl}'), linear-gradient(135deg, #301934 0%, #0d1117 100%)`;
            } else {
                profileHeader.style.backgroundImage = `url('https://www.transparenttextures.com/patterns/dark-fish-skin.png'), linear-gradient(135deg, #301934 0%, #0d1117 100%)`;
            }
        }

        function openAchievementsModal() { document.getElementById('achievementsModal').classList.add('active'); }
        function closeAchievementsModal() { document.getElementById('achievementsModal').classList.remove('active'); }
        function switchAchievementTab(event, tabName) {
            document.querySelectorAll('#achievementsModal .tab-content').forEach(tc => tc.classList.remove('active'));
            document.querySelectorAll('#achievementsModal .tab-button').forEach(tb => tb.classList.remove('active'));
            document.getElementById(tabName).classList.add('active');
            event.currentTarget.classList.add('active');
        }
        
        async function openGameDetailsModal(gameName) {
            const game = fullData.biblioteca.find(g => g.Nome === gameName);
            if (!game) {
                showToast("Jogo não encontrado.", true);
                return;
            }

            document.getElementById('gameNameDetails').textContent = game.Nome;
            document.getElementById('gamePlatformDetails').textContent = game.Plataforma || 'Não informado';
            document.getElementById('gameStatusDetails').textContent = game.Status || 'Não informado';
            
            const gameRatingDetails = document.getElementById('gameRatingDetails');
            const gameRating = parseFloat(game.Nota);
            gameRatingDetails.textContent = game.Nota || 'N/A';
            gameRatingDetails.className = 'rating-score';
            if (!isNaN(gameRating)) {
                if (gameRating >= 80) {
                    gameRatingDetails.classList.add('good');
                } else if (gameRating >= 50) {
                    gameRatingDetails.classList.add('mixed');
                } else if (gameRating >= 0) {
                    gameRatingDetails.classList.add('bad');
                }
            }
            
            document.getElementById('gameHoursDetails').textContent = `${game['Tempo de Jogo'] || 0}h`;
            document.getElementById('gameStylesDetails').textContent = game.Estilo || 'Não informado';
            document.getElementById('gameAchievementsDetails').textContent = game['Conquistas Obtidas'] || 0;
            document.getElementById('gameDescriptionDetails').textContent = game.Descricao || 'Nenhuma descrição disponível.';
            
            const gameMetacriticDetails = document.getElementById('gameMetacriticDetails');
            const metacriticScore = parseInt(game.Metacritic);
            gameMetacriticDetails.textContent = game.Metacritic || 'N/A';
            gameMetacriticDetails.className = 'metacritic-score';
            if (metacriticScore >= 75) {
                gameMetacriticDetails.classList.add('good');
            } else if (metacriticScore >= 50) {
                gameMetacriticDetails.classList.add('mixed');
            } else if (metacriticScore > 0) {
                gameMetacriticDetails.classList.add('bad');
            } else {
                gameMetacriticDetails.classList.add('mixed');
            }
            
            const coverArt = game.Link || 'https://i.imgur.com/Z0ebi8o.png';
            document.getElementById('gameCoverArt').src = coverArt;
            document.getElementById('gameCoverBackground').src = coverArt;

            const safeName = game.Nome.replace(/'/g, "\\'");
            document.getElementById('editGameDetailsBtn').onclick = () => openGameModalForEdit(safeName);
            document.getElementById('deleteGameDetailsBtn').onclick = () => deleteGame(safeName);

            // NOVO: Carregar jogos similares
            const rawgId = game.RAWG_ID;
            const similarGamesGrid = document.getElementById('similarGamesGrid');
            const noSimilarGamesMessage = document.getElementById('noSimilarGames');

            if (rawgId && similarGamesGrid && noSimilarGamesMessage) {
                await getSimilarGames(rawgId);
            } else if (similarGamesGrid && noSimilarGamesMessage) {
                similarGamesGrid.innerHTML = '';
                noSimilarGamesMessage.textContent = 'RAWG ID não disponível para buscar jogos similares.';
                noSimilarGamesMessage.style.display = 'block';
            }

            document.getElementById('gameDetailsModal').classList.add('active');
        }

        function closeGameDetailsModal() {
            document.getElementById('gameDetailsModal').classList.remove('active');
            // Limpa os jogos similares ao fechar o modal
            const similarGamesGrid = document.getElementById('similarGamesGrid');
            const noSimilarGamesMessage = document.getElementById('noSimilarGames');
            if (similarGamesGrid) similarGamesGrid.innerHTML = '';
            if (noSimilarGamesMessage) {
                noSimilarGamesMessage.textContent = 'Nenhum jogo similar encontrado.';
                noSimilarGamesMessage.style.display = 'block';
            }
        }

        // NOVO: Funções para o modal de detalhes da lista de desejos
        async function openWishDetailsModal(wishName) {
            const wish = fullData.desejos.find(w => w.Nome === wishName);
            if (!wish) {
                showToast("Item da lista de desejos não encontrado.", true);
                return;
            }

            document.getElementById('wishNameDetails').textContent = wish.Nome;
            document.getElementById('wishReleaseDetails').textContent = wish['Data Lançamento'] || 'N/A';
            
            const steamCurrent = wish['Steam Preco Atual'] || 'N/A';
            const steamLowest = wish['Steam Menor Preco Historico'] || 'N/A';
            const psnCurrent = wish['PSN Preco Atual'] || 'N/A';
            const psnLowest = wish['PSN Menor Preco Historico'] || 'N/A';

            document.getElementById('wishSteamCurrentPrice').textContent = formatCurrency(steamCurrent);
            document.getElementById('wishSteamLowestPrice').textContent = formatCurrency(steamLowest);
            document.getElementById('wishPsnCurrentPrice').textContent = formatCurrency(psnCurrent);
            document.getElementById('wishPsnLowestPrice').textContent = formatCurrency(psnLowest);
            document.getElementById('wishLastPriceUpdate').textContent = wish['Ultima Atualizacao'] ? new Date(wish['Ultima Atualizacao']).toLocaleString('pt-BR') : 'N/A';

            const priceStatus = getPriceStatus(steamCurrent, steamLowest, psnCurrent, psnLowest);
            const wishPriceStatusElement = document.getElementById('wishPriceStatus');
            wishPriceStatusElement.textContent = priceStatus.status;
            wishPriceStatusElement.className = `price-status ${priceStatus.class}`;

            document.getElementById('wishCoverArt').src = wish.Link || 'https://placehold.co/120x160/21262d/e6edf3?text=Sem+Capa';
            document.getElementById('wishCoverBackground').src = wish.Link || 'https://placehold.co/800x250/21262d/e6edf3?text=Sem+Capa';

            const safeName = wish.Nome.replace(/'/g, "\\'");
            document.getElementById('purchaseWishDetailsBtn').onclick = () => purchaseWish(safeName);
            document.getElementById('editWishDetailsBtn').onclick = () => editWish(safeName);
            document.getElementById('deleteWishDetailsBtn').onclick = () => deleteWish(safeName);

            // NOVO: Renderiza o gráfico de histórico de preços
            await renderPriceHistoryChart(wish.Nome);

            document.getElementById('wishDetailsModal').classList.add('active');
        }

        function closeWishDetailsModal() {
            document.getElementById('wishDetailsModal').classList.remove('active');
            // Destrói o gráfico ao fechar o modal para evitar problemas de renderização
            if (priceHistoryChart) {
                priceHistoryChart.destroy();
                priceHistoryChart = null;
            }
        }
        
        // NOVO: Função para renderizar o gráfico de histórico de preços
        async function renderPriceHistoryChart(gameName) {
            const container = document.getElementById('priceHistoryChartContainer');
            const noHistoryMessage = document.getElementById('noPriceHistory');
            const canvas = document.getElementById('priceHistoryChart');
            if (!container || !noHistoryMessage || !canvas) return;

            if (priceHistoryChart) {
                priceHistoryChart.destroy();
            }

            try {
                const response = await fetch(`${API_URL}/games/wishlist/price-history/${encodeURIComponent(gameName)}`, {
                    headers: { 'Authorization': `Bearer ${token}` }
                });
                const history = await response.json();

                if (history.length === 0) {
                    canvas.style.display = 'none';
                    noHistoryMessage.style.display = 'block';
                    return;
                }

                canvas.style.display = 'block';
                noHistoryMessage.style.display = 'none';

                const steamData = history.filter(h => h.Plataforma === 'Steam');
                const psnData = history.filter(h => h.Plataforma === 'PSN');
                const allDates = [...new Set(history.map(h => h.Data))].sort();

                const datasets = [];

                if (steamData.length > 0) {
                    datasets.push({
                        label: 'Steam',
                        data: allDates.map(date => {
                            const record = steamData.find(h => h.Data === date);
                            return record ? parseFloat(String(record.Preço).replace(',', '.')) : null;
                        }),
                        borderColor: chartColors.purple,
                        tension: 0.3,
                        fill: false,
                        spanGaps: true
                    });
                }

                if (psnData.length > 0) {
                    datasets.push({
                        label: 'PSN',
                        data: allDates.map(date => {
                            const record = psnData.find(h => h.Data === date);
                            return record ? parseFloat(String(record.Preço).replace(',', '.')) : null;
                        }),
                        borderColor: chartColors.grey,
                        tension: 0.3,
                        fill: false,
                        spanGaps: true
                    });
                }
                
                priceHistoryChart = new Chart(canvas, {
                    type: 'line',
                    data: {
                        labels: allDates,
                        datasets: datasets
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: {
                            legend: { position: 'top' }
                        },
                        scales: {
                            x: {
                                title: { display: true, text: 'Data', color: 'var(--secondary-text)' },
                                ticks: { color: 'var(--secondary-text)' },
                                grid: { color: 'var(--border-color)' }
                            },
                            y: {
                                title: { display: true, text: 'Preço (R$)', color: 'var(--secondary-text)' },
                                ticks: { color: 'var(--secondary-text)' },
                                grid: { color: 'var(--border-color)' }
                            }
                        }
                    }
                });
            } catch (error) {
                console.error("Erro ao buscar histórico de preços:", error);
                canvas.style.display = 'none';
                noHistoryMessage.style.display = 'block';
                noHistoryMessage.textContent = "Erro ao carregar o histórico de preços.";
            }
        }


        async function handleSearch(query) {
            const resultsContainer = document.getElementById('searchResultsContainer');
            if (query.length < 3) { resultsContainer.innerHTML = ''; return; }
            const response = await fetch(`${API_URL}/games/search-external?query=${encodeURIComponent(query)}`, { headers: { 'Authorization': `Bearer ${token}` } });
            const games = await response.json();
            if (!games || games.length === 0) { resultsContainer.innerHTML = ''; return; }
            const listHTML = games.map(game => {
                const safeName = game.name.replace(/'/g, "\\'");
                const safeStyles = game.styles.replace(/'/g, "\\'");
                const year = game.released_for_input ? new Date(game.released_for_input).getFullYear() : 'N/A';
                return `<div class="search-result-item" onclick="selectGame({ rawg_id: '${game.id}', name: '${safeName}', background_image: '${game.background_image || ''}', released_for_input: '${game.released_for_input || ''}', styles: '${safeStyles}', metacritic: '${game.metacritic || ''}', description: '${game.description ? game.description.replace(/'/g, "\\'").replace(/\n/g, '\\n') : ''}' })"><img src="${game.background_image || 'https://i.imgur.com/Z0ebi8o.png'}" alt="Capa"><div class="search-result-info"><span>${game.name}</span><small>Lançamento: ${year}</small></div></div>`;
            }).join('');
            resultsContainer.innerHTML = `<div class="search-results-list">${listHTML}</div>`;
        }

        function selectGame(game) {
            document.getElementById('rawgIdInput').value = game.rawg_id;
            document.getElementById('gameName').value = game.name;
            document.getElementById('gameLink').value = game.background_image;
            document.getElementById('gameStyle').value = game.styles;
            document.getElementById('gameMetacritic').value = game.metacritic;
            document.getElementById('gameDescription').value = game.description;
            document.getElementById('searchResultsContainer').innerHTML = '';
        }

        async function handleWishSearch(query) {
            const resultsContainer = document.getElementById('wishSearchResultsContainer');
            if (query.length < 3) { resultsContainer.innerHTML = ''; return; }
            const response = await fetch(`${API_URL}/games/search-external?query=${encodeURIComponent(query)}`, { headers: { 'Authorization': `Bearer ${token}` } });
            const games = await response.json();
            if (!games || games.length === 0) { resultsContainer.innerHTML = ''; return; }
            const listHTML = games.map(game => {
                const safeName = game.name.replace(/'/g, "\\'");
                const year = game.released_for_input ? new Date(game.released_for_input).getFullYear() : 'N/A';
                return `<div class="search-result-item" onclick="selectWishGame({ name: '${safeName}', background_image: '${game.background_image || ''}', released_for_input: '${game.released_for_input || ''}' })"><img src="${game.background_image || 'https://i.imgur.com/Z0ebi8o.png'}" alt="Capa"><div class="search-result-info"><span>${game.name}</span><small>Lançamento: ${year}</small></div></div>`;
            }).join('');
            resultsContainer.innerHTML = `<div class="search-results-list">${listHTML}</div>`;
        }

        function selectWishGame(game) {
            document.getElementById('wishGameName').value = game.name;
            document.getElementById('wishGameLink').value = game.background_image;
            if (game.released_for_input) {
                const parts = game.released_for_input.split('-');
                document.getElementById('wishGameRelease').value = `${parts[2]}/${parts[1]}/${parts[0]}`;
            } else {
                document.getElementById('wishGameRelease').value = 'Data não informada';
            }
            document.getElementById('wishSearchResultsContainer').innerHTML = '';
        }
        
        function toggleLibraryView() {
            const tableContainer = document.querySelector('#biblioteca .table-container');
            const gridContainer = document.getElementById('game-grid-container');
            const toggleBtnIcon = document.querySelector('#toggleViewBtn .material-symbols-outlined');

            const isGridVisible = gridContainer.style.display !== 'none';

            if (isGridVisible) {
                gridContainer.style.display = 'none';
                tableContainer.style.display = 'block';
                toggleBtnIcon.textContent = 'grid_view';
            } else {
                gridContainer.style.display = 'grid';
                tableContainer.style.display = 'none';
                toggleBtnIcon.textContent = 'view_list';
            }
        }

        // --- NOVO: Funções de Notificação no Frontend ---
        let currentNotifications = []; // Armazena as notificações atuais para evitar popups duplicados
        let allFetchedNotifications = []; // Armazena todas as notificações buscadas (lidas e não lidas)

        async function fetchNotifications() {
            console.log('fetchNotifications: Starting to fetch notifications.'); // New log
            try {
                const response = await fetch(`${API_URL}/games/notifications`, { headers: { 'Authorization': `Bearer ${token}` } });
                if (response.status === 401) { 
                    console.log('fetchNotifications: Unauthorized, returning.'); // New log
                    return; 
                } // Token expirado, será tratado pelo fetchGameData
                if (!response.ok) throw new Error(`HTTP error! status: ${response.status}`);
                
                const notifications = await response.json();
                console.log('fetchNotifications: Notifications fetched:', notifications.length); // New log
                allFetchedNotifications = notifications; // Armazena todas as notificações
                
                const unreadNotifications = notifications.filter(n => n.Lida === 'Não');
                updateNotificationCount(unreadNotifications.length);
                console.log('fetchNotifications: Notification count updated.'); // New log
                
                // Renderiza as notificações na aba ativa atual
                const activeTab = document.querySelector('#notificationsModal .tab-button.active');
                if (activeTab) {
                    renderNotificationsInModal(activeTab.dataset.tab);
                    console.log('fetchNotifications: renderNotificationsInModal called for active tab.'); // New log
                } else {
                    renderNotificationsInModal('unread'); // Padrão para não lidas se nenhuma aba estiver ativa
                    console.log('fetchNotifications: renderNotificationsInModal called for unread (default).'); // New log
                }

                // Exibir popups para novas notificações não lidas
                console.log('fetchNotifications: Checking for new popups.'); // New log
                unreadNotifications.forEach(newNotif => {
                    // Verifica se a notificação já foi exibida como popup nesta sessão
                    if (!currentNotifications.some(n => n.ID === newNotif.ID)) {
                        showToast(newNotif.Mensagem);
                        currentNotifications.push(newNotif); // Adiciona à lista de notificações exibidas
                        console.log('fetchNotifications: Showing popup for ID:', newNotif.ID); // New log
                    }
                });
                console.log('fetchNotifications: Popup check completed.'); // New log

            } catch (err) {
                console.error('Erro ao buscar notificações:', err);
            }
        }

        function updateNotificationCount(count) {
            const notificationCountElement = document.getElementById('notificationCount');
            if (notificationCountElement) {
                notificationCountElement.textContent = count;
                if (count > 0) {
                    notificationCountElement.classList.add('visible');
                } else {
                    notificationCountElement.classList.remove('visible');
                }
            }
        }

        function renderNotificationsInModal(tabName) {
            console.log('renderNotificationsInModal: Rendering for tab:', tabName); // New log
            const unreadListContainer = document.getElementById('unread-notifications-list');
            const readListContainer = document.getElementById('read-notifications-list');

            const unreadNotifications = allFetchedNotifications.filter(n => n.Lida === 'Não');
            const readNotifications = allFetchedNotifications.filter(n => n.Lida === 'Sim');

            console.log('renderNotificationsInModal: Unread count:', unreadNotifications.length, 'Read count:', readNotifications.length); // New log

            const createNotificationHtml = (notif) => {
                const date = new Date(notif.Data).toLocaleString('pt-BR', { dateStyle: 'short', timeStyle: 'short' });
                return `
                    <div class="notification-item ${notif.Lida === 'Sim' ? 'read' : ''}" data-id="${notif.ID}" onclick="handleNotificationClick(event, ${notif.ID})">
                        <strong>${notif.Tipo}</strong>
                        <span>${notif.Mensagem}</span>
                        <small>${date}</small>
                    </div>
                `;
            };

            if (unreadListContainer) {
                if (unreadNotifications.length === 0) {
                    unreadListContainer.innerHTML = '<p class="no-results">Nenhuma notificação não lida por enquanto!</p>';
                } else {
                    unreadListContainer.innerHTML = unreadNotifications.map(createNotificationHtml).join('');
                }
            }

            if (readListContainer) {
                if (readNotifications.length === 0) {
                    readListContainer.innerHTML = '<p class="no-results">Nenhuma notificação lida por enquanto!</p>';
                } else {
                    readListContainer.innerHTML = readNotifications.map(createNotificationHtml).join('');
                }
            }
            console.log('renderNotificationsInModal: Finished rendering for tab:', tabName); // New log
        }

        async function markNotificationAsReadAndRefresh(notificationId) {
            try {
                const response = await fetch(`${API_URL}/games/notifications/mark-read/${notificationId}`, {
                    method: 'POST',
                    headers: { 'Authorization': `Bearer ${token}` }
                });
                if (!response.ok) throw new Error(`HTTP error! status: ${response.status}`);
                
                showToast("Notificação marcada como lida!");
                // Remove a notificação da lista de notificações atuais para não exibir popup novamente
                currentNotifications = currentNotifications.filter(n => n.ID !== notificationId);
                fetchNotifications(); // Atualiza a lista e o contador
            } catch (err) {
                console.error('Erro ao marcar notificação como lida:', err);
                showToast("Erro ao marcar notificação como lida.", true);
            }
        }
        
        // NOVO: Função que lida com o clique na notificação
        async function handleNotificationClick(event, notificationId) {
            event.preventDefault(); // Evita comportamento padrão
            const clickedNotif = allFetchedNotifications.find(n => n.ID === notificationId);
            if (!clickedNotif) {
                showToast("Notificação não encontrada.", true);
                return;
            }

            // Marca como lida e atualiza a interface
            await markNotificationAsReadAndRefresh(notificationId);
            closeNotificationsModal();

            // Lógica de navegação interna baseada no link
            const internalLink = clickedNotif.LinkInterno;
            if (internalLink) {
                const params = new URLSearchParams(internalLink);
                const page = params.get('page');
                const modal = params.get('modal');
                const name = params.get('name');
                const achId = params.get('achId');

                if (page) {
                    const pageElement = document.getElementById(page);
                    const pageButton = document.querySelector(`.nav-button[onclick*="'${page}'"]`);
                    if (pageElement && pageButton) {
                        openPage({ currentTarget: pageButton }, page);
                    }
                }

                if (modal === 'game-details' && name) {
                    openGameDetailsModal(name);
                } else if (modal === 'wish-details' && name) {
                    openWishDetailsModal(name);
                } else if (page === 'conquistas' && achId) {
                    openAchievementsModal();
                    // Aqui você pode adicionar lógica para dar destaque a uma conquista específica, se desejar
                }
            }
        }

        async function markAllNotificationsAsRead() {
            const unreadIds = allFetchedNotifications.filter(n => n.Lida === 'Não').map(n => n.ID);
            if (unreadIds.length === 0) {
                showToast("Nenhuma notificação não lida para marcar!", false);
                return;
            }

            try {
                // Itera sobre as notificações não lidas e marca cada uma como lida
                for (const id of unreadIds) {
                    await fetch(`${API_URL}/games/notifications/mark-read/${id}`, {
                        method: 'POST',
                        headers: { 'Authorization': `Bearer ${token}` }
                    });
                }
                showToast("Todas as notificações marcadas como lidas!");
                currentNotifications = []; // Limpa os popups exibidos
                fetchNotifications(); // Atualiza a lista e o contador
                closeNotificationsModal(); // Fecha o modal após marcar todas
            } catch (err) {
                console.error('Erro ao marcar todas as notificações como lidas:', err);
                showToast("Erro ao marcar todas as notificações como lidas.", true);
            }
        }

        function openNotificationsModal() {
            document.getElementById('notificationsModal').classList.add('active');
            // Garante que a aba "Não Lidas" esteja ativa ao abrir o modal
            switchNotificationTab(null, 'unread'); 
            fetchNotifications(); // Busca as notificações para garantir que o modal esteja atualizado
        }

        async function closeNotificationsModal() {
            document.getElementById('notificationsModal').classList.remove('active');
            fetchNotifications(); // Recarrega notificações para garantir que o contador esteja atualizado
        }

        function switchNotificationTab(event, tabName) {
            document.querySelectorAll('#notificationsModal .tab-content').forEach(tc => tc.classList.remove('active'));
            document.querySelectorAll('#notificationsModal .tab-button').forEach(tb => tb.classList.remove('active'));
            
            document.getElementById(tabName).classList.add('active');
            
            const targetButton = document.querySelector(`#notificationsModal .tab-button[data-tab="${tabName}"]`);
            if (targetButton) {
                targetButton.classList.add('active');
            }
            
            renderNotificationsInModal(tabName); // Renderiza as notificações para a aba selecionada
        }
        // --- FIM NOVO ---
        
        // NOVO: Função para acionar a GitHub Action via backend
        async function triggerScraperAction() {
            Swal.fire({
                title: 'Atualizando Preços...',
                text: 'Aguarde um momento. Isso pode levar alguns segundos.',
                icon: 'info',
                allowOutsideClick: false,
                didOpen: () => {
                    Swal.showLoading();
                }
            });

            try {
                const response = await fetch(`${API_URL}/games/wishlist/update-prices`, {
                    method: 'POST',
                    headers: { 'Authorization': `Bearer ${token}` }
                });
                
                Swal.close();

                if (response.ok) {
                    const result = await response.json();
                    showToast(result.message);
                } else {
                    const error = await response.json();
                    showToast(error.message || "Erro ao acionar a atualização de preços.", true);
                }
            } catch(err) {
                Swal.close();
                showToast("Erro de conexão com o servidor.", true);
            }
        }

        // NOVO: Funções para sincronização da biblioteca Steam
        function openSyncModal() {
            document.getElementById('syncModal').classList.add('active');
            document.getElementById('syncForm').reset();
            document.getElementById('steamPreviewContainer').style.display = 'none';
            document.getElementById('newGamesPreview').innerHTML = '<h3 class="steam-game-category">Novos Jogos</h3>';
            document.getElementById('existingGamesPreview').innerHTML = '<h3 class="steam-game-category">Jogos Existentes (Atualizar)</h3>';
            document.getElementById('syncSelectedGamesBtn').style.display = 'none';
            document.getElementById('steamSyncStatus').textContent = '';
        }

        function closeSyncModal() {
            document.getElementById('syncModal').classList.remove('active');
        }

        async function getSteamLibraryPreview() {
            const steamId = document.getElementById('steamIdInput').value;
            if (!steamId) {
                showToast("Por favor, insira seu Steam ID.", true);
                return;
            }

            const statusElement = document.getElementById('steamSyncStatus');
            statusElement.textContent = 'Buscando jogos da Steam...';
            statusElement.className = 'steam-sync-status loading';
            document.getElementById('steamPreviewContainer').style.display = 'block';
            document.getElementById('newGamesPreview').style.display = 'none';
            document.getElementById('existingGamesPreview').style.display = 'none';
            document.getElementById('syncSelectedGamesBtn').style.display = 'none';

            try {
                const response = await fetch(`${API_URL}/games/sync/steam/preview?steam_id=${encodeURIComponent(steamId)}`, {
                    headers: { 'Authorization': `Bearer ${token}` }
                });
                const result = await response.json();

                if (result.success) {
                    renderSteamGamesPreview(result.new_games, result.existing_games_to_update);
                    statusElement.textContent = 'Pré-visualização carregada. Selecione os jogos para sincronizar.';
                    statusElement.className = 'steam-sync-status success';
                    document.getElementById('syncSelectedGamesBtn').style.display = 'block';
                } else {
                    statusElement.textContent = result.message || 'Erro ao pré-visualizar jogos da Steam.';
                    statusElement.className = 'steam-sync-status error';
                }
            } catch (error) {
                console.error('Erro ao pré-visualizar jogos da Steam:', error);
                statusElement.textContent = 'Erro de conexão ao pré-visualizar jogos da Steam.';
                statusElement.className = 'steam-sync-status error';
            }
        }

        function renderSteamGamesPreview(newGames, existingGames) {
            const newGamesContainer = document.getElementById('newGamesPreview');
            const existingGamesContainer = document.getElementById('existingGamesPreview');

            newGamesContainer.innerHTML = '<h3 class="steam-game-category">Novos Jogos</h3>';
            existingGamesContainer.innerHTML = '<h3 class="steam-game-category">Jogos Existentes (Atualizar)</h3>';

            if (newGames.length > 0) {
                newGamesContainer.style.display = 'grid';
                newGames.forEach(game => {
                    newGamesContainer.innerHTML += `
                        <div class="steam-game-item">
                            <input type="checkbox" class="steam-game-checkbox" data-game-name="${game.Nome}" data-rawg-id="${game.RAWG_ID || ''}" data-playtime="${game['Tempo de Jogo'] || 0}" checked>
                            <img src="${game.Link || 'https://placehold.co/180x100/21262d/e6edf3?text=Sem+Capa'}" alt="${game.Nome}">
                            <h4>${game.Nome}</h4>
                            <p>${game['Tempo de Jogo'] || 0}h jogadas</p>
                        </div>
                    `;
                });
            } else {
                newGamesContainer.innerHTML += '<p class="no-results">Nenhum novo jogo encontrado.</p>';
            }

            if (existingGames.length > 0) {
                existingGamesContainer.style.display = 'grid';
                existingGames.forEach(game => {
                    existingGamesContainer.innerHTML += `
                        <div class="steam-game-item">
                            <input type="checkbox" class="steam-game-checkbox" data-game-name="${game.Nome}" data-rawg-id="${game.RAWG_ID || ''}" data-playtime="${game['Tempo de Jogo'] || 0}" checked>
                            <img src="${game.Link || 'https://placehold.co/180x100/21262d/e6edf3?text=Sem+Capa'}" alt="${game.Nome}">
                            <h4>${game.Nome}</h4>
                            <p>${game['Tempo de Jogo'] || 0}h jogadas</p>
                        </div>
                    `;
                });
            } else {
                existingGamesContainer.innerHTML += '<p class="no-results">Nenhum jogo existente para atualizar.</p>';
            }
        }

        async function syncSelectedSteamGames() {
            const steamId = document.getElementById('steamIdInput').value;
            const selectedCheckboxes = document.querySelectorAll('#steamPreviewContainer .steam-game-checkbox:checked');
            
            if (selectedCheckboxes.length === 0) {
                showToast("Nenhum jogo selecionado para sincronizar.", true);
                return;
            }

            const selectedGamesData = Array.from(selectedCheckboxes).map(checkbox => ({
                Nome: checkbox.dataset.gameName,
                RAWG_ID: checkbox.dataset.rawgId,
                "Tempo de Jogo": parseInt(checkbox.dataset.playtime)
            }));

            const statusElement = document.getElementById('steamSyncStatus');
            statusElement.textContent = 'Sincronizando jogos selecionados...';
            statusElement.className = 'steam-sync-status loading';
            document.getElementById('syncSelectedGamesBtn').disabled = true; // Desabilita o botão durante a sincronização

            try {
                const response = await fetch(`${API_URL}/games/sync/steam`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json', 'Authorization': `Bearer ${token}` },
                    body: JSON.stringify({ steam_id: steamId, selected_games: selectedGamesData })
                });
                const result = await response.json();

                if (result.success) {
                    statusElement.textContent = result.message;
                    statusElement.className = 'steam-sync-status success';
                    showToast(result.message);
                    closeSyncModal();
                    fetchGameData(); // Recarrega todos os dados após a sincronização
                } else {
                    statusElement.textContent = result.message || 'Erro ao sincronizar jogos.';
                    statusElement.className = 'steam-sync-status error';
                    showToast(result.message || 'Erro ao sincronizar jogos.', true);
                }
            } catch (error) {
                console.error('Erro ao sincronizar jogos da Steam:', error);
                statusElement.textContent = 'Erro de conexão ao sincronizar jogos.';
                statusElement.className = 'steam-sync-status error';
                showToast('Erro de conexão ao sincronizar jogos.', true);
            } finally {
                document.getElementById('syncSelectedGamesBtn').disabled = false;
            }
        }
        // FIM NOVO: Funções para sincronização da biblioteca Steam

        // NOVO: Funções para Sortear Jogo
        function openRandomGameModal() {
            document.getElementById('randomGameModal').classList.add('active');
            document.getElementById('randomGameForm').reset();
            document.getElementById('randomGameResult').style.display = 'none';
            // Popula os filtros com base nos dados atuais da biblioteca
            populateRandomGameFilters();
        }

        function closeRandomGameModal() {
            document.getElementById('randomGameModal').classList.remove('active');
        }

        function populateRandomGameFilters() {
            const library = fullData.biblioteca || [];
            const platforms = [...new Set(library.map(g => g.Plataforma).filter(Boolean))].sort();
            const styles = [...new Set(library.flatMap(g => g.Estilo ? g.Estilo.split(',').map(s => s.trim()) : []).filter(Boolean))].sort();

            const populateSelect = (elementId, items) => {
                const select = document.getElementById(elementId);
                if (!select) return;
                select.innerHTML = '<option value="all">Todas</option>';
                items.forEach(item => {
                    select.innerHTML += `<option value="${item}">${item}</option>`;
                });
            };

            populateSelect('randomPlatform', platforms);
            populateSelect('randomStyle', styles);
        }

        async function handleRandomGameSubmit(event) {
            event.preventDefault();
            const platform = document.getElementById('randomPlatform').value;
            const style = document.getElementById('randomStyle').value;
            const minMetacritic = document.getElementById('randomMinMetacritic').value;
            const maxMetacritic = document.getElementById('randomMaxMetacritic').value;

            const params = new URLSearchParams();
            if (platform !== 'all') params.append('platform', platform);
            if (style !== 'all') params.append('style', style);
            if (minMetacritic) params.append('min_metacritic', minMetacritic);
            if (maxMetacritic) params.append('max_metacritic', maxMetacritic);

            const resultElement = document.getElementById('randomGameResult');
            resultElement.style.display = 'block';
            resultElement.textContent = 'Sorteando jogo...';

            try {
                const response = await fetch(`${API_URL}/games/random-game?${params.toString()}`, {
                    headers: { 'Authorization': `Bearer ${token}` }
                });
                const result = await response.json();

                if (result.success && result.game) {
                    resultElement.textContent = `Jogo sorteado: ${result.game.Nome}`;
                    // Abre o modal de detalhes do jogo sorteado
                    closeRandomGameModal();
                    openGameDetailsModal(result.game.Nome);
                } else {
                    resultElement.textContent = result.message || 'Não foi possível sortear um jogo com os critérios fornecidos.';
                }
            } catch (error) {
                console.error('Erro ao sortear jogo:', error);
                resultElement.textContent = 'Erro de conexão ao sortear jogo.';
            }
        }
        // FIM NOVO: Funções para Sortear Jogo

        // NOVO: Funções para Jogos Similares
        async function getSimilarGames(rawgId) {
            const similarGamesGrid = document.getElementById('similarGamesGrid');
            const noSimilarGamesMessage = document.getElementById('noSimilarGames');
            
            if (!similarGamesGrid || !noSimilarGamesMessage) {
                console.error("Elementos HTML para jogos similares não encontrados.");
                return;
            }

            similarGamesGrid.innerHTML = ''; // Limpa resultados anteriores
            noSimilarGamesMessage.style.display = 'none';

            if (!rawgId) {
                noSimilarGamesMessage.textContent = 'RAWG ID não disponível para buscar jogos similares.';
                noSimilarGamesMessage.style.display = 'block';
                return;
            }

            try {
                const response = await fetch(`${API_URL}/games/similar/${rawgId}`, {
                    headers: { 'Authorization': `Bearer ${token}` }
                });
                const result = await response.json();

                if (result.success && result.similar_games.length > 0) {
                    renderSimilarGames(result.similar_games);
                } else {
                    noSimilarGamesMessage.textContent = result.message || 'Nenhum jogo similar encontrado.';
                    noSimilarGamesMessage.style.display = 'block';
                }
            } catch (error) {
                console.error('Erro ao buscar jogos similares:', error);
                noSimilarGamesMessage.textContent = 'Erro de conexão ao buscar jogos similares.';
                noSimilarGamesMessage.style.display = 'block';
            }
        }

        function renderSimilarGames(similarGames) {
            const similarGamesGrid = document.getElementById('similarGamesGrid');
            const noSimilarGamesMessage = document.getElementById('noSimilarGames');

            if (!similarGamesGrid || !noSimilarGamesMessage) {
                console.error("Elementos HTML para jogos similares não encontrados durante a renderização.");
                return;
            }

            similarGamesGrid.innerHTML = ''; // Limpa para renderizar

            if (similarGames.length === 0) {
                noSimilarGamesMessage.style.display = 'block';
                return;
            }
            noSimilarGamesMessage.style.display = 'none';

            similarGames.forEach(game => {
                const safeName = game.name.replace(/'/g, "\\'");
                const ownedTag = game.is_owned ? '<span class="similar-game-owned-tag">Na Biblioteca</span>' : '';
                similarGamesGrid.innerHTML += `
                    <div class="similar-game-card" onclick="openGameDetailsModal('${safeName}')">
                        <img src="${game.background_image || 'https://placehold.co/120x100/21262d/e6edf3?text=Sem+Capa'}" alt="${game.name}">
                        <div class="similar-game-info">
                            <strong>${game.name}</strong>
                            <small>${game.styles || 'N/A'}</small>
                            ${ownedTag}
                        </div>
                    </div>
                `;
            });
        }
        // FIM NOVO: Funções para Jogos Similares


        document.addEventListener('DOMContentLoaded', () => {
            const setupListener = (id, event, handler) => { const element = document.getElementById(id); if (element) { element.addEventListener(event, handler); }};
            
            setupListener('addGameForm', 'submit', handleGameFormSubmit);
            setupListener('addWishForm', 'submit', handleWishFormSubmit);
            setupListener('settingsForm', 'submit', handleSettingsFormSubmit);
            setupListener('addGameBtn', 'click', openGameModalForAdd);
            setupListener('addWishBtn', 'click', openWishModal);
            setupListener('logoutBtn', 'click', () => { localStorage.removeItem('jwt_token'); window.location.href = 'login.html'; });
            
            // Adicionado listener para o novo botão de compartilhar
            setupListener('shareBtn', 'click', () => {
                const shareLink = 'https://savepoint-hub.netlify.app/shareable.html';
                const tempInput = document.createElement('input');
                document.body.appendChild(tempInput);
                tempInput.value = shareLink;
                tempInput.select();
                document.execCommand('copy');
                document.body.removeChild(tempInput);
                showToast('Link copiado para a área de transferência!');
            });

            // --- NOVO: Listener para o botão de notificações ---
            setupListener('notificationsBtn', 'click', openNotificationsModal);
            // --- FIM NOVO ---
            
            // NOVO: Listener para o botão de acionamento do scraper
            setupListener('triggerScraperBtn', 'click', triggerScraperAction);

            // NOVO: Listeners para sincronização Steam
            setupListener('syncLibraryBtn', 'click', openSyncModal);
            setupListener('previewSteamBtn', 'click', getSteamLibraryPreview);
            setupListener('syncSelectedGamesBtn', 'click', syncSelectedSteamGames);

            // NOVO: Listeners para Sortear Jogo
            setupListener('randomGameBtn', 'click', openRandomGameModal);
            setupListener('randomGameForm', 'submit', handleRandomGameSubmit);


            setupListener('toggleViewBtn', 'click', toggleLibraryView);
            setupListener('achievementsShortcut', 'click', openAchievementsModal);
            setupListener('gameDetailsModal', 'click', (event) => {
                if (event.target === event.currentTarget) {
                    closeGameDetailsModal();
                }
            });

            // Adiciona listeners para os novos botões de filtro
            setupListener('openAdvancedFiltersBtn-graficos', 'click', () => toggleAdvancedFiltersModal('-graficos'));
            setupListener('openAdvancedFiltersBtn-biblioteca', 'click', () => toggleAdvancedFiltersModal('-biblioteca'));
            setupListener('openAdvancedFiltersBtn-desejos', 'click', () => toggleAdvancedFiltersModal('-desejos'));


            document.querySelectorAll('.sortable-header').forEach(header => {
            header.addEventListener('click', () => {
                handleSort(header.dataset.sortKey);
            });
        });
        updateSortIcons();
            
            const setupFilterListeners = (suffix) => {
                // Filtros simples que ainda podem existir no modal
                ['nameFilter', 'statusFilter', 'styleFilter', 'yearFilter',
                 'minRating', 'maxRating', 'minMetacritic', 'maxMetacritic',
                 'minPrice', 'maxPrice', 'minHours', 'maxHours', 
                 'minWishPrice', 'maxWishPrice', 'minSteamPrice', 'maxSteamPrice',
                 'minPsnPrice', 'maxPsnPrice', 'releaseYearFilter'].forEach(id => {
                    const element = document.getElementById(id + suffix);
                    if (element) {
                        // A chamada de applyFilters agora será feita pelo botão "Aplicar Filtros" do modal
                        // Para os inputs dentro do modal, não vamos aplicar imediatamente.
                    }
                });
            };
            setupFilterListeners('-graficos');
            setupFilterListeners('-biblioteca');
            setupFilterListeners('-desejos'); // Configura listeners para filtros de desejos
            
            const gameNameInput = document.getElementById('gameName');
            if (gameNameInput) {
                gameNameInput.addEventListener('keyup', (event) => {
                    clearTimeout(searchTimeout);
                    searchTimeout = setTimeout(() => { handleSearch(event.target.value); }, 500);
                });
            }

            const wishGameNameInput = document.getElementById('wishGameName');
            if (wishGameNameInput) {
                wishGameNameInput.addEventListener('keyup', (event) => {
                    clearTimeout(wishSearchTimeout);
                    wishSearchTimeout = setTimeout(() => { handleWishSearch(event.target.value); }, 500);
                });
            }

            document.addEventListener('click', function(event) {
                const searchContainer = document.getElementById('searchResultsContainer');
                const nameInput = document.getElementById('gameName');
                if (searchContainer && !searchContainer.contains(event.target) && event.target !== nameInput) {
                    searchContainer.innerHTML = '';
                }

                const wishSearchContainer = document.getElementById('wishSearchResultsContainer');
                const wishNameInput = document.getElementById('wishGameName');
                if (wishSearchContainer && !wishSearchContainer.contains(event.target) && event.target !== wishNameInput) {
                    wishSearchContainer.innerHTML = '';
                }
            });

                function handleSort(key) {
                    if (currentSortKey === key) {
                        currentSortDirection = currentSortDirection === 'asc' ? 'desc' : 'asc';
                    } else {
                        currentSortKey = key;
                        currentSortDirection = 'asc';
    }

                    fullData.biblioteca.sort((a, b) => {
                        let valA = a[currentSortKey] || '';
                        let valB = b[currentSortKey] || '';

                        if (key === 'Nota' || key === 'Tempo de Jogo') {
                            valA = parseFloat(valA) || 0;
                            valB = parseFloat(valB) || 0;
                        }

                        if (typeof valA === 'string') valA = valA.toLowerCase();
                        if (typeof valB === 'string') valB = valB.toLowerCase();

                        if (valA < valB) {
                            return currentSortDirection === 'asc' ? -1 : 1;
        }
                        if (valA > valB) {
                            return currentSortDirection === 'asc' ? 1 : -1;
        }
                        return 0;
                    });

                    updateSortIcons();
                    applyFilters('-biblioteca');
                }

                function updateSortIcons() {
                    document.querySelectorAll('.sortable-header').forEach(header => {
                        header.classList.remove('sort-asc', 'sort-desc');
                        if (header.dataset.sortKey === currentSortKey) {
                            header.classList.add(currentSortDirection === 'asc' ? 'sort-asc' : 'sort-desc');
                        }
                    });
                }
            
            fetchGameData();
            // Inicia a busca periódica por notificações a cada 30 segundos
            notificationInterval = setInterval(fetchNotifications, 30000); 
        });
</script>
</body>
</html>
