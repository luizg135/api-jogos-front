<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Perfil Gamer</title>

    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined:opsz,wght,FILL,GRAD@20..48,100..700,0..1,-50..200" />
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

    <style>
        :root {
            --rank-bronze: #CD7F32;
            --rank-prata: #C0C0C0;
            --rank-ouro: #FFD700;
            --rank-platina: #ADD8E6;
            --rank-diamante: #00FFFF;
            --rank-mestre: #9370db;
        }

        body.dark-mode {
            --bg-color: #0d1117;
            --surface-color: #161b22;
            --primary-text: #e6edf3;
            --secondary-text: #7d8590;
            --border-color: #30363d;
            --accent-purple: #9370db;
            --accent-green: #238636;
        }

        body.light-mode {
            --bg-color: #f6f8fa;
            --surface-color: #ffffff;
            --primary-text: #24292f;
            --secondary-text: #57606a;
            --border-color: #d0d7de;
            --accent-purple: #8957e5;
            --accent-green: #2da44e;
        }

        *, *::before, *::after { box-sizing: border-box; }
        body {
            font-family: 'Inter', sans-serif; background-color: var(--bg-color);
            color: var(--primary-text); margin: 0;
            display: flex;
            height: 100vh;
            overflow: hidden;
            transition: background-color 0.3s ease, color 0.3s ease;
        }
        
        .sidebar {
            width: 80px; height: 100%; background-color: #010409;
            border-right: 1px solid var(--border-color); padding: 24px 0;
            display: flex; flex-direction: column; align-items: center;
            flex-shrink: 0; z-index: 10;
        }
        .sidebar-logo { font-size: 36px; color: var(--accent-purple); }
        .sidebar-nav {
            display: flex; flex-direction: column; align-items: center;
            gap: 16px; margin-top: 40px;
        }
        .nav-button {
            background-color: transparent; border: none; color: var(--secondary-text);
            cursor: pointer; padding: 12px; border-radius: 10px;
            display: flex; align-items: center; justify-content: center;
            width: 52px; height: 52px; transition: all 0.2s ease;
        }
        .nav-button:hover { background-color: var(--surface-color); color: var(--primary-text); }
        .nav-button.active { background-color: var(--accent-purple); color: white; }
        .nav-button .material-symbols-outlined { font-size: 28px; }
        .sidebar-footer { margin-top: auto; display: flex; flex-direction: column; gap: 16px; }

        .main-content {
            flex-grow: 1; padding: clamp(16px, 4vw, 48px);
            overflow-y: auto; height: 100%;
        }
        .page { display: none; }
        .page.active { display: block; animation: fadeIn 0.5s; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }

        .profile-header {
            background-color: var(--surface-color); border: 1px solid var(--border-color);
            padding: 32px; border-radius: 16px; margin-bottom: 32px;
            position: relative; overflow: hidden;
            transition: background-color 0.3s ease, border-color 0.3s ease;
        }
        .profile-header::before {
            content: ''; position: absolute; top: 0; left: 0; right: 0; bottom: 0;
            background-image: url('data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHdpZHRoPSI1IiBoZWlnaHQ9IjUiPgo8cmVjdCB3aWR0aD0iNSIgaGVpZ2h0PSI1IiBmaWxsPSIjMDMwYzE0Ij48L3JlY3Q+CjxwYXRoIGQ9Ik0wIDVMNSAwWk02IDRMNCA2Wk0tMSAxTDEgLTFaIiBzdHJva2U9IiMxNDE4MjEiIHNcm9rZS13aWR0aD0iMSI+PC9wYXRoPgo8L3N2Zz4=');
            opacity: 0.1; z-index: 0;
        }
        .profile-main { position: relative; z-index: 1; display: flex; align-items: center; gap: 24px; flex-wrap: wrap; }
        .profile-avatar {
            width: 64px; height: 64px; border-radius: 50%;
            border: 2px solid var(--border-color); object-fit: cover;
        }
        .profile-info { flex-grow: 1; }
        .profile-info h1 {
            font-size: 28px; font-weight: 700; margin: 0;
            transition: color 0.3s ease, text-shadow 0.3s ease;
        }
        .profile-info h1.rank-Mestre {
            color: var(--rank-mestre);
            text-shadow: 0 0 12px var(--rank-mestre);
        }
        .profile-info p { font-size: 16px; color: var(--secondary-text); margin: 4px 0 0 0; }
        .profile-level { margin-left: auto; text-align: right; min-width: 250px; }
        .level-text { font-size: 24px; font-weight: 700; }
        .exp-bar-container { width: 100%; height: 8px; background-color: var(--border-color); border-radius: 4px; overflow: hidden; margin-top: 8px; }
        .exp-bar-progress { height: 100%; border-radius: 4px; width: 0%; transition: width 0.5s ease; }
        .exp-bar-progress.rank-Mestre { 
            background-color: var(--rank-mestre);
            box-shadow: 0 0 10px var(--rank-mestre);
        }
        .exp-text { font-size: 12px; color: var(--secondary-text); margin-top: 4px; }
        
        .summary-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 16px; }
        .card {
            background-color: var(--surface-color); padding: 20px; border-radius: 12px;
            border: 1px solid var(--border-color); border-bottom: 3px solid transparent;
            transition: all 0.2s ease;
        }
        .card:hover { transform: translateY(-4px); box-shadow: 0 8px 24px rgba(0, 0, 0, 0.2); border-bottom-color: var(--rank-mestre); }
        .card-header { display: flex; align-items: center; gap: 12px; color: var(--secondary-text); font-weight: 500; font-size: 14px; }
        .card-header .material-symbols-outlined { font-size: 20px; }
        .card-content { font-size: 24px; font-weight: 700; margin-top: 8px; }

        .recent-platinums-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(140px, 1fr)); gap: 16px; margin-top: 32px; }
        .platinum-card {
            background-color: var(--surface-color); border-radius: 12px;
            border: 1px solid var(--border-color); overflow: hidden; border-bottom: 3px solid transparent;
            transition: all 0.2s ease;
        }
        .platinum-card:hover { transform: translateY(-5px); box-shadow: 0 10px 20px rgba(0,0,0,0.3); border-bottom-color: var(--rank-mestre); }
        .platinum-card img { width: 100%; height: 180px; object-fit: cover; display: block; }
        .platinum-card .game-title { padding: 12px; font-size: 14px; font-weight: 500; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; text-align: center; }

        .filter-bar { display: grid; grid-template-columns: repeat(auto-fit, minmax(180px, 1fr)); gap: 16px; margin-bottom: 32px; }
        .filter-group { display: flex; flex-direction: column; }
        .filter-group label { font-size: 12px; font-weight: 500; color: var(--secondary-text); margin-bottom: 8px; }
        .filter-group input, .filter-group select {
            width: 100%; background-color: var(--bg-color); color: var(--primary-text);
            border: 1px solid var(--border-color); padding: 10px 12px; border-radius: 8px;
            font-size: 14px;
        }
        .clear-filters-btn {
            background: transparent; color: var(--secondary-text); border: 1px solid var(--border-color);
            padding: 10px 12px; border-radius: 8px; font-size: 14px; cursor: pointer;
            display: flex; align-items: center; justify-content: center; gap: 8px;
            transition: all 0.2s ease; margin-top: auto;
        }
        .clear-filters-btn:hover { color: var(--primary-text); border-color: var(--primary-text); }
        
        .charts-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(400px, 1fr)); gap: 24px; margin-top: 32px; }
        .chart-card {
            background-color: var(--surface-color); padding: 24px; border-radius: 12px;
            border: 1px solid var(--border-color); height: 380px;
            display: flex; flex-direction: column;
        }
        .chart-card h3 {
            margin-top: 0; margin-bottom: 24px; text-align: center; font-weight: 500;
            color: var(--secondary-text); flex-shrink: 0;
        }
        .chart-wrapper { position: relative; flex-grow: 1; }

        .table-container { background-color: var(--surface-color); border: 1px solid var(--border-color); border-radius: 12px; overflow: hidden; }
        .games-table { width: 100%; border-collapse: collapse; }
        .games-table th, .games-table td { padding: 16px; text-align: left; border-bottom: 1px solid var(--border-color); white-space: nowrap; vertical-align: middle; }
        .games-table th { font-weight: 600; font-size: 12px; color: var(--secondary-text); text-transform: uppercase; }
        .games-table tbody tr:last-child td { border-bottom: none; }
        .games-table tbody tr.platinado-row { background: linear-gradient(90deg, rgba(147, 112, 219, 0.15) 0%, rgba(147, 112, 219, 0) 60%); }
        .games-table tbody tr:not(.platinado-row):hover { background-color: rgba(255, 255, 255, 0.03); }
        .game-name-cell { display: flex; align-items: center; gap: 16px; font-weight: 500; }
        .trophy-icon { color: var(--accent-purple); font-size: 22px !important; filter: drop-shadow(0 0 8px var(--accent-purple)); }
        .nota-cell { font-weight: 600; color: var(--accent-purple); }
        .no-results { text-align: center; color: var(--secondary-text); padding: 48px; }

        .wishlist-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(140px, 1fr)); gap: 16px; }
        .wish-card {
            background-color: var(--surface-color); border-radius: 12px;
            border: 1px solid var(--border-color); overflow: hidden;
            transition: all 0.2s ease;
            position: relative;
        }
        .wish-card:hover { transform: translateY(-5px); box-shadow: 0 10px 20px rgba(0,0,0,0.3); border-color: var(--accent-purple); }
        .wish-card-img { width: 100%; height: 180px; object-fit: cover; display: block; background-color: #010409; }
        .wish-card-info { padding: 12px; }
        .wish-card-title { font-weight: 500; font-size: 14px; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; margin: 0 0 8px 0; }
        .wish-card-details { display: flex; justify-content: space-between; align-items: center; font-size: 12px; }
        .wish-card-price { font-weight: 600; color: var(--accent-purple); }

        /* NOVO CSS PARA OS MODAIS */
        .modal-overlay {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background-color: rgba(0, 0, 0, 0.7);
            display: flex; align-items: center; justify-content: center;
            z-index: 1000; visibility: hidden; opacity: 0;
            transition: visibility 0.3s, opacity 0.3s;
        }
        .modal-overlay.active {
            visibility: visible; opacity: 1;
        }
        .modal-content {
            background-color: var(--surface-color); padding: 32px;
            border-radius: 16px; max-width: 450px; width: 90%;
            position: relative;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.5);
            transform: scale(0.95);
            transition: transform 0.3s ease-out;
        }
        .modal-overlay.active .modal-content {
            transform: scale(1);
        }
        .close-button {
            position: absolute; top: 16px; right: 24px; font-size: 28px;
            color: var(--secondary-text); cursor: pointer;
            transition: color 0.2s ease;
        }
        .close-button:hover { color: var(--primary-text); }
        .modal-content h2 {
            margin-top: 0; font-size: 24px; color: var(--primary-text);
            text-align: center; margin-bottom: 24px;
        }
        .form-group { margin-bottom: 16px; }
        .form-group label { font-size: 14px; font-weight: 500; color: var(--secondary-text); margin-bottom: 8px; display: block; }
        .modal-content form input, .modal-content form select {
            width: 100%; padding: 10px 12px; border: 1px solid var(--border-color);
            background-color: var(--bg-color); color: var(--primary-text);
            border-radius: 8px; font-size: 14px;
        }
        .modal-content form button {
            width: 100%; padding: 12px; background-color: var(--accent-purple);
            color: white; border: none; border-radius: 8px;
            font-size: 16px; font-weight: 600; cursor: pointer;
            margin-top: 16px;
            transition: background-color 0.2s ease;
        }
        .modal-content form button:hover { background-color: #a884e9; }
        
        /* NOVO: Estilos para os botões de ação */
        .action-buttons {
            display: flex; gap: 8px;
        }
        .action-button {
            background: transparent; border: none; padding: 4px;
            color: var(--secondary-text); cursor: pointer;
            transition: color 0.2s ease;
        }
        .action-button:hover {
            color: var(--primary-text);
        }
    </style>
</head>
<body class="dark-mode">

    <nav class="sidebar">
        <span class="material-symbols-outlined sidebar-logo">stadia_controller</span>
        <div class="sidebar-nav">
            <button class="nav-button active" onclick="openPage(event, 'perfil')" title="Perfil"><span class="material-symbols-outlined">person</span></button>
            <button class="nav-button" onclick="openPage(event, 'graficos')" title="Gráficos"><span class="material-symbols-outlined">bar_chart</span></button>
            <button class="nav-button" onclick="openPage(event, 'biblioteca')" title="Lista de Jogos"><span class="material-symbols-outlined">list_alt</span></button>
            <button class="nav-button" onclick="openPage(event, 'desejos')" title="Lista de Desejos"><span class="material-symbols-outlined">card_giftcard</span></button>
        </div>
        <div class="sidebar-footer">
            <button class="nav-button" id="theme-toggle" title="Mudar Tema"><span class="material-symbols-outlined">light_mode</span></button>
            <button class="nav-button" id="logoutBtn" title="Sair"><span class="material-symbols-outlined">logout</span></button>
        </div>
    </nav>

    <main class="main-content">
        <div id="content">
            <section id="perfil" class="page active">
                <header class="profile-header">
                    <div class="profile-main">
                        <img src="https://i.imgur.com/Z0ebi8o.png" alt="Avatar" class="profile-avatar">
                        <div class="profile-info">
                            <h1 id="gamerName">Luiz Gabriel</h1>
                            <p>Resumo da jornada!</p>
                        </div>
                        <div class="profile-level">
                            <div id="levelDisplay" class="level-text">Nível 0</div>
                            <div class="exp-bar-container"><div id="expBar" class="exp-bar-progress"></div></div>
                            <div id="expText" class="exp-text">0 / 1000 EXP</div>
                        </div>
                    </div>
                </header>
                <div id="summary" class="summary-grid"></div>
                <h2 class="section-title" style="margin-top: 40px;">ÚLTIMOS JOGOS PLATINADOS</h2>
                <div id="recent-platinums" class="recent-platinums-grid"></div>
            </section>

            <section id="graficos" class="page">
                <header class="profile-header">
                    <div class="profile-main">
                        <div class="profile-info">
                            <h1 style="color: var(--accent-purple);">Análise Gráfica</h1>
                            <p>Visão detalhada sobre seus hábitos e conquistas.</p>
                        </div>
                    </div>
                </header>
                <section class="filter-bar">
                    <div class="filter-group"><label for="nameFilter-graficos">Buscar por Nome</label><input type="search" id="nameFilter-graficos" placeholder="Ex: Elden Ring"></div>
                    <div class="filter-group"><label for="statusFilter-graficos">Status</label><select id="statusFilter-graficos"></select></div>
                    <div class="filter-group"><label for="styleFilter-graficos">Categoria</label><select id="styleFilter-graficos"></select></div>
                    <div class="filter-group"><label for="yearFilter-graficos">Ano de Conclusão</label><select id="yearFilter-graficos"></select></div>
                    <div class="filter-group"><label>&nbsp;</label><button id="clearFiltersBtn-graficos" class="clear-filters-btn"><span class="material-symbols-outlined">delete_sweep</span>Limpar</button></div>
                </section>
                <div id="summary-graficos" class="summary-grid"></div>
                <div id="charts-container" class="charts-grid">
                    <div class="chart-card"><h3>Jogos Platinados</h3><div class="chart-wrapper"><canvas id="platinadosChart"></canvas></div></div>
                    <div class="chart-card"><h3>Jogos por Plataforma</h3><div class="chart-wrapper"><canvas id="platformChart"></canvas></div></div>
                    <div class="chart-card"><h3>Jogos por Status</h3><div class="chart-wrapper"><canvas id="statusChart"></canvas></div></div>
                    <div class="chart-card"><h3>Top 5 Estilos</h3><div class="chart-wrapper"><canvas id="styleChart"></canvas></div></div>
                </div>
            </section>

            <section id="biblioteca" class="page">
                <header class="profile-header">
                    <div class="profile-main">
                        <div class="profile-info">
                            <h1 style="color: var(--accent-purple);">Biblioteca de Jogos</h1>
                            <p>Explore toda a sua coleção.</p>
                        </div>
                        <button class="nav-button" id="addGameBtn" title="Adicionar Novo Jogo"><span class="material-symbols-outlined">add</span></button>
                    </div>
                </header>
                <section class="filter-bar">
                    <div class="filter-group"><label for="nameFilter-biblioteca">Buscar por Nome</label><input type="search" id="nameFilter-biblioteca" placeholder="Ex: Elden Ring"></div>
                    <div class="filter-group"><label for="statusFilter-biblioteca">Status</label><select id="statusFilter-biblioteca"></select></div>
                    <div class="filter-group"><label for="styleFilter-biblioteca">Categoria</label><select id="styleFilter-biblioteca"></select></div>
                    <div class="filter-group"><label for="yearFilter-biblioteca">Ano de Conclusão</label><select id="yearFilter-biblioteca"></select></div>
                    <div class="filter-group"><label>&nbsp;</label><button id="clearFiltersBtn-biblioteca" class="clear-filters-btn"><span class="material-symbols-outlined">delete_sweep</span>Limpar</button></div>
                </section>
                <div class="table-container">
                    <table class="games-table">
                        <thead><tr><th>Nome</th><th>Plataforma</th><th>Status</th><th>Nota</th><th>Horas</th><th>Ações</th></tr></thead>
                        <tbody id="game-list-tbody"></tbody>
                    </table>
                </div>
                <div id="no-results-message" class="no-results" style="display: none;"><p>Nenhum jogo encontrado.</p></div>
            </section>
            
            <section id="desejos" class="page">
                <header class="profile-header">
                    <div class="profile-main">
                        <div class="profile-info">
                            <h1 style="color: var(--accent-purple);">Lista de Desejos</h1>
                            <p>Seus próximos jogos e futuras aventuras.</p>
                        </div>
                        <button class="nav-button" id="addWishBtn" title="Adicionar Jogo à Lista"><span class="material-symbols-outlined">add</span></button>
                    </div>
                </header>
                <div id="wishlist-container" class="wishlist-grid"></div>
            </section>

        </div>
    </main>
    
    <div id="addGameModal" class="modal-overlay">
        <div class="modal-content">
            <span class="close-button" onclick="closeGameModal()">&times;</span>
            <h2 id="gameModalTitle">Adicionar Novo Jogo</h2>
            <form id="addGameForm">
                <input type="hidden" id="originalGameName">
                <div class="form-group">
                    <label for="gameName">Nome do Jogo</label>
                    <input type="text" id="gameName" required>
                </div>
                <div class="form-group">
                    <label for="gamePlatform">Plataforma</label>
                    <input type="text" id="gamePlatform" placeholder="Ex: PC, PS5">
                </div>
                <div class="form-group">
                    <label for="gameStatus">Status</label>
                    <select id="gameStatus">
                        <option value="Na Fila">Na Fila</option>
                        <option value="Jogando">Jogando</option>
                        <option value="Finalizado">Finalizado</option>
                        <option value="Platinado">Platinado</option>
                        <option value="Abandonado">Abandonado</option>
                    </select>
                </div>
                <div class="form-group">
                    <label for="gameRating">Nota</label>
                    <input type="number" id="gameRating" step="0.1" min="0" max="10">
                </div>
                <div class="form-group">
                    <label for="gameHours">Horas de Jogo</label>
                    <input type="number" id="gameHours" min="0">
                </div>
                <div class="form-group">
                    <label for="gameLink">Link da Capa (URL)</label>
                    <input type="url" id="gameLink" placeholder="URL da imagem">
                </div>
                <div class="form-group">
                    <label for="gameStyle">Estilo (separado por vírgula)</label>
                    <input type="text" id="gameStyle" placeholder="Ex: RPG, Aventura">
                </div>
                <div class="form-group">
                    <label for="gamePrice">Preço (R$)</label>
                    <input type="number" id="gamePrice" step="0.01" min="0">
                </div>
                <div class="form-group">
                    <label for="gameConquistas">Conquistas Obtidas</label>
                    <input type="number" id="gameConquistas" min="0">
                </div>
                <button type="submit" id="gameModalSubmitBtn">Salvar Jogo</button>
            </form>
        </div>
    </div>
    
    <div id="addWishModal" class="modal-overlay">
        <div class="modal-content">
            <span class="close-button" onclick="closeWishModal()">&times;</span>
            <h2 id="wishModalTitle">Adicionar à Lista de Desejos</h2>
            <form id="addWishForm">
                <input type="hidden" id="originalWishName">
                <div class="form-group">
                    <label for="wishGameName">Nome do Jogo</label>
                    <input type="text" id="wishGameName" required>
                </div>
                <div class="form-group">
                    <label for="wishGameLink">Link da Capa (URL)</label>
                    <input type="url" id="wishGameLink" placeholder="URL da imagem">
                </div>
                <div class="form-group">
                    <label for="wishGameRelease">Data Lançamento / Status</label>
                    <input type="text" id="wishGameRelease" placeholder="Ex: 2025, Em Breve">
                </div>
                <div class="form-group">
                    <label for="wishGamePrice">Preço (R$)</label>
                    <input type="number" id="wishGamePrice" step="0.01" min="0">
                </div>
                <button type="submit" id="wishModalSubmitBtn">Adicionar à Lista</button>
            </form>
        </div>
    </div>

    <script>
        const API_URL = 'https://api-jogos-nrma.onrender.com/api';
        
        let fullData = {
            estatisticas: {},
            biblioteca: [],
            desejos: []
        };
        let createdCharts = {};

        // --- AUTENTICAÇÃO E CARREGAMENTO INICIAL ---
        const token = localStorage.getItem('jwt_token');
        if (!token) {
            window.location.href = 'login.html';
        }

        async function fetchGameData() {
            try {
                const response = await fetch(`${API_URL}/games/data`, {
                    headers: { 'Authorization': `Bearer ${token}` }
                });

                if (response.status === 401) {
                    localStorage.removeItem('jwt_token');
                    window.location.href = 'login.html';
                    return;
                }
                if (!response.ok) throw new Error(`HTTP error! status: ${response.status}`);

                fullData = await response.json();
                document.getElementById('loading').style.display = 'none';
                document.getElementById('content').style.display = 'block';

                renderAllPages();
            } catch (err) {
                console.error('Erro ao buscar dados:', err);
                document.getElementById('loading').style.display = 'none';
                document.getElementById('error').style.display = 'block';
            }
        }
        
        function renderAllPages() {
            renderGamerCard(fullData.estatisticas);
            renderSummaryCards(fullData.estatisticas, 'summary');
            renderRecentPlatinums(fullData.biblioteca);
            renderWishlist(fullData.desejos);
            
            populateFilters('-graficos');
            populateFilters('-biblioteca');
            
            applyFilters('-graficos');
            applyFilters('-biblioteca');
        }

        function openPage(evt, pageName) {
            document.querySelectorAll('.page').forEach(p => p.classList.remove('active'));
            document.querySelectorAll('.nav-button').forEach(b => b.classList.remove('active'));
            document.getElementById(pageName).classList.add('active');
            evt.currentTarget.classList.add('active');
        }

        function renderGamerCard(stats) {
            const mockStats = { nivel_gamer: 52, rank_gamer: "Mestre", exp_nivel_atual: 750, exp_para_proximo_nivel: 1000, total_jogos: 48, total_na_fila: 15, total_horas_jogadas: 2450, custo_total_biblioteca: 7850.50, media_notas: 8.7, total_platinados: 12, total_conquistas: 1530 };
            const effectiveStats = stats || mockStats;
            
            const rankClass = `rank-${effectiveStats.rank_gamer}`;
            const gamerName = document.getElementById('gamerName');
            const expBar = document.getElementById('expBar');
            
            document.getElementById('levelDisplay').textContent = `${effectiveStats.rank_gamer} (Nível ${effectiveStats.nivel_gamer})`;
            document.getElementById('expText').textContent = `${effectiveStats.exp_nivel_atual.toLocaleString('pt-BR')} / ${effectiveStats.exp_para_proximo_nivel.toLocaleString('pt-BR')} EXP`;
            expBar.style.width = `${(effectiveStats.exp_nivel_atual / effectiveStats.exp_para_proximo_nivel) * 100}%`;
            
            gamerName.className = '';
            expBar.className = 'exp-bar-progress';
            
            gamerName.classList.add(rankClass);
            expBar.classList.add(rankClass);
        }

        function renderSummaryCards(stats, containerId) {
            const container = document.getElementById(containerId);
            if (!container) return;
            const formatCurrency = (val) => val.toLocaleString('pt-BR', { style: 'currency', currency: 'BRL' });
            const cards = [
                { t: 'Total de Jogos', v: stats.total_jogos, i: 'sports_esports' }, { t: 'Horas Jogadas', v: `${(stats.total_horas_jogadas || 0).toLocaleString('pt-BR')}h`, i: 'timer' },
                { t: 'Custo Total', v: formatCurrency(stats.custo_total_biblioteca || 0), i: 'shopping_cart' }, { t: 'Média das Notas', v: stats.media_notas || 'N/A', i: 'star' },
                { t: 'Platinados', v: stats.total_platinados, i: 'military_tech' }, { t: 'Conquistas', v: stats.total_conquistas, i: 'emoji_events' }
            ];
            container.innerHTML = cards.map(c => `<div class="card"><div class="card-header"><span class="material-symbols-outlined">${c.i}</span><span>${c.t}</span></div><p class="card-content">${c.v}</p></div>`).join('');
        }

        function renderRecentPlatinums(library) {
            const container = document.getElementById('recent-platinums');
            if (!container) return;
            const platinados = library.filter(g => g['Platinado?'] === 'Sim' && g.Link).sort((a, b) => new Date(b['Terminado em']) - new Date(a['Terminado em'])).slice(0, 5);
            container.innerHTML = platinados.length === 0 ? `<p>Nenhum jogo platinado.</p>` : platinados.map(g => `<div class="platinum-card" title="${g.Nome}"><img src="${g.Link}" alt="${g.Nome}"><div class="game-title">${g.Nome}</div></div>`).join('');
        }

        function renderGameTable(games) {
            const tbody = document.getElementById('game-list-tbody'), noResults = document.getElementById('no-results-message'), tableContainer = document.querySelector('#biblioteca .table-container');
            if (!tbody || !noResults || !tableContainer) return;
            tbody.innerHTML = '';
            if (games.length === 0) { tableContainer.style.display = 'none'; noResults.style.display = 'block'; return; }
            tableContainer.style.display = 'block'; noResults.style.display = 'none';
            games.forEach(game => {
                const isPlatinado = game['Platinado?'] === 'Sim';
                tbody.innerHTML += `<tr class="${isPlatinado ? 'platinado-row' : ''}">
                        <td><div class="game-name-cell">${isPlatinado ? '<span class="material-symbols-outlined trophy-icon">emoji_events</span>' : '<span style="width: 22px;"></span>'}<span>${game.Nome}</span></div></td>
                        <td>${game.Plataforma || '-'}</td><td>${game.Status || '-'}</td>
                        <td class="nota-cell">${game.Nota || '-'}</td><td>${game['Tempo de Jogo'] || 0}h</td>
                        <td>
                            <div class="action-buttons">
                                <button class="action-button edit-btn" onclick="editGame('${game.Nome}')"><span class="material-symbols-outlined">edit</span></button>
                                <button class="action-button delete-btn" onclick="deleteGame('${game.Nome}')"><span class="material-symbols-outlined">delete</span></button>
                            </div>
                        </td>
                    </tr>`;
            });
        }
        
        function renderWishlist(wishlist) {
            const container = document.getElementById('wishlist-container');
            if (!container) return;
            const formatCurrency = (val) => val.toLocaleString('pt-BR', { style: 'currency', currency: 'BRL' });
            container.innerHTML = wishlist.map(game => `
                <div class="wish-card">
                    <img src="${game.Link || 'https://i.imgur.com/Z0ebi8o.png'}" class="wish-card-img" alt="${game.Nome}">
                    <div class="wish-card-info">
                        <h3 class="wish-card-title">${game.Nome}</h3>
                        <div class="wish-card-details">
                            <span>${game['Data Lançamento']}</span>
                            <span class="wish-card-price">${formatCurrency(game.Preço || 0)}</span>
                        </div>
                    </div>
                    <div style="position: absolute; top: 8px; right: 8px; display: flex; gap: 4px;">
                        <button class="action-button" onclick="editWish('${game.Nome}')" title="Editar"><span class="material-symbols-outlined" style="font-size: 18px;">edit</span></button>
                        <button class="action-button" onclick="deleteWish('${game.Nome}')" title="Excluir"><span class="material-symbols-outlined" style="font-size: 18px;">delete</span></button>
                    </div>
                </div>
            `).join('');
        }

        function destroyCharts() { Object.values(createdCharts).forEach(chart => chart.destroy()); createdCharts = {}; }
        function renderAllCharts(games) {
            destroyCharts();
            const processData = (key) => games.reduce((acc, game) => { const v = game[key] || 'N/A'; acc[v] = (acc[v] || 0) + 1; return acc; }, {});
            const processMultiData = (key) => games.reduce((acc, game) => { if(game[key]) game[key].split(',').forEach(item => { const t = item.trim(); acc[t] = (acc[t] || 0) + 1; }); return acc; }, {});
            const platinadosData = { 'Platinados': games.filter(g => g['Platinado?'] === 'Sim').length, 'Não': games.filter(g => g['Platinado?'] !== 'Sim').length };
            const styleData = Object.entries(processMultiData('Estilo')).sort(([,a],[,b]) => b-a).slice(0,5).reduce((r, [k,v]) => ({...r, [k]: v}), {});
            if(document.getElementById('platinadosChart')) createdCharts.platinados = new Chart('platinadosChart', { type: 'pie', data: { labels: Object.keys(platinadosData), datasets: [{ data: Object.values(platinadosData), backgroundColor: [chartColors.purple, chartColors.grey], borderColor: '#161b22', borderWidth: 4 }] }, options: { responsive: true, maintainAspectRatio: false, plugins: { legend: { position: 'top' }}} });
            if(document.getElementById('platformChart')) createdCharts.platform = new Chart('platformChart', { type: 'bar', data: { labels: Object.keys(processData('Plataforma')), datasets: [{ data: Object.values(processData('Plataforma')), backgroundColor: chartColors.purple, borderRadius: 4 }] }, options: { responsive: true, maintainAspectRatio: false, scales: { y: { beginAtZero: true, ticks: { stepSize: 1 }}}, plugins: { legend: { display: false }}} });
            if(document.getElementById('statusChart')) createdCharts.status = new Chart('statusChart', { type: 'doughnut', data: { labels: Object.keys(processData('Status')), datasets: [{ data: Object.values(processData('Status')), backgroundColor: [chartColors.purple, chartColors.lightBlue, chartColors.cyan, chartColors.grey], borderColor: '#161b22', borderWidth: 4 }] }, options: { responsive: true, maintainAspectRatio: false, plugins: { legend: { position: 'top' }}} });
            if(document.getElementById('styleChart')) createdCharts.style = new Chart('styleChart', { type: 'bar', data: { labels: Object.keys(styleData), datasets: [{ data: Object.values(styleData), backgroundColor: chartColors.lightBlue, borderRadius: 4 }] }, options: { indexAxis: 'y', responsive: true, maintainAspectRatio: false, plugins: { legend: { display: false }}} });
        }

        function populateFilters(suffix) {
            const statuses = new Set(), styles = new Set(), years = new Set();
            fullData.biblioteca.forEach(game => {
                if (game.Status) statuses.add(game.Status);
                if (game.Estilo) game.Estilo.split(',').forEach(s => styles.add(s.trim()));
                if (game['Terminado em']) years.add(new Date(game['Terminado em']).getFullYear());
            });
            const populate = (elId, items, asc = false) => {
                const select = document.getElementById(elId);
                if (!select) return;
                select.innerHTML = '<option value="all">Todos</option>';
                const sorted = asc ? [...items].sort() : [...items].sort((a,b) => b-a);
                sorted.forEach(item => select.innerHTML += `<option value="${item}">${item}</option>`);
            }
            populate('statusFilter' + suffix, statuses, true);
            populate('styleFilter' + suffix, styles, true);
            populate('yearFilter' + suffix, years);
        }

        function applyFilters(suffix) {
            const name = document.getElementById('nameFilter' + suffix).value.toLowerCase();
            const status = document.getElementById('statusFilter' + suffix).value;
            const style = document.getElementById('styleFilter' + suffix).value;
            const year = document.getElementById('yearFilter' + suffix).value;
            
            const filteredGames = fullData.biblioteca.filter(g => (name ? g.Nome.toLowerCase().includes(name) : true) && (status !== 'all' ? g.Status === status : true) && (style !== 'all' ? (g.Estilo && g.Estilo.split(',').map(s=>s.trim()).includes(style)) : true) && (year !== 'all' ? (g['Terminado em'] && new Date(g['Terminado em']).getFullYear() == year) : true));
            const notas = filteredGames.map(g => g.Nota).filter(n => n);
            const stats = {
                total_jogos: filteredGames.length, total_horas_jogadas: filteredGames.reduce((sum, g) => sum + (g['Tempo de Jogo'] || 0), 0),
                custo_total_biblioteca: filteredGames.reduce((sum, g) => sum + (g.Preço || 0), 0),
                media_notas: notas.length > 0 ? (notas.reduce((a,b) => a+b, 0) / notas.length).toFixed(1) : 0,
                total_platinados: filteredGames.filter(g => g['Platinado?'] === 'Sim').length, total_conquistas: 0
            };
            
            if (suffix === '-graficos') {
                renderSummaryCards(stats, 'summary-graficos');
                renderAllCharts(filteredGames);
            } else if (suffix === '-biblioteca') {
                renderGameTable(filteredGames);
            }
        }

        function openGameModal() {
            document.getElementById('gameModalTitle').textContent = 'Adicionar Novo Jogo';
            document.getElementById('gameModalSubmitBtn').textContent = 'Salvar Jogo';
            document.getElementById('addGameForm').reset();
            document.getElementById('addGameModal').classList.add('active');
        }
        function closeGameModal() {
            document.getElementById('addGameModal').classList.remove('active');
            document.getElementById('addGameForm').reset();
        }
        async function handleNewGameSubmission(event) {
            event.preventDefault();
            const newGameData = {
                Nome: document.getElementById('gameName').value,
                Plataforma: document.getElementById('gamePlatform').value,
                Status: document.getElementById('gameStatus').value,
                Nota: parseFloat(document.getElementById('gameRating').value) || null,
                "Tempo de Jogo": parseInt(document.getElementById('gameHours').value) || 0,
                Link: document.getElementById('gameLink').value,
                Estilo: document.getElementById('gameStyle').value,
                "Platinado?": document.getElementById('gameStatus').value === 'Platinado' ? 'Sim' : 'Não',
                Preço: parseFloat(document.getElementById('gamePrice').value) || 0,
                "Conquistas Obtidas": parseInt(document.getElementById('gameConquistas').value) || 0,
            };
            
            const response = await fetch(`${API_URL}/games/add`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json', 'Authorization': `Bearer ${token}` },
                body: JSON.stringify({ list_type: 'games', item_data: newGameData })
            });

            if (response.ok) {
                alert("Jogo adicionado com sucesso!");
                closeGameModal();
                fetchGameData();
            } else {
                alert("Erro ao adicionar jogo. Tente novamente.");
            }
        }
        
        function openWishModal() {
            document.getElementById('wishModalTitle').textContent = 'Adicionar à Lista de Desejos';
            document.getElementById('wishModalSubmitBtn').textContent = 'Adicionar à Lista';
            document.getElementById('addWishForm').reset();
            document.getElementById('addWishModal').classList.add('active');
        }
        function closeWishModal() {
            document.getElementById('addWishModal').classList.remove('active');
            document.getElementById('addWishForm').reset();
        }
        async function handleNewWishlistItemSubmission(event) {
            event.preventDefault();
            const newWishItem = {
                Nome: document.getElementById('wishGameName').value,
                Link: document.getElementById('wishGameLink').value,
                "Data Lançamento": document.getElementById('wishGameRelease').value,
                Preço: parseFloat(document.getElementById('wishGamePrice').value) || 0
            };
            
            const response = await fetch(`${API_URL}/games/add`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json', 'Authorization': `Bearer ${token}` },
                body: JSON.stringify({ list_type: 'wishlist', item_data: newWishItem })
            });

            if (response.ok) {
                alert("Item adicionado à lista de desejos!");
                closeWishModal();
                fetchGameData();
            } else {
                alert("Erro ao adicionar à lista de desejos. Tente novamente.");
            }
        }

        async function editGame(gameName) {
            const gameToEdit = fullData.biblioteca.find(g => g.Nome === gameName);
            if (!gameToEdit) {
                alert("Jogo não encontrado.");
                return;
            }
            
            document.getElementById('gameModalTitle').textContent = `Editar ${gameToEdit.Nome}`;
            document.getElementById('gameModalSubmitBtn').textContent = 'Atualizar Jogo';
            document.getElementById('originalGameName').value = gameName;
            document.getElementById('gameName').value = gameToEdit.Nome;
            document.getElementById('gamePlatform').value = gameToEdit.Plataforma || '';
            document.getElementById('gameStatus').value = gameToEdit.Status || 'Na Fila';
            document.getElementById('gameRating').value = gameToEdit.Nota || '';
            document.getElementById('gameHours').value = gameToEdit['Tempo de Jogo'] || '';
            document.getElementById('gameLink').value = gameToEdit.Link || '';
            document.getElementById('gameStyle').value = gameToEdit.Estilo || '';
            document.getElementById('gamePrice').value = gameToEdit.Preço || '';
            document.getElementById('gameConquistas').value = gameToEdit['Conquistas Obtidas'] || '';

            document.getElementById('addGameModal').classList.add('active');

            document.getElementById('addGameForm').onsubmit = async (event) => {
                event.preventDefault();
                const updatedGameData = {
                    Nome: document.getElementById('gameName').value,
                    Plataforma: document.getElementById('gamePlatform').value,
                    Status: document.getElementById('gameStatus').value,
                    Nota: parseFloat(document.getElementById('gameRating').value) || null,
                    "Tempo de Jogo": parseInt(document.getElementById('gameHours').value) || 0,
                    Link: document.getElementById('gameLink').value,
                    Estilo: document.getElementById('gameStyle').value,
                    "Platinado?": document.getElementById('gameStatus').value === 'Platinado' ? 'Sim' : 'Não',
                    Preço: parseFloat(document.getElementById('gamePrice').value) || 0,
                    "Conquistas Obtidas": parseInt(document.getElementById('gameConquistas').value) || 0,
                };
                
                const response = await fetch(`${API_URL}/games/edit`, {
                    method: 'PUT',
                    headers: { 'Content-Type': 'application/json', 'Authorization': `Bearer ${token}` },
                    body: JSON.stringify({ list_type: 'games', item_name: document.getElementById('originalGameName').value, updated_data: updatedGameData })
                });

                if (response.ok) {
                    alert("Jogo atualizado com sucesso!");
                    closeGameModal();
                    fetchGameData();
                } else {
                    alert("Erro ao atualizar jogo. Tente novamente.");
                }
            };
        }
        
        async function deleteGame(gameName) {
            if (confirm(`Tem certeza que deseja excluir o jogo "${gameName}" da sua biblioteca?`)) {
                const response = await fetch(`${API_URL}/games/delete/games/${gameName}`, {
                    method: 'DELETE',
                    headers: { 'Authorization': `Bearer ${token}` }
                });

                if (response.ok) {
                    alert("Jogo deletado com sucesso!");
                    fetchGameData();
                } else {
                    alert("Erro ao deletar jogo. Tente novamente.");
                }
            }
        }
        
        async function editWish(wishName) {
            const wishToEdit = fullData.desejos.find(w => w.Nome === wishName);
            if (!wishToEdit) {
                alert("Item da lista de desejos não encontrado.");
                return;
            }
            
            document.getElementById('wishModalTitle').textContent = `Editar ${wishToEdit.Nome}`;
            document.getElementById('wishModalSubmitBtn').textContent = 'Atualizar Item';
            document.getElementById('originalWishName').value = wishName;
            document.getElementById('wishGameName').value = wishToEdit.Nome;
            document.getElementById('wishGameLink').value = wishToEdit.Link || '';
            document.getElementById('wishGameRelease').value = wishToEdit["Data Lançamento"] || '';
            document.getElementById('wishGamePrice').value = wishToEdit.Preço || '';

            document.getElementById('addWishModal').classList.add('active');

            document.getElementById('addWishForm').onsubmit = async (event) => {
                event.preventDefault();
                const updatedWishData = {
                    Nome: document.getElementById('wishGameName').value,
                    Link: document.getElementById('wishGameLink').value,
                    "Data Lançamento": document.getElementById('wishGameRelease').value,
                    Preço: parseFloat(document.getElementById('wishGamePrice').value) || 0
                };
                
                const response = await fetch(`${API_URL}/games/edit`, {
                    method: 'PUT',
                    headers: { 'Content-Type': 'application/json', 'Authorization': `Bearer ${token}` },
                    body: JSON.stringify({ list_type: 'wishlist', item_name: document.getElementById('originalWishName').value, updated_data: updatedWishData })
                });

                if (response.ok) {
                    alert("Item de desejo atualizado com sucesso!");
                    closeWishModal();
                    fetchGameData();
                } else {
                    alert("Erro ao atualizar item de desejo. Tente novamente.");
                }
            };
        }
        
        async function deleteWish(wishName) {
            if (confirm(`Tem certeza que deseja excluir "${wishName}" da sua lista de desejos?`)) {
                const response = await fetch(`${API_URL}/games/delete/wishlist/${wishName}`, {
                    method: 'DELETE',
                    headers: { 'Authorization': `Bearer ${token}` }
                });

                if (response.ok) {
                    alert("Item de desejo deletado com sucesso!");
                    fetchGameData();
                } else {
                    alert("Erro ao deletar item de desejo. Tente novamente.");
                }
            }
        }

        document.addEventListener('DOMContentLoaded', () => {
            fetchGameData();

            const setupFilterListeners = (suffix) => {
                const clearBtn = document.getElementById('clearFiltersBtn' + suffix);
                const filterIds = ['nameFilter', 'statusFilter', 'styleFilter', 'yearFilter'];
                
                filterIds.forEach(id => {
                    const el = document.getElementById(id + suffix);
                    if (el) el.addEventListener('input', () => applyFilters(suffix));
                });
                
                if (clearBtn) {
                    clearBtn.addEventListener('click', () => {
                        filterIds.forEach(id => {
                            const el = document.getElementById(id + suffix);
                            if(el) el.value = el.tagName === 'SELECT' ? 'all' : '';
                        });
                        applyFilters(suffix);
                    });
                }
            };
            
            setupFilterListeners('-graficos');
            setupFilterListeners('-biblioteca');

            const themeToggle = document.getElementById('theme-toggle');
            themeToggle.addEventListener('click', () => {
                const body = document.body;
                const icon = themeToggle.querySelector('.material-symbols-outlined');
                body.classList.toggle('light-mode');
                body.classList.toggle('dark-mode');
                
                if (body.classList.contains('light-mode')) {
                    icon.textContent = 'dark_mode';
                } else {
                    icon.textContent = 'light_mode';
                }
            });

            const addGameBtn = document.getElementById('addGameBtn');
            const addGameForm = document.getElementById('addGameForm');
            const addWishBtn = document.getElementById('addWishBtn');
            const addWishForm = document.getElementById('addWishForm');

            if (addGameBtn) addGameBtn.addEventListener('click', openGameModal);
            if (addGameForm) addGameForm.addEventListener('submit', handleNewGameSubmission);
            
            if(addWishBtn) addWishBtn.addEventListener('click', openWishModal);
            if(addWishForm) addWishForm.addEventListener('submit', handleNewWishlistItemSubmission);
        });
    </script>
</body>
</html>
